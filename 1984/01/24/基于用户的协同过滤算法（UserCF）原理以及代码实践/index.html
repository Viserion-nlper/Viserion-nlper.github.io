<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        基于用户的协同过滤算法（UserCF）原理以及代码实践 | 思想放牧之地
      
    </title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/apple-touch-icon.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/favicon-32x32.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/favicon-16x16.png" />
    
    
      <link rel="mask-icon"
            href="/images/logo.svg"
            color="" />
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/normal.ttf);
        font-weight: normal;
    }
  </style>

  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/bold.ttf);
        font-weight: bold;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css' />
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  

  <meta name="generator" content="Hexo 7.3.0"></head>
  <body>
    
      <div id="search-mask" style="display:none">
  <div class="search-main" id="search-main">
    <div class="search__head">
      <div class="search-form">
        <svg t="1706347533072"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="7828"
             width="20"
             height="20">
          <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
          </path>
        </svg>
        <input id="search-input" placeholder="搜索文章">
        <svg t="1706361500528"
             id="search-clear"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="4351"
             width="20"
             height="20">
          <path d="M512 562.688l-264.2944 264.2944-50.688-50.688L461.312 512 197.0176 247.7056l50.688-50.688L512 461.312l264.2944-264.2944 50.688 50.688L562.688 512l264.2944 264.2944-50.688 50.688L512 562.688z" fill="#00" p-id="4352">
          </path>
        </svg>
      </div>
    </div>
    <div class="search__body" id="search-result"></div>
    <div class="search__foot"></div>
  </div>
</div>

    
    
    <div class=head>
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/logo.svg" />
        </a>
        <input id="navBtn" type="checkbox" />
        <div class="nav-right">
          
            <div class="search-outer">
  <div class="search" id="search-btn">
    <svg t="1706347533072"
         class="icon"
         viewBox="0 0 1024 1024"
         version="1.1"
         xmlns="http://www.w3.org/2000/svg"
         p-id="7828"
         width="20"
         height="20">
      <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
      </path>
    </svg>
    <span>搜索</span>
    <span class="search-shortcut-key">Ctrl K</span>
  </div>
</div>

          
          <div class="nav-menu">
            
              
                <a class="nav-menu-item" href="/AI">AI大模型</a>
              
                <a class="nav-menu-item" href="/photograph">拍摄摄影</a>
              
                <a class="nav-menu-item" href="/live">生活随记</a>
              
            
            <a class="nav-menu-item" href='/cv/'>简历</a>
          </div>
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner">
      <div class="post-content__head">
        <div class="post-title">基于用户的协同过滤算法（UserCF）原理以及代码实践</div>
        <div class="post-info">
          
  <a href="/tags/UserCF/" class="post-tag">#UserCF</a>


          <span class="post-date">1984-01-24</span>
        </div>
      </div>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <h1 id="推荐系统文档">推荐系统文档</h1>
<h2
id="基于用户的协同过滤算法usercf原理以及代码实践">1、基于用户的协同过滤算法（UserCF）原理以及代码实践</h2>
<blockquote>
<p>链接：https://www.jianshu.com/p/7c5d9c008be9</p>
</blockquote>
<h2 id="简介">简介</h2>
<p>协同过滤（collaborative
filtering）是一种在推荐系统中广泛使用的技术。该技术通过分析用户或者事物之间的相似性，来预测用户可能感兴趣的内容并将此内容推荐给用户。这里的相似性可以是人口特征的相似性，也可以是历史浏览内容的相似性，还可以是个人通过一定机制给与某个事物的回应。比如，A和B是无话不谈的好朋友，并且都喜欢看电影，那么协同过滤会认为A和B的相似度很高，会将A喜欢但是B没有关注的电影推荐给B，反之亦然。</p>
<p>协同过滤推荐分为3种类型：</p>
<ul>
<li><strong>基于用户(user-based)的协同过滤(UserCF)</strong></li>
<li>基于物品(item-based)的协同过滤（ItemCF算法)</li>
<li>基于模型(model-based)的协同过滤 (ModelCF算法)</li>
</ul>
<p>本文主要讲述基于用户协同过滤算法的原理以及代码实现。</p>
<hr />
<h2 id="算法原理">算法原理</h2>
<p>UserCF算法主要是考虑用户与用户之间的相似度，给用户推荐和他兴趣相似的其他用户喜欢的物品。俗话说"物以群分，人以类聚"，人们总是倾向于跟自己志同道合的人交朋友。同理，你朋友喜欢的东西你大概率也可能会喜欢，UserCF算法正是利用了这个原理。举个例子，如果要给一个用户A推荐物品，可以先找到与A最为相似的用户B，接着获取用户B最喜欢的且用户A没有听说过的物品，并预测用户A对这些物品的评分，从中选取评分最高的若干个物品推荐给用户A。</p>
<p>从上述描述可以知道，UserCF算法的主要步骤如下：</p>
<ol type="1">
<li>找到与目标用户兴趣相似的用户集合</li>
<li>找到这个集合中的用户最喜欢的，且目标用户还未接触过的物品推荐给目标用户</li>
</ol>
<p>上述是UserCF算法的基本思路，方便读者形成对UserCF算法的整体印象。也许你看了上述文字依然没有思路，没关系，且继续往下看。</p>
<p>首先，根据算法的步骤1，我们自然而然就会提出一个问题，那就是如何度量两个用户之间的相似度？试想一下，我们在现实生活中如何判断两个人是否兴趣相似呢？比如你喜欢打LOL，恰巧你室友也喜欢，那显然你们的共同话题会比较多，因为你们有共同的兴趣爱好。我们刚好可以利用这一点来计算用户之间的相似度。</p>
<p>对于用户u和用户v，令N(u)代表用户u喜欢的物品合集，令N(v)代表用户v喜欢的物品合集。N(u)∩N(v)代表的是用户u和用户v都喜欢的物品，N(u)∪N(v)代表的是用户u和用户v喜欢的物品的合集，那么可以利用以下公式来简单计算相似度:</p>
<figure>
<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvfinphsj206h02g744.jpg"
alt="image-20220607184729577" />
<figcaption aria-hidden="true">image-20220607184729577</figcaption>
</figure>
<p>上述公式叫做Jaccard公式，直观上理解就是，将用户u与用户v都喜欢的物品的数量除以他们喜欢物品的总和，如果u和v喜欢的物品是一模一样的，则u和v的相似度为1。</p>
<p>还有另外一种余弦相似度计算公式:</p>
<figure>
<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvfvghe1j206902n744.jpg"
alt="image-20220607184750666" />
<figcaption aria-hidden="true">image-20220607184750666</figcaption>
</figure>
<p>上述公式的分母部分代表的是u喜欢的物品的数量与v喜欢的物品的数量的乘积，而不再是他们之间的交集。</p>
<p>举个简单例子来表明如何计算用户u和v之间的相似度，假如用户u和用户v喜欢的游戏如下表：</p>
<table>
<thead>
<tr>
<th>用户</th>
<th>喜爱的游戏</th>
</tr>
</thead>
<tbody>
<tr>
<td>u</td>
<td>{英雄联盟, 王者荣耀，绝地求生}</td>
</tr>
<tr>
<td>v</td>
<td>{英雄联盟，和平精英}</td>
</tr>
</tbody>
</table>
<p>利用余弦相似度计算公式可以得到如下结果：</p>
<figure>
<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvg8rkjfj20h302pq32.jpg"
alt="image-20220607184812653" />
<figcaption aria-hidden="true">image-20220607184812653</figcaption>
</figure>
<p>故，我们可以计算得到用户u和用户v之间的相似度为：</p>
<figure>
<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvghyxulj201401l0o6.jpg"
alt="image-20220607184827258" />
<figcaption aria-hidden="true">image-20220607184827258</figcaption>
</figure>
<p>至此，我们已经可以计算任意两个用户之间的相似度了，下一步要做的事情是建立一张用户相似度表，此表中保存了任意两个用户之间的相似度，方便后续挑选出与用户u最相似的若干个用户。</p>
<p>当用户相似度表建立起来了之后，UserCF算法就可以给用户推荐与他兴趣最相似的K个用户喜欢的物品了。那此时又会出现一个问题，假如我们要给用户w进行推荐，并且在用户相似度表中找到了与他最相似的K个用户，这K个用户喜欢的物品有很多，我们怎么知道要推荐哪些物品给用户w呢？此时就涉及到了用户对物品的感兴趣程度，我们当然会把用户最感兴趣的物品推荐给他。故使用以下公式来度量用户u对物品i的感兴趣程度：</p>
<figure>
<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvgs99ntj207w02amwz.jpg"
alt="image-20220607184843946" />
<figcaption aria-hidden="true">image-20220607184843946</figcaption>
</figure>
<p>乍一看感觉很复杂，其实不然。 其中<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvhqfvojj201u00p3y9.jpg"
alt="image-20220607184933500" /> 代表的是与用户<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvin6zanj200f00j0d0.jpg"
alt="image-20220607185031080" />最相似的K个用户，将与用户<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zviun6lrj200f00j0d0.jpg"
alt="image-20220607185043332" />相似的用户列表按照相似度进行排序就可以得到。<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvj7d3lzj201700t0oa.jpg"
alt="image-20220607185102551" />代表的是对喜欢物品i的用户集合，<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvjj17zij201d00s0mt.jpg"
alt="image-20220607185121848" />代表的是用户<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvin6zanj200f00j0d0.jpg"
alt="image-20220607185031080" />和用户<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvkb86m2j200i00k0by.jpg"
alt="image-20220607185209749" />之间的相似度，这个也可以直接从用户相似度表中得到。<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvkkid5jj201000p0k5.jpg"
alt="image-20220607185224784" />代表用户v对物品i的兴趣，因为使用的是单一行为的隐反馈数据，所以所有的<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvkueka8j201y00o0q4.jpg"
alt="image-20220607185240033" />。</p>
<p>对于与用户<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvluu9tyj200f00j0d0.jpg"
alt="image-20220607185031080" />最相似的K个用户，我们分别计算用户<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvin6zanj200f00j0d0.jpg"
alt="image-20220607185031080" />与这K个用户喜欢的物品集合<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvljkeavj204u00vq2p.jpg"
alt="image-20220607185318344" />之间的感兴趣程度，得到用户<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvin6zanj200f00j0d0.jpg"
alt="image-20220607185031080" />对这N个物品的感兴趣程度列表，然后将其逆序排序，取前m个物品推荐给用户<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zvin6zanj200f00j0d0.jpg"
alt="image-20220607185031080" />，至此UserCF算法结束。</p>
<hr />
<h2 id="算法工作流程">算法工作流程</h2>
<p>接下来，我们用一个简单例子演示一下UserCF的具体工作流程。
下表是我们臆造的原始数据，也称之为User-Item表，即用户-物品列表，记录了每个用户喜爱的物品，数据表格如下：</p>
<table>
<thead>
<tr>
<th>用户</th>
<th>喜爱的物品</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>{a,b,d}</td>
</tr>
<tr>
<td>B</td>
<td>{a,c,d}</td>
</tr>
<tr>
<td>C</td>
<td>{b,e}</td>
</tr>
<tr>
<td>D</td>
<td>{c,d,e}</td>
</tr>
</tbody>
</table>
<p>接下来我们需要计算用户相似度矩阵，最直观的方法就是，对于用户列表{A,B,C,D},我们对其中两两用户都使用余弦相似度算法计算相似度。这种算法的时间复杂度是O(N^2)，当用户量很大的时候，计算非常耗时,在实际运用中不可取。观察一下相似度计算公式会发现，其实如果用户<img
src="https://math.jianshu.com/math?formula=%5Cmu" alt="" />和用户<img
src="https://math.jianshu.com/math?formula=%5Cnu"
alt="" />没有共同喜欢的物品（比如表中的用户B和用户C），那么他们之间的相似度为0，也就没有必要计算了。
也就是说我们没必要对任意两个用户之间都计算相似度，我们只需要计算那些彼此之间有共同喜爱物品的用户之间的相似度，故首先可以想到建立倒排表，即Item-User表，具体如下：</p>
<table>
<thead>
<tr>
<th>物品</th>
<th>喜爱它的用户</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>{A,B}</td>
</tr>
<tr>
<td>b</td>
<td>{A,C}</td>
</tr>
<tr>
<td>c</td>
<td>{B,D}</td>
</tr>
<tr>
<td>d</td>
<td>{A,B,D}</td>
</tr>
<tr>
<td>e</td>
<td>{C,D}</td>
</tr>
</tbody>
</table>
<p>有了这张表之后，相当于我们将原先零散的用户按照他们喜爱的物品给划分成若干个小圈子。比如用户A、B由于都喜欢物品a，所以被分到了一起。同理，用户C、D都喜欢物品e，因此也被分到了一起。
那这么做的目的是什么呢？回顾一下上面说的用户相似度计算方法，可以看到无论是哪一种方法都要先求出|N(<img
src="https://math.jianshu.com/math?formula=%5Cmu" alt="" />)∩N(<img
src="https://math.jianshu.com/math?formula=%5Cnu"
alt="" />)|，所以我们的目的就是为了快速地求出任意用户之间的交集。
由此可以建立下面的用户喜爱物品交集矩阵W：</p>
<table>
<thead>
<tr>
<th></th>
<th>A</th>
<th>B</th>
<th>C</th>
<th>D</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>B</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>2</td>
</tr>
<tr>
<td>C</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>D</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>其中W[u][v]代表的含义是用户u和用户v都喜爱的物品个数，即<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zkpewkkfj202s00pa9t.jpg"
alt="image-20220607123616571" />。比如用户A、C都喜欢物品b，所以W[A][C]=1。用户A、B除了喜欢物品a以外，还共同喜欢物品d，因此W[A][B]=2。
由于用户A、B之间的交集和用户B、A之间的交集是一样的，所以此矩阵是一个对称矩阵。
其实这里的W就是相似度计算公式中的分子部分，而每个用户的喜爱列表从之前的User-Item列表中就已经可以得到了，因此我们就可以计算出用户相似度矩阵了，结果如下：</p>
<table>
<thead>
<tr>
<th></th>
<th>A</th>
<th>B</th>
<th>C</th>
<th>D</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>0</td>
<td>0.67</td>
<td>0.41</td>
<td>0.33</td>
</tr>
<tr>
<td>B</td>
<td>0.67</td>
<td>0</td>
<td>0</td>
<td>0.67</td>
</tr>
<tr>
<td>C</td>
<td>0.41</td>
<td>0</td>
<td>0</td>
<td>0.41</td>
</tr>
<tr>
<td>D</td>
<td>0.33</td>
<td>0.67</td>
<td>0.41</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>当用户相似度矩阵建立好了之后，我们就可以对用户进行物品推荐了。
比如要对用户C进行物品推荐，通过查表可以知道（上表第四行），用户A和用户D是比较相似的两个用户。
再通过User-Item表查询到用户A喜欢的物品列表{a,b,d}，用户D喜欢的物品列表{c,d,e}，
故用户A、D喜欢物品的交集是{a,b,c,d,e}，其中用户C喜欢的列表是{b,e}，为了避免重复推荐用户已经喜欢的物品，所以要先从物品列表中去掉用户C已经喜欢的物品，故最终待推荐的物品列表为{a,c,d}。
此时我们来计算用户C对待推荐物品列表中物品的感兴趣程度：</p>
<p>p(C,a) = W [C] [A]= 0.41</p>
<p>p(C,c) = W [C] [D] = 0.41 p(C,d) = W [C] [A] + W [C] [D] = 0.82</p>
<p>接着按照用户C对待推荐物品感兴趣程度对待推荐列表进行逆序排序，得到最终的推荐列表{d,a,c}，我们可以将整个推荐列表或者取前K个物品推荐给用户C。
至此，UserCF算法整体流程结束。
可以看到，算法的输出的最应该推荐给用户C的物品是d，我们不难发现这是因为与用户C最相似的用户A和用户D都喜欢物品d，因此将d推荐给C是比较合理的选择。</p>
<h3 id="相似度算法改进">相似度算法改进</h3>
<p>上述算法使用的是余弦相似度计算公式，但是这个公式过于粗糙，原因是余弦相似度只是简单地计算了用户u和用户v共同喜欢的物品在他们总共喜欢物品中占据的比例。
比如，两个用户都购买了时下热门物品，这并不能说明他们兴趣相似，因为热门物品是绝大多数人都会买的东西。换句话说，两个用户对冷门物品采用过相同的行为更能说明他们兴趣的相似度。因此John.S.Breese提出了以下相似度计算公式：</p>
<figure>
<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zkq425uzj208002jglh.jpg"
alt="image-20220607123704284" />
<figcaption aria-hidden="true">image-20220607123704284</figcaption>
</figure>
<p>相比余弦相似度公式，这里的分子<img
src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2zkqkrpsaj203p01mwe9.jpg"
alt="image-20220607123729289" />惩罚了用户u和用户v共同喜欢的热门物品对他们相似度的影响。
在下一节的代码实践中，分别实现了基于这两种相似度计算的UserCF算法。</p>
<hr />
<h2 id="代码实践">代码实践</h2>
<p>上一节是基于一个非常简易的测试数据集，接下来我们将UserCF算法运用在推荐系统经典数据集MovieLens上。
MovieLens数据集介绍以及数据处理参见<a
target="_blank" rel="noopener" href="https://www.jianshu.com/p/a59ff0dc22a3">链接</a>。</p>
<p>根据之前的介绍，可知整个算法流程分为两个阶段：</p>
<ul>
<li>训练阶段</li>
<li>推荐阶段</li>
</ul>
<p>对于训练阶段，可分为以下几步：</p>
<ol type="1">
<li>数据预处理，建立User-Item表</li>
<li>建立Item-User倒排表</li>
<li>建立用户物品交集矩阵</li>
<li>建立用户相似度矩阵</li>
</ol>
<p>对于推荐阶段，可分为以下几步：</p>
<ol type="1">
<li>寻找与被推荐用户最相似的K个用户</li>
<li>计算用户对物品的感兴趣列表并逆序排列</li>
</ol>
<h3 id="训练阶段">训练阶段</h3>
<h4 id="数据预处理建立user-item表">数据预处理，建立User-Item表</h4>
<p>我们采用MovieLens数据集中的ratings.dat文件，因为这里面包含了用户对电影的评分数据，注意我们忽略掉评分那一栏，将其简化成用户喜欢或者不喜欢。只要用户有参与过评分的电影，无论分值如何，我们都认为这部电影是用户喜欢的。</p>
<p><strong>注意，ratings.dat里面包含了100多万条评价数据，为了减少训练时间，可以只读取部分数据，本文读取了前29415条数据，即前200个用户的评价数据。ratings.dat原始数据每行包含了4列，本文中只取了’UserID‘、’MovieID‘这两列，关于此数据集的详细介绍请参见<a
target="_blank" rel="noopener" href="https://www.jianshu.com/p/a59ff0dc22a3">链接</a>。</strong></p>
<p>接下来使用以下代码来读取数据并建立User-Item表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LoadMovieLensData</span>(<span class="params">filepath, train_rate</span>):</span><br><span class="line">    ratings = pd.read_table(filepath, sep=<span class="string">&quot;::&quot;</span>, header=<span class="literal">None</span>, names=[<span class="string">&quot;UserID&quot;</span>, <span class="string">&quot;MovieID&quot;</span>, <span class="string">&quot;Rating&quot;</span>, <span class="string">&quot;TimeStamp&quot;</span>],\</span><br><span class="line">                            engine=<span class="string">&#x27;python&#x27;</span>)</span><br><span class="line">    ratings = ratings[[<span class="string">&#x27;UserID&#x27;</span>,<span class="string">&#x27;MovieID&#x27;</span>]]</span><br><span class="line">    train = []</span><br><span class="line">    test = []</span><br><span class="line">    random.seed(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">for</span> idx, row <span class="keyword">in</span> ratings.iterrows():</span><br><span class="line">        user = <span class="built_in">int</span>(row[<span class="string">&#x27;UserID&#x27;</span>])</span><br><span class="line">        item = <span class="built_in">int</span>(row[<span class="string">&#x27;MovieID&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; train_rate:</span><br><span class="line">            train.append([user, item])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            test.append([user, item])</span><br><span class="line">    <span class="keyword">return</span> PreProcessData(train), PreProcessData(test)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PreProcessData</span>(<span class="params">originData</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    建立User-Item表，结构如下：</span></span><br><span class="line"><span class="string">        &#123;&quot;User1&quot;: &#123;MovieID1, MoveID2, MoveID3,...&#125;</span></span><br><span class="line"><span class="string">         &quot;User2&quot;: &#123;MovieID12, MoveID5, MoveID8,...&#125;</span></span><br><span class="line"><span class="string">         ...</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    trainData = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">for</span> user, item <span class="keyword">in</span> originData:</span><br><span class="line">        trainData.setdefault(user, <span class="built_in">set</span>())</span><br><span class="line">        trainData[user].add(item)</span><br><span class="line">    <span class="keyword">return</span> trainData</span><br></pre></td></tr></table></figure>
<h4 id="建立item-user倒排表">建立Item-User倒排表</h4>
<p>这里使用了python的dict里面嵌套set来实现倒排表，伪代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">UserItemTable</span>(<span class="params">userItemTab</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    建立User-Item倒排表</span></span><br><span class="line"><span class="string">    :param userItemTab: user-item表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    item_user = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">for</span> user, items <span class="keyword">in</span> userItemTab.items():</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">            item_user.setdefault(item, <span class="built_in">set</span>())</span><br><span class="line">            item_user[item].add(user)</span><br></pre></td></tr></table></figure>
<h4 id="建立用户物品交集矩阵">建立用户物品交集矩阵</h4>
<p>同理，保存用户物品交集的矩阵采用了双重dict来实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">UserInterSection</span>(<span class="params">item_user</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    建立用户物品交集矩阵W, 其中C[u][v]代表的含义是用户u和用户v之间共同喜欢的物品数</span></span><br><span class="line"><span class="string">    :param item_user: item_user 倒排表</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    userInterSection = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">for</span> item, users <span class="keyword">in</span> item_user.items():</span><br><span class="line">        <span class="keyword">for</span> u <span class="keyword">in</span> users:</span><br><span class="line">            <span class="keyword">for</span> v <span class="keyword">in</span> users:</span><br><span class="line">                <span class="keyword">if</span> u == v:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                userInterSection.setdefault(u, defaultdict(<span class="built_in">int</span>))</span><br><span class="line">                userInterSection[u][v] += <span class="number">1</span>  <span class="comment"># 将用户u和用户v共同喜欢的物品数量加一</span></span><br></pre></td></tr></table></figure>
<h4 id="建立用户相似度矩阵">建立用户相似度矩阵</h4>
<p>用户相似度矩阵只需要在用户物品交集矩阵的基础上除以用户u和用户v各自喜爱物品列表数量的乘积。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">UserSimMatrix</span>(<span class="params">userItemTab, userInterSection</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    建立用户相似度矩阵</span></span><br><span class="line"><span class="string">    :param userItemTab: User-Item表</span></span><br><span class="line"><span class="string">    :param userInterSection: 用户物品交集矩阵</span></span><br><span class="line"><span class="string">    :return: </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    userSimMatrix = <span class="built_in">dict</span>() <span class="comment">#用户相似度矩阵</span></span><br><span class="line">    <span class="keyword">for</span> u, related_user <span class="keyword">in</span> userInterSection.items():</span><br><span class="line">        <span class="keyword">for</span> v, cuv <span class="keyword">in</span> related_user.items():</span><br><span class="line">            nu = <span class="built_in">len</span>(userItemTab[u])</span><br><span class="line">            nv = <span class="built_in">len</span>(userItemTab[v])</span><br><span class="line">            userSimMatrix[u][v] = cuv / math.sqrt(nu * nv)</span><br></pre></td></tr></table></figure>
<h3 id="推荐阶段">推荐阶段</h3>
<p>下面代码实现了推荐的功能，函数最后会返回一个逆序排列的dict，里面包含了UserCF算法筛选出来的推荐物品：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">recommend</span>(<span class="params">self, user, N, K</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    用户u对物品i的感兴趣程度：</span></span><br><span class="line"><span class="string">        p(u,i) = ∑WuvRvi</span></span><br><span class="line"><span class="string">        其中Wuv代表的是u和v之间的相似度， Rvi代表的是用户v对物品i的感兴趣程度，因为采用单一行为的隐反馈数据，所以Rvi=1。</span></span><br><span class="line"><span class="string">        所以这个表达式的含义是，要计算用户u对物品i的感兴趣程度，则要找到与用户u最相似的K个用户，对于这k个用户喜欢的物品且用户u</span></span><br><span class="line"><span class="string">        没有反馈的物品，都累加用户u与用户v之间的相似度。</span></span><br><span class="line"><span class="string">    :param user: 被推荐的用户user</span></span><br><span class="line"><span class="string">    :param N: 推荐的商品个数</span></span><br><span class="line"><span class="string">    :param K: 查找的最相似的用户个数</span></span><br><span class="line"><span class="string">    :return: 按照user对推荐物品的感兴趣程度排序的N个商品</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    recommends = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="comment"># 先获取user喜欢的item数组</span></span><br><span class="line">    related_items = <span class="variable language_">self</span>._trainData[user]</span><br><span class="line">    <span class="comment"># 将其他用户与user按照相似度逆序排序之后取前K个</span></span><br><span class="line">    <span class="keyword">for</span> v, sim <span class="keyword">in</span> <span class="built_in">sorted</span>(<span class="variable language_">self</span>._userSimMatrix[user].items(), key=itemgetter(<span class="number">1</span>), reverse=<span class="literal">True</span>)[:K]:</span><br><span class="line">        <span class="comment"># 从与user相似的用户的喜爱列表中寻找可能的物品进行推荐</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable language_">self</span>._trainData[v]:</span><br><span class="line">            <span class="comment"># 如果与user相似的用户喜爱的物品与user喜欢的物品重复了，直接跳过</span></span><br><span class="line">            <span class="keyword">if</span> item <span class="keyword">in</span> related_items:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            recommends.setdefault(item, <span class="number">0.</span>)</span><br><span class="line">            recommends[item] += sim</span><br><span class="line">    <span class="comment"># 根据被推荐物品的相似度逆序排列，然后推荐前N个物品给到用户</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(<span class="built_in">sorted</span>(recommends.items(), key=itemgetter(<span class="number">1</span>), reverse=<span class="literal">True</span>)[:N])</span><br></pre></td></tr></table></figure>
<h3 id="完整代码">完整代码</h3>
<p>下面的代码实现了完整的功能，修改“ratings.dat"文件的路径之后，可以直接运行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> Utils <span class="keyword">import</span> modelsave</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LoadMovieLensData</span>(<span class="params">filepath, train_rate</span>):</span><br><span class="line">    ratings = pd.read_table(filepath, sep=<span class="string">&quot;::&quot;</span>, header=<span class="literal">None</span>, names=[<span class="string">&quot;UserID&quot;</span>, <span class="string">&quot;MovieID&quot;</span>, <span class="string">&quot;Rating&quot;</span>, <span class="string">&quot;TimeStamp&quot;</span>],\</span><br><span class="line">                            engine=<span class="string">&#x27;python&#x27;</span>)</span><br><span class="line">    ratings = ratings[[<span class="string">&#x27;UserID&#x27;</span>,<span class="string">&#x27;MovieID&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    train = []</span><br><span class="line">    test = []</span><br><span class="line">    random.seed(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">for</span> idx, row <span class="keyword">in</span> ratings.iterrows():</span><br><span class="line">        user = <span class="built_in">int</span>(row[<span class="string">&#x27;UserID&#x27;</span>])</span><br><span class="line">        item = <span class="built_in">int</span>(row[<span class="string">&#x27;MovieID&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; train_rate:</span><br><span class="line">            train.append([user, item])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            test.append([user, item])</span><br><span class="line">    <span class="keyword">return</span> PreProcessData(train), PreProcessData(test)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PreProcessData</span>(<span class="params">originData</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    建立User-Item表，结构如下：</span></span><br><span class="line"><span class="string">        &#123;&quot;User1&quot;: &#123;MovieID1, MoveID2, MoveID3,...&#125;</span></span><br><span class="line"><span class="string">         &quot;User2&quot;: &#123;MovieID12, MoveID5, MoveID8,...&#125;</span></span><br><span class="line"><span class="string">         ...</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    trainData = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">for</span> user, item <span class="keyword">in</span> originData:</span><br><span class="line">        trainData.setdefault(user, <span class="built_in">set</span>())</span><br><span class="line">        trainData[user].add(item)</span><br><span class="line">    <span class="keyword">return</span> trainData</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserCF</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; User based Collaborative Filtering Algorithm Implementation&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, trainData, similarity=<span class="string">&quot;cosine&quot;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>._trainData = trainData</span><br><span class="line">        <span class="variable language_">self</span>._similarity = similarity</span><br><span class="line">        <span class="variable language_">self</span>._userSimMatrix = <span class="built_in">dict</span>() <span class="comment"># 用户相似度矩阵</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">similarity</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 建立User-Item倒排表</span></span><br><span class="line">        item_user = <span class="built_in">dict</span>()</span><br><span class="line">        <span class="keyword">for</span> user, items <span class="keyword">in</span> <span class="variable language_">self</span>._trainData.items():</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">                item_user.setdefault(item, <span class="built_in">set</span>())</span><br><span class="line">                item_user[item].add(user)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 建立用户物品交集矩阵W, 其中C[u][v]代表的含义是用户u和用户v之间共同喜欢的物品数</span></span><br><span class="line">        <span class="keyword">for</span> item, users <span class="keyword">in</span> item_user.items():</span><br><span class="line">            <span class="keyword">for</span> u <span class="keyword">in</span> users:</span><br><span class="line">                <span class="keyword">for</span> v <span class="keyword">in</span> users:</span><br><span class="line">                    <span class="keyword">if</span> u == v:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="variable language_">self</span>._userSimMatrix.setdefault(u, defaultdict(<span class="built_in">int</span>))</span><br><span class="line">                    <span class="keyword">if</span> <span class="variable language_">self</span>._similarity == <span class="string">&quot;cosine&quot;</span>:</span><br><span class="line">                        <span class="variable language_">self</span>._userSimMatrix[u][v] += <span class="number">1</span> <span class="comment">#将用户u和用户v共同喜欢的物品数量加一</span></span><br><span class="line">                    <span class="keyword">elif</span> <span class="variable language_">self</span>._similarity == <span class="string">&quot;iif&quot;</span>:</span><br><span class="line">                        <span class="variable language_">self</span>._userSimMatrix[u][v] += <span class="number">1.</span> / math.log(<span class="number">1</span> + <span class="built_in">len</span>(users))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 建立用户相似度矩阵</span></span><br><span class="line">        <span class="keyword">for</span> u, related_user <span class="keyword">in</span> <span class="variable language_">self</span>._userSimMatrix.items():</span><br><span class="line">            <span class="comment"># 相似度公式为 |N[u]∩N[v]|/sqrt(N[u]||N[v])</span></span><br><span class="line">            <span class="keyword">for</span> v, cuv <span class="keyword">in</span> related_user.items():</span><br><span class="line">                nu = <span class="built_in">len</span>(<span class="variable language_">self</span>._trainData[u])</span><br><span class="line">                nv = <span class="built_in">len</span>(<span class="variable language_">self</span>._trainData[v])</span><br><span class="line">                <span class="variable language_">self</span>._userSimMatrix[u][v] = cuv / math.sqrt(nu * nv)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recommend</span>(<span class="params">self, user, N, K</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        用户u对物品i的感兴趣程度：</span></span><br><span class="line"><span class="string">            p(u,i) = ∑WuvRvi</span></span><br><span class="line"><span class="string">            其中Wuv代表的是u和v之间的相似度， Rvi代表的是用户v对物品i的感兴趣程度，因为采用单一行为的隐反馈数据，所以Rvi=1。</span></span><br><span class="line"><span class="string">            所以这个表达式的含义是，要计算用户u对物品i的感兴趣程度，则要找到与用户u最相似的K个用户，对于这k个用户喜欢的物品且用户u</span></span><br><span class="line"><span class="string">            没有反馈的物品，都累加用户u与用户v之间的相似度。</span></span><br><span class="line"><span class="string">        :param user: 被推荐的用户user</span></span><br><span class="line"><span class="string">        :param N: 推荐的商品个数</span></span><br><span class="line"><span class="string">        :param K: 查找的最相似的用户个数</span></span><br><span class="line"><span class="string">        :return: 按照user对推荐物品的感兴趣程度排序的N个商品</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        recommends = <span class="built_in">dict</span>()</span><br><span class="line">        <span class="comment"># 先获取user具有正反馈的item数组</span></span><br><span class="line">        related_items = <span class="variable language_">self</span>._trainData[user]</span><br><span class="line">        <span class="comment"># 将其他用户与user按照相似度逆序排序之后取前K个</span></span><br><span class="line">        <span class="keyword">for</span> v, sim <span class="keyword">in</span> <span class="built_in">sorted</span>(<span class="variable language_">self</span>._userSimMatrix[user].items(), key=itemgetter(<span class="number">1</span>), reverse=<span class="literal">True</span>)[:K]:</span><br><span class="line">            <span class="comment"># 从与user相似的用户的喜爱列表中寻找可能的物品进行推荐</span></span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable language_">self</span>._trainData[v]:</span><br><span class="line">                <span class="comment"># 如果与user相似的用户喜爱的物品与user喜欢的物品重复了，直接跳过</span></span><br><span class="line">                <span class="keyword">if</span> item <span class="keyword">in</span> related_items:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                recommends.setdefault(item, <span class="number">0.</span>)</span><br><span class="line">                recommends[item] += sim</span><br><span class="line">        <span class="comment"># 根据被推荐物品的相似度逆序排列，然后推荐前N个物品给到用户</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(<span class="built_in">sorted</span>(recommends.items(), key=itemgetter(<span class="number">1</span>), reverse=<span class="literal">True</span>)[:N])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.similarity()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    train, test = LoadMovieLensData(<span class="string">&quot;../Data/ml-1m/ratings.dat&quot;</span>, <span class="number">0.8</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;train data size: %d, test data size: %d&quot;</span> % (<span class="built_in">len</span>(train), <span class="built_in">len</span>(test)))</span><br><span class="line">    UserCF = UserCF(train)</span><br><span class="line">    UserCF.train()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 分别对测试集中的前4个用户进行电影推荐</span></span><br><span class="line">    <span class="built_in">print</span>(UserCF.recommend(<span class="built_in">list</span>(test.keys())[<span class="number">0</span>], <span class="number">5</span>, <span class="number">80</span>))</span><br><span class="line">    <span class="built_in">print</span>(UserCF.recommend(<span class="built_in">list</span>(test.keys())[<span class="number">1</span>], <span class="number">5</span>, <span class="number">80</span>))</span><br><span class="line">    <span class="built_in">print</span>(UserCF.recommend(<span class="built_in">list</span>(test.keys())[<span class="number">2</span>], <span class="number">5</span>, <span class="number">80</span>))</span><br><span class="line">    <span class="built_in">print</span>(UserCF.recommend(<span class="built_in">list</span>(test.keys())[<span class="number">3</span>], <span class="number">5</span>, <span class="number">80</span>))</span><br></pre></td></tr></table></figure>
<p>完整代码见<a
target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FHeartbreakSurvivor%2FRsAlgorithms%2Fblob%2Fmain%2FTest%2Fusercf_test.py">https://github.com/HeartbreakSurvivor/RsAlgorithms/blob/main/Test/usercf_test.py</a>。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a
target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2F%E5%8D%94%E5%90%8C%E9%81%8E%E6%BF%BE%23%E5%9F%BA%E4%BA%8E%E9%A1%B9%E7%9B%AE%EF%BC%88Item-based%EF%BC%89%E7%9A%84%E5%8D%94%E5%90%8C%E9%81%8E%E6%BF%BE">协同过滤--维基百科</a></li>
<li>《推荐系统实战》-- 项亮</li>
<li>https://www.jianshu.com/p/a59ff0dc22a3</li>
<li>本机代码路径：/Users/zhiqiang/Downloads/RsAlgorithms-main/UserCF/usercf.py</li>
</ul>

      </div>
    </div>
    
      <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script>
      <script>
        if (window.mermaid) {
          mermaid.initialize({"startOnload":true});
        }
      </script>
    
  </article>
  <div class="post__foot">
    
      <div class="like-author">
  <input type="checkbox" id="likeCode" />
  <div class="author-face">
    <img height="100px"
         width="100px"
         id="front-face"
         alt="author face"
         src="/images/author-face.jpg" />
    <img height="100px"
         width="100px"
         id="back-face"
         alt="like code"
         src="/images/pay-code.jpg" />
  </div>
  <div class="like-text">“给作者倒杯卡布奇诺”</div>
  <label for="likeCode" class="like-btn">
    <svg viewBox="0 0 1024 1024"
         width="20px"
         style="margin-right: 10px"
         height="20px">
      <path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242" />
    </svg>
    喜欢作者
  </label>
</div>

    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/1984/01/24/%E5%9F%BA%E4%BA%8E%E7%89%A9%E5%93%81%E7%9A%84%E5%8D%8F%E5%90%8C%E8%BF%87%E6%BB%A4%E7%AE%97%E6%B3%95%EF%BC%88ItemCF%EF%BC%89%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5%E7%9A%84%E5%89%AF%E6%9C%AC/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596" />
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>推荐系统之评估方法和评价指标PR、ROC、AUC</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/1984/01/24/%E6%99%BA%E6%85%A7%E7%AC%94%E5%BD%95%E6%8A%80%E6%9C%AF%E8%B7%AF%E7%BA%BF%E6%96%87%E6%A1%A3/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596" />
        </svg>
      </div>
      基于询问笔录的智慧化辅助办案系统
    </a>
  
</div>

    
    
  </div>

    </div>
    <div class="foot">
  <div class="foot-inner">
    <div class="foot__head">
      
        <div class="foot-line">
          <div class="matts">今</div><div class="matts">夜</div><div class="matts">无</div><div class="matts">眠</div>
        </div>
      
        <div class="foot-line">
          <div class="matts">睡</div><div class="matts">意</div><div class="matts">全</div><div class="matts">无</div>
        </div>
      
    </div>
    <div class="foot__body">
      
        <div class="foot-item">
          <div class="foot-item__head">朋友</div>
          <div class="foot-item__body">
            
            


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://moyanxinxu.github.io/unlock-hf/">unlock-hf</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link+.svg" />
            <a class="foot-link" href="mailto:873101411@qq.com?subject=申请http://example.com的友链">申请友链</a>
          </div>
        
      
        
        
      
        
        
      
    </div>
  


          </div>
        </div>
      
      
        <div class="foot-item">
          <div class="foot-item__head">账号</div>
          <div class="foot-item__body">
            


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/logo-github.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/viserion-nlper">viserion-nlper</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/logo-wx.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Fq9ZIUwZvMNx2kSahz8zEw">HanLP.com</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/logo-zh.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.zhihu.com/people/shuo-hao-jin-ye-bu-dian-yan">Mundooo</a>
          </div>
        
      
        
        
      
    </div>
  


          </div>
        </div>
      
      <div class="foot-item">
        <div class="foot-item__head">联系</div>
        <div class="foot-item__body">
          


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-email.svg" />
            <a class="foot-link" href="mailto:name@example.com">name@example.com</a>
          </div>
        
      
        
        
      
        
        
      
        
        
      
    </div>
  


        </div>
      </div>
    </div>
    <div class="copyright">
      <a href="http://example.com">思想放牧之地</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
      <svg width="20" height="20" viewBox="0 0 725 725">
        <path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
        <path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
        <path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
      </svg>
      <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
    </div>
  </div>
</div>

    
    
      <script src="/js/search.js"></script>
      <script>searchInitialize("/search.json")</script>
    
    <script src="/js/copy-code.js"></script>
    
  

  </body>
</html>
