<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        【前后端开发】Jave+ES重构搜房网 | 思想放牧之地
      
    </title>
    <meta name="description" content="有情有颜 有才缺钱" />
    <meta name="keywords" content="" />
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/apple-touch-icon.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/favicon-32x32.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/favicon-16x16.png" />
    
    
      <link rel="mask-icon"
            href="/images/logo.svg"
            color="" />
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/normal.ttf);
        font-weight: normal;
    }
  </style>

  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/bold.ttf);
        font-weight: bold;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css' />
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"/>

  <meta name="generator" content="Hexo 7.3.0"></head>
  <body>
    
      <div id="search-mask" style="display:none">
  <div class="search-main" id="search-main">
    <div class="search__head">
      <div class="search-form">
        <svg t="1706347533072"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="7828"
             width="20"
             height="20">
          <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
          </path>
        </svg>
        <input id="search-input" placeholder="搜索文章">
        <svg t="1706361500528"
             id="search-clear"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="4351"
             width="20"
             height="20">
          <path d="M512 562.688l-264.2944 264.2944-50.688-50.688L461.312 512 197.0176 247.7056l50.688-50.688L512 461.312l264.2944-264.2944 50.688 50.688L562.688 512l264.2944 264.2944-50.688 50.688L512 562.688z" fill="#00" p-id="4352">
          </path>
        </svg>
      </div>
    </div>
    <div class="search__body" id="search-result"></div>
    <div class="search__foot"></div>
  </div>
</div>

    
    
    <div class=head--sticky>
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/logo.svg" />
        </a>
        <input id="navBtn" type="checkbox" />
        <div class="nav-right">
          
            <div class="search-outer">
  <div class="search" id="search-btn">
    <svg t="1706347533072"
         class="icon"
         viewBox="0 0 1024 1024"
         version="1.1"
         xmlns="http://www.w3.org/2000/svg"
         p-id="7828"
         width="20"
         height="20">
      <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
      </path>
    </svg>
    <span>搜索</span>
    <span class="search-shortcut-key">Ctrl K</span>
  </div>
</div>

          
          <div class="nav-menu">
            
              
                <a class="nav-menu-item" href="/AI">AI大模型</a>
              
                <a class="nav-menu-item" href="/photograph">拍摄摄影</a>
              
                <a class="nav-menu-item" href="/live">生活随记</a>
              
                <a class="nav-menu-item" target="_blank" rel="noopener" href="https://bbs.hanlp.com/">社区维护</a>
              
            
            <a class="nav-menu-item" href='/cv/'>简历</a>
          </div>
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner--toc">
      <div class="post-content__head">
        <div class="post-title">【前后端开发】Jave+ES重构搜房网</div>
        <div class="post-info">
          
  <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" class="post-tag">#大数据</a><a href="/tags/elasticSearch/" class="post-tag">#elasticSearch</a><a href="/tags/%E5%89%8D%E5%90%8E%E7%AB%AF/" class="post-tag">#前后端</a><a href="/tags/JAVA/" class="post-tag">#JAVA</a>


          <span class="post-date">2023-09-26</span>
        </div>
      </div>
      
        <aside class="toc-outer">
          <div class="toc-title">目录</div>
          <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#es%E9%87%8D%E6%9E%84%E6%90%9C%E6%88%BF%E7%BD%91"><span class="post-toc-text">ES重构搜房网</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%80es%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF"><span class="post-toc-text">一、es相关技术</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="post-toc-text">1、系统架构</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%AF%BE%E7%A8%8B%E6%94%B6%E8%8E%B7"><span class="post-toc-text">2、课程收获</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%E4%BB%8B%E7%BB%8D"><span class="post-toc-text">二、技术选型介绍</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%E4%BB%8B%E7%BB%8D"><span class="post-toc-text">1、数据库技术选型介绍</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="post-toc-text">三、需求分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF"><span class="post-toc-text">项目背景</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%9B%AE%E6%A0%87%E7%94%A8%E6%88%B7"><span class="post-toc-text">目标用户</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%8F%AF%E8%A1%8C%E6%80%A7"><span class="post-toc-text">项目可行性</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%9B%9B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="post-toc-text">四、数据库设计</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9F%BA%E7%A1%80%E8%A1%A8%E4%BB%8B%E7%BB%8D"><span class="post-toc-text">1、基础表介绍</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="post-toc-text">2、表结构设计原则</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%94%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="post-toc-text">五、环境要求</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%85%AD%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA"><span class="post-toc-text">六、后端框架搭建</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%96%B0%E5%BB%BAconfig%E5%B7%A5%E5%85%B7%E5%8C%85%E5%88%9B%E5%BB%BAjpaconfig%E7%B1%BB"><span class="post-toc-text">1、新建config工具包，创建JpaConfig类</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%83%E9%9B%86%E6%88%90%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="post-toc-text">七、集成单元测试</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9C%A8spring%E4%B8%AD%E4%BD%BF%E7%94%A8junit%E6%9D%A5%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="post-toc-text">1、在spring中使用JUnit来进行测试。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8h2%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%A3%E8%80%A6mysql%E6%9D%A5%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="post-toc-text">2、如何利用H2内存数据库解耦mysql来进行测试。</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%85%AB%E5%89%8D%E7%AB%AF%E9%9B%86%E6%88%90"><span class="post-toc-text">八、前端集成</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9B%86%E6%88%90thymeleaf%E5%8F%8A%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="post-toc-text">1、集成thymeleaf及基本用法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9B%86%E6%88%90bootstrap"><span class="post-toc-text">2、集成Bootstrap</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9B%86%E6%88%90jquery"><span class="post-toc-text">3、集成jQuery</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B9%9D%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E5%B1%82"><span class="post-toc-text">九、架构设计与分层</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BB%93%E6%9E%84%E5%88%86%E5%B1%82"><span class="post-toc-text">结构分层</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81api%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="post-toc-text">十、API结构设计</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#restfulapi%E7%9A%84%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="post-toc-text">RestfulApi的结构设计</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89api%E8%BF%94%E5%9B%9E%E7%9A%84%E6%A0%87%E5%87%86"><span class="post-toc-text">自定义API返回的标准</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%B8%80%E5%BC%82%E5%B8%B8%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="post-toc-text">十一、异常拦截器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%A6%96%E5%85%88%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%B7%BB%E5%8A%A0%E5%BC%82%E5%B8%B8%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="post-toc-text">1、首先，为什么要添加异常拦截器？</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%88%91%E4%BB%AC%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0%E4%B8%A4%E4%B8%AA%E5%BC%82%E5%B8%B8%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="post-toc-text">2、我们主要实现两个异常拦截器：</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%A1%B5%E9%9D%A2%E5%BC%82%E5%B8%B8%E6%8B%A6%E6%88%AA%E5%99%A8-404-403-500%E9%A1%B5%E9%9D%A2%E7%AD%89"><span class="post-toc-text">1、页面异常拦截器 404 403
500页面等。</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#api%E5%BC%82%E5%B8%B8%E6%8B%A6%E6%88%AA%E5%99%A8-%E5%90%8C%E6%A0%B7%E6%98%AF%E6%8B%A6%E6%88%AA404-403-500%E7%AD%89%E6%83%85%E5%86%B5"><span class="post-toc-text">2、API异常拦截器
同样是拦截404 403 500等情况。</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%BA%8C%E5%8A%9F%E8%83%BD%E6%80%A7%E9%A1%B5%E9%9D%A2%E5%BC%80%E5%8F%91"><span class="post-toc-text">十二、功能性页面开发</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%9D%83%E9%99%90%E9%99%90%E5%88%B6%E6%80%A7%E9%A1%B5%E9%9D%A2"><span class="post-toc-text">403:权限限制性页面</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#not-found-%E6%8F%90%E7%A4%BA%E9%A1%B5%E9%9D%A2"><span class="post-toc-text">404:Not found 提示页面</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%BC%82%E5%B8%B8%E6%9C%8D%E5%8A%A1%E6%8F%90%E7%A4%BA%E9%A1%B5%E9%9D%A2"><span class="post-toc-text">500:异常服务提示页面</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%B8%89%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="post-toc-text">十三、后台管理模块</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="post-toc-text">业务与功能分析：</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E5%9B%9B%E5%90%8E%E5%8F%B0%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">十四、后台登录功能模块实现</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%BA%94%E9%AA%8C%E8%AF%81%E5%A4%B1%E8%B4%A5%E9%80%BB%E8%BE%91%E5%A4%84%E7%90%86"><span class="post-toc-text">十五、验证失败逻辑处理</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E5%85%AD%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="post-toc-text">十六、房源信息管理模块</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90-1"><span class="post-toc-text">业务与功能分析：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87"><span class="post-toc-text">实现目标：</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%B8%83%E5%9F%BA%E4%BA%8E%E4%B8%83%E7%89%9B%E4%BA%91%E7%9A%84%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E4%B8%8A%E4%BC%A0%E5%88%B0%E6%9C%AC%E5%9C%B0"><span class="post-toc-text">十七、基于七牛云的图片上传（上传到本地）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E5%85%AB%E5%9F%BA%E4%BA%8E%E4%B8%83%E7%89%9B%E4%BA%91%E7%9A%84%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E4%B8%8A%E4%BC%A0%E5%88%B0%E4%B8%83%E7%89%9B%E4%BA%91"><span class="post-toc-text">十八、基于七牛云的图片上传（上传到七牛云）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%B9%9D%E6%96%B0%E5%A2%9E%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF%E5%8A%9F%E8%83%BD1"><span class="post-toc-text">十九、新增房源信息功能(1)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E6%96%B0%E5%A2%9E%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF%E5%8A%9F%E8%83%BD2"><span class="post-toc-text">二十、新增房源信息功能(2)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%80%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF%E6%B5%8F%E8%A7%88%E5%8A%9F%E8%83%BD1"><span class="post-toc-text">二十一、房源信息浏览功能(1)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9F%BA%E7%A1%80%E5%BC%80%E5%8F%91"><span class="post-toc-text">1）基础开发</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%88%86%E9%A1%B5%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">2）分页实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%A4%9A%E7%BB%B4%E5%BA%A6%E6%8E%92%E5%BA%8F"><span class="post-toc-text">3）多维度排序</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%8A%A0%E4%B8%80%E4%B8%AAredissessionconfig%E9%85%8D%E7%BD%AE"><span class="post-toc-text">1、加一个RedisSessionConfig配置</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E4%BA%8C%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF%E6%B5%8F%E8%A7%88%E5%8A%9F%E8%83%BD2"><span class="post-toc-text">二十二、房源信息浏览功能(2)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%89%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF%E6%B5%8F%E8%A7%88%E5%8A%9F%E8%83%BD3"><span class="post-toc-text">二十三、房源信息浏览功能(3)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E5%9B%9B%E7%BC%96%E8%BE%91%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B01"><span class="post-toc-text">二十四、编辑功能实现1</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E4%BA%94%E7%BC%96%E8%BE%91%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B02"><span class="post-toc-text">二十五、编辑功能实现2</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E5%85%AD%E5%AE%A1%E6%A0%B8%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">二十六、审核功能实现</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%83%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="post-toc-text">二十七、基础功能分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90-2"><span class="post-toc-text">1、业务与功能分析</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87-1"><span class="post-toc-text">2、实现目标</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E5%85%AB%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">二十八、基础功能实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF%E6%B5%8F%E8%A7%88%E5%8A%9F%E8%83%BD"><span class="post-toc-text">1、房源信息浏览功能</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%8D%81%E4%B9%9D%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="post-toc-text">二十九、房源信息详情页</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0-%E4%B8%9A%E5%8A%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="post-toc-text">三十、搜索引擎实现-业务与功能分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">搜索引擎实现</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E4%B8%80es%E4%B8%8Emysql%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="post-toc-text">三十一、ES与MySQL技术选型</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#elasticsearch%E4%B8%8Emysql%E5%AE%9E%E7%8E%B0%E6%90%9C%E7%B4%A2%E5%AF%B9%E6%AF%94"><span class="post-toc-text">ElasticSearch与MySQL实现搜索对比</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E4%BA%8C%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="post-toc-text">三十二、索引结构设计</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E4%B8%89%E7%B4%A2%E5%BC%95%E6%9E%84%E5%BB%BA-%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91"><span class="post-toc-text">三十三、索引构建-核心逻辑</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%96%B0%E5%BB%BAesconfig%E7%B1%BB"><span class="post-toc-text">1、新建esConfig类</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E5%9B%9B%E7%B4%A2%E5%BC%95%E6%9E%84%E5%BB%BA-%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%912"><span class="post-toc-text">三十四、索引构建-核心逻辑2</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E4%BA%94%E7%B4%A2%E5%BC%95%E6%9E%84%E5%BB%BA-%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="post-toc-text">三十五、索引构建-消息中间件</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E5%85%AD%E7%B4%A2%E5%BC%95%E6%9E%84%E5%BB%BA-%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5"><span class="post-toc-text">三十六、索引构建-代码实践</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%84%B6%E5%90%8E%E8%BF%9B%E8%A1%8Ckafka%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5"><span class="post-toc-text">然后进行kafka的代码实践：</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E4%B8%83%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">三十七、搜索引擎实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="post-toc-text">搜索功能</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E5%85%AB%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D-%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="post-toc-text">三十八、中文分词-问题描述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%8D%81%E4%B9%9D%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D-ik%E9%85%8D%E7%BD%AE"><span class="post-toc-text">三十九、中文分词-IK配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%9B%9B%E5%8D%81search-as-you-type"><span class="post-toc-text">四十、Search-as-you-type</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%9B%9B%E5%8D%81%E4%B8%80%E5%B0%8F%E5%8C%BA%E6%88%BF%E6%BA%90%E7%BB%9F%E8%AE%A1%E5%8A%9F%E8%83%BD"><span class="post-toc-text">四十一、小区房源统计功能</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%9B%9B%E5%8D%81%E4%BA%8C%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%BC%98%E5%8C%96"><span class="post-toc-text">四十二、搜索引擎优化</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%9B%9B%E5%8D%81%E4%B8%89%E5%9F%BA%E4%BA%8E%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E7%9A%84%E6%89%BE%E6%88%BF%E5%8A%9F%E8%83%BD"><span class="post-toc-text">四十三、基于百度地图的找房功能</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%B8%8E%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="post-toc-text">业务与需求分析：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87-2"><span class="post-toc-text">实现目标：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9F%BA%E4%BA%8Ees%E7%9A%84%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="post-toc-text">基于ES的功能开发：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%9C%B0%E5%9D%80%E8%8E%B7%E5%8F%96%E7%BB%8F%E7%BA%AC%E5%BA%A6%E7%9A%84%E5%BC%80%E5%8F%91"><span class="post-toc-text">基于地址获取经纬度的开发：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9F%BA%E4%BA%8Ees%E7%9A%84%E5%9C%B0%E5%9B%BE%E7%82%B9%E8%81%9A%E5%90%88"><span class="post-toc-text">基于ES的地图点聚合</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%83%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">七、搜索引擎实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90-3"><span class="post-toc-text">1、业务与功能分析</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#section"><span class="post-toc-text"></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87-3"><span class="post-toc-text">2、实现目标</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0-1"><span class="post-toc-text">3、搜索引擎实现</span></a></li></ol></li></ol></li></ol>
          <a href="#" class="toc-top">回到顶部</a>
        </aside>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <h1 id="es重构搜房网">ES重构搜房网</h1>
<h2 id="一es相关技术">一、es相关技术</h2>
<ul>
<li><p>强力技术组合技 = ElasticSearch + MySQL + Kafka</p>
<p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvhjpa9oj215a09ygma.jpg" alt="image-20220704142142250" style="zoom: 33%;" /></p></li>
<li><p>强强联合 = ElasticSearch + 百度地图</p>
<p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvi7pdfoj20xu0fumxu.jpg" alt="image-20220704142238638" style="zoom: 33%;" /></p></li>
<li><p>ElasticSearch生产环境优化经验</p></li>
<li><p>负载加安全 = ElasticSearch + Nginx</p>
<p><img src="https://image.baidu.com/search/down?url=https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvjoo77uj212s08e74r.jpg" alt="image-20220704142403633" style="zoom:33%;" /></p></li>
<li><p>传说中的数据分析神器 ELK = ElasticSearch + Logstash +
Kibana</p></li>
</ul>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvkx2hywj211809u3yr.jpg" alt="image-20220704142514879" style="zoom:33%;" /></p>
<ul>
<li>基础核心技术框架 = SpringBoot</li>
</ul>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvllo1qfj20jq0ay0t5.jpg" alt="image-20220704142552030" style="zoom:33%;" /></p>
<ul>
<li>数据库的常青树 = MySQL + Spring Data JPA</li>
</ul>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvmr00llj20zs0ak74x.jpg" alt="image-20220704142700158" style="zoom:33%;" /></p>
<ul>
<li>前端核心技术框架 = thymeleaf + Bootstrap + jQuery</li>
</ul>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvo2191mj215q0eawfk.jpg" alt="image-20220704142815132" style="zoom:33%;" /></p>
<ul>
<li>项目安全框架 = Spring Security</li>
<li>图片上传 = 七牛云 + webUpload</li>
</ul>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvp9u8vhj20pm08iweq.jpg" alt="image-20220704142925971" style="zoom:33%;" /></p>
<ul>
<li>免注册登陆 = 阿里短信</li>
</ul>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvprdcqoj20r40f00tz.jpg" alt="image-20220704142953479" style="zoom:33%;" /></p>
<h3 id="系统架构">1、系统架构</h3>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uvqrifj8j20zo0lyae7.jpg" alt="image-20220704143051510" style="zoom: 50%;" /></p>
<h3 id="课程收获">2、课程收获</h3>
<ul>
<li>了解一个中度复杂规模的应用开发流程</li>
<li>掌握ElasticSearch的高级业务应用</li>
<li>熟悉ES与其他技术框架的应用结合思路与技巧</li>
<li>掌握ES的相关优化技巧及扩展应用</li>
<li>熟悉完整的搜房网业务，提升技术应用能力</li>
</ul>
<h2 id="二技术选型介绍">二、技术选型介绍</h2>
<h3 id="数据库技术选型介绍">1、数据库技术选型介绍</h3>
<p>​
<strong>MySQL</strong>：MySQL是当前最流行的关系型数据库，在互联网公司MySQL也是应用最多的关系型数据库。</p>
<p>​ <strong>ElasticSearch</strong>：ElasticSearch是基于Apache
Lucene的开源搜索引擎。</p>
<p>​ <strong>ElasticSearch Vs MySQL</strong>：</p>
<pre><code>        利用ES方便实现站内搜索引擎</code></pre>
<p>​ 利用MySQL的事务特性做稳定的数据存储</p>
<p>​ 以MySQL做基础数据存储，结合ES实现站内搜索引擎</p>
<h2 id="三需求分析">三、需求分析</h2>
<ol type="1">
<li><h3 id="项目背景">项目背景</h3></li>
<li><h3 id="目标用户">目标用户</h3></li>
<li><h3 id="项目可行性">项目可行性</h3></li>
</ol>
<h2 id="四数据库设计">四、数据库设计</h2>
<blockquote>
<p>ER图</p>
</blockquote>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uwayv4qtj20zc0k0jsi.jpg" alt="image-20220704145015972" style="zoom: 50%;" /></p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h3uwb97ci1j211m0m6ac3.jpg" alt="image-20220704145033327" style="zoom: 50%;" /></p>
<h3 id="基础表介绍">1、基础表介绍</h3>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4nyvqn9ekj21e00owq8f.jpg"
alt="image-20220729182048729" />
<figcaption aria-hidden="true">image-20220729182048729</figcaption>
</figure>
<blockquote>
<p>其中关于两个表之前的关联，最好使用逻辑上的外键连接，少用数据库中的外键连接，在分表分库的时候会依赖数据库的一些操作，有一定的依赖性。慎用数据库特性，分表的时候将会是一个灾难。</p>
</blockquote>
<h3 id="表结构设计原则">2、表结构设计原则</h3>
<blockquote>
<p>​ 减少中间表的设计</p>
<p>​ 保证表表之间没有耦合</p>
</blockquote>
<h2 id="五环境要求">五、环境要求</h2>
<p>Java环境： JDK1.8</p>
<p>构建工具： Maven</p>
<p>常用IDE：（IDEA、Eclipse等）</p>
<h2 id="六后端框架搭建">六、后端框架搭建</h2>
<ul>
<li>SpringBoot</li>
<li>Spring Data JPA + Hibernate</li>
</ul>
<h3
id="新建config工具包创建jpaconfig类">1、新建config工具包，创建JpaConfig类</h3>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4nz76jcydj20ia03rmxc.jpg"
alt="image-20220729183149365" />
<figcaption aria-hidden="true">image-20220729183149365</figcaption>
</figure>
<p>加入注解@Configuration。</p>
<p>加入@EnableJpaRepositories让其可以扫描到我们的repository Dao类。</p>
<p>加入@EnableTransactionManagement 允许事务管理。</p>
<p>新建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="comment">/*建立数据源，并设定数据源配置的前缀，需要用到数据源mysql的用户名密码等，在properties文件中增加*/</span></span><br><span class="line">   <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在application.properties文件中增加mysql信息：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/xunwu?useSSL=false&amp;allowPublicKeyRetrieval=true</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456789</span><br></pre></td></tr></table></figure>
<p>另外设置实体类的管理工厂
LocalContainerEntityManagerFactoryBean，实例化Hibernate，因为jpa实现的是hibernate，所以要选择HibernateJpaVendorAdapter，然后设置jpaVendor.setGenerateDdl为false，设置其不会自动生成sql，因为要把sql权掌握在自己的手里。</p>
<p>再=实例化实体映射管理工厂类LocalContainerEntityManagerFactoryBean。对该工厂类设置一些属性，setDataSource，setJpaVendorAdapter（jpaVendorAdapter），setPackagesToScan（实体类的包名），最后返回新建的实体类映射管理工厂bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"> <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">entityManagerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">HibernateJpaVendorAdapter</span> <span class="variable">japVendor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HibernateJpaVendorAdapter</span>();</span><br><span class="line">     japVendor.setGenerateDdl(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">     <span class="type">LocalContainerEntityManagerFactoryBean</span> <span class="variable">entityManagerFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalContainerEntityManagerFactoryBean</span>();</span><br><span class="line">     entityManagerFactory.setDataSource(dataSource());</span><br><span class="line">     entityManagerFactory.setJpaVendorAdapter(japVendor);</span><br><span class="line">     entityManagerFactory.setPackagesToScan(<span class="string">&quot;com.zryy.soufangtest.entity&quot;</span>);</span><br><span class="line">     <span class="keyword">return</span> entityManagerFactory;</span><br></pre></td></tr></table></figure>
<p>再去新建一个com.zryy.soufangtest.entity实体类包。</p>
<p>在JPAConfig类下我们添加了一个事务管理的注解，所以我们需要新建一个事务管理的类PlatformTransactionManager。传的参数是实体映射管理工厂EntityManagerFactory，在内部中实例化一下事务管理类JpaTransactionManager，把实体映射管理工厂当参数传进去。最后返回事物管理类TransactionManager。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">  public PlatformTransactionManager transactionManager(EntityManagerFactory entityManagerFactory) &#123;</span><br><span class="line">      JpaTransactionManager transactionManager = new JpaTransactionManager();</span><br><span class="line">      transactionManager.setEntityManagerFactory(entityManagerFactory);</span><br><span class="line">      return transactionManager;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>到这里我们的Jpa配置就设置完成了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by zhiqiang</span><br><span class="line"> */</span><br><span class="line">/*允许事务管理*/</span><br><span class="line">@Configuration</span><br><span class="line">@EnableJpaRepositories(basePackages = &quot;com.zryy.soufangtest.repository&quot;)</span><br><span class="line">@EnableTransactionManagement</span><br><span class="line">public class JPAConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    /*建立数据源，并设定数据源配置的前缀，需要用到数据源mysql的用户名密码等，在properties文件中增加*/</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br><span class="line">    public DataSource dataSource()&#123;</span><br><span class="line">        return DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public LocalContainerEntityManagerFactoryBean entityManagerFactory() &#123;</span><br><span class="line">        HibernateJpaVendorAdapter japVendor = new HibernateJpaVendorAdapter();</span><br><span class="line">        japVendor.setGenerateDdl(false);</span><br><span class="line"></span><br><span class="line">        LocalContainerEntityManagerFactoryBean entityManagerFactory = new LocalContainerEntityManagerFactoryBean();</span><br><span class="line">        entityManagerFactory.setDataSource(dataSource());</span><br><span class="line">        entityManagerFactory.setJpaVendorAdapter(japVendor);</span><br><span class="line">        entityManagerFactory.setPackagesToScan(&quot;com.zryy.soufangtest.entity&quot;);</span><br><span class="line">        return entityManagerFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PlatformTransactionManager transactionManager(EntityManagerFactory entityManagerFactory) &#123;</span><br><span class="line">        JpaTransactionManager transactionManager = new JpaTransactionManager();</span><br><span class="line">        transactionManager.setEntityManagerFactory(entityManagerFactory);</span><br><span class="line">        return transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>另外在配置文件中我们还要增加两条：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.jpa.show-sql</span>=<span class="string">true     #方便我们在开发过程中看到hibernate给我们建立的sql语句。</span></span><br><span class="line"><span class="attr">spring.jpa.hibernate.ddl-auto</span> = <span class="string">validate</span></span><br></pre></td></tr></table></figure>
<p>正常情况下我们的日志级别是info，但是我们的日志打印级别是debug级别，把sql级别打印调为debug这样才可以正常输出。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging.level.org.hibernate.SQL</span> = <span class="string">debug</span></span><br></pre></td></tr></table></figure>
<p>运行测试mvn，如果提示“No Spring Session store is configured: Set the
spring.session.store-type property”，则将设置spring会话存储的类型</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.session.store-type</span> = <span class="string">hash_map	</span></span><br></pre></td></tr></table></figure>
<p>如果打开localhost:8080后有验证，则可以设置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security.basic.enabled</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>
<p>测试在main函数中增加一个@RestController</p>
<h2 id="七集成单元测试">七、集成单元测试</h2>
<h3
id="在spring中使用junit来进行测试">1、在spring中使用JUnit来进行测试。</h3>
<h3
id="如何利用h2内存数据库解耦mysql来进行测试">2、如何利用H2内存数据库解耦mysql来进行测试。</h3>
<blockquote>
<p>依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- jpa相关依赖 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 测试依赖 --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>建数据表，存入sql数据。</p>
<p>或者新建entity包，新建实体类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;phone_number&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String phoneNumber;</span><br></pre></td></tr></table></figure>
<p>其中因为要兼顾hibernate和h2所以主键的自增方式不能写为GenerationType.auto，修改为Identity</p>
<p>在实体类中定义的变量参数一般都是驼峰的，而在数据库中一般定义的是下划线的，所以添加column注解。给他的orm-Mapping做一个映射。另外我们定义的实体类首字母是大写的，但是在sql中表是小写的，所以也要添加@Table（name
=“ ”）注解。</p>
<p>再定义userRepository 也就是jpa操作类，是一个接口，并且实现Crud
Repository&lt;xx,xx&gt;。 第一个是我们自己定义的实体类，第二个参数。</p>
<p>我们在单元测试中写一个单独的测试类去继承系统给的测试类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class UserRepositoryTest extends SoufangTestApplicationTests &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFindOne() &#123;</span><br><span class="line">        User user = userRepository.findOne(1L);</span><br><span class="line">        Assert.assertEquals(&quot;wali&quot;,  user.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在实际开发过程中，会脱离mysq进行测试，而使用h2内存数据库。</p>
<p>做一下配置分离。新建：application-test.properties /
application-dev-properties</p>
<p>然后在在application.properties文件中添加spring.profiles.active = dev
进行激活。</p>
<p>可以把一些通用的配置放在application.properties中，一些个性化的放在单独的文件中。</p>
<p>在-test配置文件中加入</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">org.h2.Driver	</span></span><br></pre></td></tr></table></figure>
<p>如果上面步骤直接执行的话，并不会走测试配置，需要配置一个注解@ActiveProfiles("test")，
/<em>加这个注解就会走application-test.properties</em>/</p>
<p>在resources文件夹下新建db文件夹，里面包含两个文件，一个是结构体，另外一个是表数据文件。</p>
<p>然后在-test.properties中指定目录：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.schema</span>=<span class="string">classpath:db/schema.sql</span></span><br><span class="line"><span class="attr">spring.datasource.data</span>=<span class="string">classpath:db/data.sql</span></span><br></pre></td></tr></table></figure>
<p>再运行测试文件就ok通过了。</p>
<h2 id="八前端集成">八、前端集成</h2>
<h3 id="集成thymeleaf及基本用法">1、集成thymeleaf及基本用法</h3>
<p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 前端模板 thymeleaf 依赖 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.thymeleaf/thymeleaf --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;thymeleaf.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-spring4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意thymeleaf的版本做个一个覆盖，在properties标签下进行对springboot所依赖的版本进行了覆盖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- thymeleaf 覆盖parent 选择自己的版本 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">thymeleaf.version</span>&gt;</span>3.0.3.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf.version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">thymeleaf-extras-springsecurity4.version</span>&gt;</span>3.0.2.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf-extras-springsecurity4.version</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>并进行相关的配置：</p>
<p>新建WebMvcConfig类
，并且对其继承WebMvcConfigurerAdapter类，并实现ApplicationContextAware，实现的该接口可以帮助我们获取spring的一个上下文。</p>
<p>先私有化一个类，把这个对象持久化一下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext</span><br></pre></td></tr></table></figure>
<p>然后在覆盖的set方法里面，把这个变量给set进去，赋值。</p>
<p>然后对模板资源进行解析<strong>（模版资源解析器）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SpringResourceTemplateResolver <span class="title function_">templateResolver</span><span class="params">()</span>&#123;</span><br><span class="line">	#新建一个</span><br><span class="line">	<span class="type">SpringResourceTemplateResolver</span> <span class="variable">templateRosolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringResourceTemplateResolver</span>();</span><br><span class="line">	#然后设置spring的application上下文</span><br><span class="line">	templateRolver.setApplicationContext(<span class="built_in">this</span>.applicationContext);</span><br><span class="line">	<span class="keyword">return</span> templateRolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外一个呢，还有一个thymeleaf<strong>标准方言解释器。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SpringTemplateEngine <span class="title function_">templateEngine</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">SpringTemplateEngine</span> <span class="variable">templateEngine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringTemplateEngine</span>();</span><br><span class="line">	templateEngine.setTemplateResolver(templateResolver)  <span class="comment">//上面刚设置的模版资源解析器</span></span><br><span class="line">	<span class="comment">//并且设置支持spring EL表达式</span></span><br><span class="line">	templateEngine.setEnableSpringELCompiler(<span class="literal">true</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> templateEngine；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面还定义springSecurity方言，这里不做设置，在下文中会进行介绍。</p>
<p>除此之外还有一个<strong>视图解析器。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ThymeleafViewResolver <span class="title function_">viewResolver</span><span class="params">(templateEngine)</span>&#123;</span><br><span class="line">	<span class="type">ThymeleafViewResolver</span> <span class="variable">viewResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThymeleafViewResolver</span>();</span><br><span class="line">  viewResolver.setTemplateEngine(templateEngine());</span><br><span class="line">  <span class="keyword">return</span> vierResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到目前为止thymeleaf的搜索引擎基本搭建完毕。</p>
<p>另外呢还需要在配置文件中进行一些其他的配置，因为模版内容是经常进行变化的，thymeleaf在运行中默认是开启缓存的，会使得修改的内容不能够得到及时的反馈。可以设置其不能进行缓存。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.thymeleaf.cache</span> = <span class="string">false</span></span><br></pre></td></tr></table></figure>
<p>另外还有一个通用的配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.thymeleaf.mode</span> =<span class="string">HTML</span></span><br></pre></td></tr></table></figure>
<p>thymeleaf默认的是HTML5，不过现在已经废弃了，这个是必备的，用HTML。</p>
<p>另外还可以在配置文件中配置thymeleaf模版的前缀、后缀。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.thymeleaf.suffix</span> = <span class="string">.html. </span></span><br><span class="line"><span class="attr">spring.thymeleaf.prefix</span>=<span class="string">classpath:/templates/</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>小技巧：可以通过命令行mvn spring-boot:run方式进行启动</p>
<p>当然也可以通过IDEA的快捷方式来启动：</p>
<p>Command line： clean package spring-boot:run
-Dmaven.test.skip=true</p>
<p>//-Dmaven.test.skip=true 是跳过测试类</p>
</blockquote>
<p>有时候启动程序先加载再编译时间速度非常缓慢。可以使用SpringBoot自带热加载开发工具：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- SpringBoot自带热加载开发工具 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>还要在IDEA中修改一些配置才可以生效，注意设置好之后需要重启IDEA才可以生效，这里不做介绍更多自行查阅。</p>
<p>如果提示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could not open ServletContext resource [/index]</span><br></pre></td></tr></table></figure>
<p>那么就在模版资源解析器中添加配置注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.thymeleaf&quot;)</span></span><br></pre></td></tr></table></figure>
<p>这样就可以了。</p>
<p>新建一个controller添加测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/index2&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">index2</span><span class="params">(Model model)</span>&#123;</span><br><span class="line">       model.addAttribute(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;zhiqiang&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;index2&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>并且新建一个html页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello ,zhiqiang<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4s8x24xf9j20ay061dfv.jpg"
alt="image-20220802111018198" />
<figcaption aria-hidden="true">image-20220802111018198</figcaption>
</figure>
<p>另外，加载一些静态资源：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4s8xqywzoj20l80qkmyc.jpg" alt="image-20220802111059762" style="zoom: 50%;" /></p>
<p>按照该目录结构进行部署，并且在WebMvcConfig中需要单独进行配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 静态资源加载配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">    registry.addResourceHandler(<span class="string">&quot;/static/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/static/&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加处理路径和静态资源绝对路径。意味着我们只要在静态资源里面加入/static/**前缀就会到classpath：/static/路径下找到相关的静态资源文件。</p>
<h3 id="集成bootstrap">2、集成Bootstrap</h3>
<h3 id="集成jquery">3、集成jQuery</h3>
<h2 id="九架构设计与分层">九、架构设计与分层</h2>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4sf3g2rvpj21480u044k.jpg" alt="image-20220802144402131" style="zoom:50%;" /></p>
<h3 id="结构分层">结构分层</h3>
<p>经典的三层架构：</p>
<p>​ 表示层 ——web</p>
<p>​ 业务逻辑层——service</p>
<p>​ 数据层——entity、repository</p>
<h2 id="十api结构设计">十、API结构设计</h2>
<h3 id="restfulapi的结构设计">RestfulApi的结构设计</h3>
<h3 id="自定义api返回的标准">自定义API返回的标准</h3>
<ul>
<li>code 自定义请求状态编码</li>
<li>message自定义请求响应信息描述</li>
<li>data请求目标数据</li>
</ul>
<p>新建一个base文件包，存储一些基础的结构体，比如：ApiResponse</p>
<p>另外我们在class ApiResponse定义了一个内部允许类 Status</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiResponse</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">	<span class="keyword">private</span> String message;</span><br><span class="line">	<span class="keyword">private</span> Object data;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> more;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Status</span>&#123;</span><br><span class="line">		SUCESS(<span class="number">200</span>,<span class="string">&quot;ok&quot;</span>),</span><br><span class="line">		BAD_REQUEST(<span class="number">400</span>, <span class="string">&quot;Bad Request&quot;</span>),</span><br><span class="line">    INTERNAL_SERVER_ERROR(<span class="number">500</span>,<span class="string">&quot;Unknown Internal Error&quot;</span> ),</span><br><span class="line">    NOT_VALID_PARAM(<span class="number">40006</span>,<span class="string">&quot;Operation not supported&quot;</span>),</span><br><span class="line">    NOT_LOGIN(<span class="number">50000</span>,<span class="string">&quot;Not Login&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String standardMessage;</span><br><span class="line">    <span class="comment">//建立构造器</span></span><br><span class="line">    Status(<span class="type">int</span> code, String standardMessage) &#123;</span><br><span class="line">      <span class="built_in">this</span>.code = code;</span><br><span class="line">      <span class="built_in">this</span>.standardMessage = standardMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置get set方法</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且可以创建一个构造器，而有的api只是想确认一下状态，这时候可以创建一个空的构造器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ApiResponse</span><span class="params">(<span class="type">int</span> code, String message, Object data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ApiResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = Status.SUCCESS.getCode();</span><br><span class="line">        <span class="built_in">this</span>.message = Status.SUCCESS.getStandardMessage();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>以及设计三个静态方法类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ApiResponse <span class="title function_">ofMessage</span><span class="params">(<span class="type">int</span> code ,String message)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(code,message,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ApiResponse <span class="title function_">ofSuccess</span><span class="params">(Object data)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(Status.SUCCESS.getCode(), Status.SUCCESS.getStandardMessage(), data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>  <span class="keyword">static</span> ApiResponse <span class="title function_">ofStatus</span><span class="params">(Status status)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(status.getCode(),status.getStandardMessage(),<span class="literal">null</span>    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="keyword">public</span> ApiResponse <span class="title function_">apiget</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ApiResponse.ofMessage(<span class="number">200</span>,<span class="string">&quot;成功了&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>返回结果如下：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4sjvoqsvdj20a107974i.jpg"
alt="image-20220802172936208" />
<figcaption aria-hidden="true">image-20220802172936208</figcaption>
</figure>
<h2 id="十一异常拦截器">十一、异常拦截器</h2>
<h3
id="首先为什么要添加异常拦截器">1、首先，为什么要添加异常拦截器？</h3>
<p>会有很多我们想象不到的情况，比如说用户页面访问接口异常，用户访问不存在的页面
，用户的权限不如等等。</p>
<h3 id="我们主要实现两个异常拦截器">2、我们主要实现两个异常拦截器：</h3>
<h4 id="页面异常拦截器-404-403-500页面等">1、页面异常拦截器 404 403
500页面等。</h4>
<h4 id="api异常拦截器-同样是拦截404-403-500等情况">2、API异常拦截器
同样是拦截404 403 500等情况。</h4>
<p>比如我们输入localhost:8000/xxx就会弹出 Whitelabel Error
Page页面，这个是springboot自带的一个页面。</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4tggx3534j214c0b4aaw.jpg" alt="image-20220803121706517" style="zoom:50%;" /></p>
<p>在配置文件中修改并进行优化：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.error.whitelabel.enabled</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>
<p>并且在base包中新建一个AppErrorController类
继承ErrorController类。</p>
<p>设置一个静态变量ERROR_PATH = "/error"</p>
<p>并且覆盖类 getErrorPath（）方法类，return ERROR_PATH。</p>
<p>并且将errorAttributes新建个内部变量存储起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AppErrorController</span><span class="params">(ErrorAttributes errorAttributes)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.errorAttributes = errorAttributes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且新建一个Web页面错误处理类errorhandler</p>
<p>上面添加注解@RequestMapping（value 接收 定义的Error_path，
并且produces= “text/html“)</p>
<p>Web页面错误处理类errorhandler接收的参数是HttpServerRequest
和HttpServerletResponse</p>
<p>{</p>
<p>​ 获取到response的状态</p>
<p>​ int status = response.getStatus() ​ 然后switch进行判断</p>
<p>​ 并return ”404“到该页面，等等</p>
<p>​ 如果什么都没匹配到，就返回index页面。</p>
<p>}</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4tlyyvi5yj21mp0u0acc.jpg" alt="image-20220803152731553" style="zoom: 33%;" /></p>
<p>因为在方法上面使用的是requestMapping，所以也要在类上面增加@controller注解。</p>
<p>以上定义的是web页面的拦截处理，下面定义api的拦截处理：</p>
<p>除web页面外的错误处理，比如Json/xml等，那么就不需要像web页面拦截器一样声明produces
= "xxx“了，因为是除了web页面以外的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = ERROR_PATH)</span></span><br><span class="line"><span class="comment">//需要返回的是结构体，所以定义@ResponseBody</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="comment">//只需要传入一个request参数即可 参数：HttpServletRequest request</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">errorApiHandler</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">  然后需要定义一个RequestAttributes实例，把类参数传入进去。</span><br><span class="line">	<span class="type">RequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestAttributes</span>(request)</span><br><span class="line">    需要获取到请求返回的状态</span><br><span class="line">    Map&lt;String,Object&gt; attr = <span class="built_in">this</span>.errorAttributes.getErrorAttributes(requestAttributes, 第二个参数是includeStackTrance，取值为<span class="literal">false</span>)</span><br><span class="line">    使用一个map来接收。</span><br><span class="line">    想要获取到状态需要单独写一个函数getStatus（）</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getStatus</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">      <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> (Integer) request.getAttribute(<span class="string">&quot;javax.servlet.error.status_code&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span>(status != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="number">500</span>;</span><br><span class="line">  	&#125;</span><br><span class="line">  </span><br><span class="line">  	然后返回函数中，使用</span><br><span class="line">    <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> getStatus(request);获取到状态。</span><br><span class="line">    获取到状态后，直接使用定义好的ApiResponse.ofMessage(status, 并且在返回信息这里使用getOrDefault方法，			String.valueOf(attr.getOrDefault(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;error&quot;</span>)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果正确请求的话，就会直接进入到controller中对应RequestMapping下的函数中去。</p>
<p>如果错误请求的话，内部会检测到匹配不到的错误请求path，然后在AppErrorController中赋值给ERROR_PATH，然后通过this.errorAttributes.getErrorAttributes(requestAttributes,false);去获取到javax.servlet.error.status_code对应的状态码，以及对应的error_message。最后包装在我们定义好的ApiResponse.ofMessage中去。</p>
</blockquote>
<h2 id="十二功能性页面开发">十二、功能性页面开发</h2>
<h3 id="权限限制性页面">403:权限限制性页面</h3>
<h3 id="not-found-提示页面">404:Not found 提示页面</h3>
<h3 id="异常服务提示页面">500:异常服务提示页面</h3>
<blockquote>
<p>另外，springdevTools是在整个项目进行监听的，如果在开发前端的过程中引发一些热加载其实是没有必要的，因为我们设置了thymeleaf的缓存cache为false，只需要一行配置即可生效，</p>
<p>spirng.devtools.restart.exclude=templates/** ,static/**</p>
</blockquote>
<p>这样对静态资源的修改就不会引发热加载了</p>
<p>当thymeleaf出现乱码的情况下，只需要在templateResolver中进行设置就可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templateResolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这样就解决了thymeleaf前端乱码的问题了。</p>
<h2 id="十三后台管理模块">十三、后台管理模块</h2>
<h3 id="业务与功能分析">业务与功能分析：</h3>
<p>​
为了方便网站运营人员<strong>管理租房网站</strong>的房源信息，就需要有后台管理系统。开发一个后台管理模块来管理租房网站的数据、人员信息等等</p>
<p>首先在webcontroller下面新建一个admin的文件夹，并且新建一个AdminController控制类，新建两个getMapping方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/admin/center&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">adminCenterPage</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;admin/center&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/admin/welcome&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">welcomePage</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;admin/welcome&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且把admin/center页面添加进去。</p>
<h2 id="十四后台登录功能模块实现">十四、后台登录功能模块实现</h2>
<p>在后台管理页面上有一个展示目前登录账户名称，就需要一个登录管理模块，那么就需要查询数据库，就需要用到hibernate，所以需要在WebMvcConfig中SpringTemplateEngine（tyhmeleaf标准方言解释器）中增加支持springSecurity方言。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 支持SpringSecurity方言</span></span><br><span class="line">       <span class="type">SpringSecurityDialect</span> <span class="variable">securityDialect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringSecurityDialect</span>();</span><br><span class="line">       templateEngine.addDialect(securityDialect);</span><br></pre></td></tr></table></figure>
<p>并且在pom.xml中加入web
SpringSecurity依赖和thymeleafSecurity依赖，并且制定thymeleafsecurity依赖的固定版本3.0.2
。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- SpringSecurity 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">&lt;!-- Thymeleaf方言支持SpringSecurity 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;thymeleaf-extras-springsecurity4.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">thymeleaf-extras-springsecurity4.version</span>&gt;</span>3.0.2.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf-extras-springsecurity4.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>并且新建一个类，WebSecurityConfig
继承WebSecurityConfigurerAdapter</p>
<p>并且在类上面添加两个注解：</p>
<p><span class="citation"
data-cites="EnableWebSecurity">@EnableWebSecurity</span></p>
<p><span class="citation"
data-cites="EnableGlobalMethodSecurity">@EnableGlobalMethodSecurity</span></p>
<p>再然后复写一下继承类的方法：configure（接收的参数是HttpSecurity
http）的。</p>
<p>里面就是http权限控制的内容了，比如设置页面的权限、api的角色权限等等。</p>
<p>即增加：</p>
<p>http.authorizeRequests().antMatchers("/admin/login").permitAll();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//资源访问权限</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/login&quot;</span>).permitAll()  <span class="comment">//管理员登录入口</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/static/**&quot;</span>).permitAll()      <span class="comment">//静态资源访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/login&quot;</span>).permitAll()     <span class="comment">//用户登录入口</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasAnyRole(<span class="string">&quot;ADMIN&quot;</span>,<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/user/**&quot;</span>).hasAnyRole(<span class="string">&quot;ADMIN&quot;</span>,<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/admin/center&quot;</span>,<span class="literal">true</span>).permitAll()</span><br><span class="line">                .failureHandler(authFailHandler())</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/logout/page&quot;</span>)</span><br><span class="line">                .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>)</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint(urlEntryPoint())</span><br><span class="line">                <span class="comment">//无权访问的跳转页面</span></span><br><span class="line">                .accessDeniedPage(<span class="string">&quot;/403&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        http.csrf().disable();<span class="comment">//常用的防御策略 关闭</span></span><br><span class="line">        http.headers().frameOptions().sameOrigin(); <span class="comment">//常用的默认开启同源策略</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在我们设置了loginProcessingUrl("/login")后，springSecurity默认的登录界面是这样的：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h4uk1qiza0j20ls09o0sz.jpg" alt="image-20220804110630147" style="zoom:50%;" /></p>
<p>所以我们需要在controller中去配置/admin/login函数并且return
/admin/login</p>
<p>另外我们还需要去关闭两个设置：</p>
<p>http.csrf().disable();
//csrf是一个防御策略，为了方便开发我们这里关闭</p>
<p>http.headers().frameOptions().sameOrigin()。
h-ui是使用iframe开发的，所以我们要设置同源策略。</p>
<p>并在还需要另外设置自定义认证策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义认证策略</span></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configGlobal</span><span class="params">(AuthenticationManagerBuilder auth)</span>&#123;</span><br><span class="line">      <span class="comment">//在最开始的时候可以定义一个基于内存验证的用户名和密码。//以and结尾。</span></span><br><span class="line">      auth.inMemoryAuthentication().withUser(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;admin&quot;</span>).roles(<span class="string">&quot;ADMIN&quot;</span>).and();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>测试admin/login，登录成功之后默认跳转到首页。</p>
<p>但是呢我们的认证数据是从内存中定义的，这里我们需要从数据库中进行替换认证的数据及逻辑。</p>
<p>另外呢需要单独新建一个security的包，负责存放一些关于安全认证的代码。</p>
<p>然后在securiyty包里AuthProvider（自定义认证实现）实现AuthenticationProvider，然后实现两个覆盖类：authenticate和supports。</p>
<p>其中supports我们设置默认返回true，支持所有的权限认证，在authenticate中去实现我们对用户的一些详细的认证。</p>
<p>在athenticate方法中authentication.getName() getCredentials()
去获取用户名和输入的密码。</p>
<p>这时候需要新建一个service包用来存放接口
IUserService，新建一个findUserByName方法，</p>
<p>然后新建一个实现类UserServiceImpl
实现IUserService，然后实现findUserByName方法，并且新建一个UserRepository来查询数据库。</p>
<p>但是UserRepository虽然继承了CrudRepository但是并没有findByName，需要在UserRepository中去定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">CrudRepository</span>&lt;User,Long&gt;&#123;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">findByName</span><span class="params">(String username)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后这时候才可以在UserServiceImpl中使用repository的findByName()</p>
<p>这样的话我们就可以在AuthProvider中使用UserService了，需要@autowired，注入之后就可以使用其从数据库中查出我们的用户名和密码来了。</p>
<p>获取到用户名后，<strong>需要添加一个if判断，如果为null的话直接throw一个</strong>
AuthenticationCredentialsNotFoundException("authError")错误。</p>
<p>然后就可以验证inputPassword和数据库里的密码做比对了/。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.getPassword().equals(inputPassword)</span><br></pre></td></tr></table></figure>
<p>但是这样的话就容易在逻辑代码中暴露用户的密码了，所以要使用md5加密。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Md5PasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Md5PasswordEncoder</span>()</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用md5来对password进行隐藏式的验证</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">this</span>.passwordEncoder.isPasswordValid(user.getPassword(),inputPassword,user.getId()))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user, <span class="literal">null</span>, user.getAuthorities());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if判断条件中输入参数1用户数据库密码，获取到的密码，加盐（这里使用userid进行加盐）</span></span><br><span class="line"><span class="comment">//然后如果通过了就return 一个UsernamePasswordAuthenticationToken（name）这里参入的参数user是有要求的，需要User类去实现UserDetails方法，然后把方法都实现掉。而且return都返回一个true。</span></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Transient</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GrantedAuthority&gt; authorityList;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//并且给User添加一个新的属性：/*jpa会验证这个字段，但是在mysql中并没有这个字段，这个是在security中进行单独设置的，添加这个注解让其透明*/</span></span><br><span class="line"><span class="comment">//另外一个</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authorityList;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//虽然我们在getAuthorities中return了这个authrityList，但是并没有对这个List进行包装。</span></span><br><span class="line"><span class="comment">//所以需要我们新建role 实体类。以及roleRepository。</span></span><br><span class="line"><span class="comment">//并且在UserServiceImpl中通过roleRepository去查询相关的role角色，并且新建一个ArrayList，存放在这个ArrayList中，把这个ArrayList存放在user属性中，最后返回出来，这样我们定义的authorityList属性也填充完毕了。</span></span><br><span class="line"><span class="comment">//特别注意的是这个字段要加一个@Transient注解</span></span><br><span class="line"><span class="comment">//@Transient</span></span><br><span class="line">    <span class="comment">//private List&lt;GrantedAuthority&gt; authorityList;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;authError&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>并且在WebSecurityConfig类的configGlobal()方法中我们之前定义的是在内存中设定一个用户admin/admin</p>
<p>现在因为我们自己设定了一个AuthProvider类，所以呢我们就先建立一个@bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthProvider <span class="title function_">authProvider</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthProvider</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后在configGlobal中auth.authenticationProvider(authProvider()).eraseCredentials(true);
//并且设置擦除密码验证。</p>
<h2 id="十五验证失败逻辑处理">十五、验证失败逻辑处理</h2>
<p>authProvider实现了自定义登录功能。下面实现基于springSecurity的权限控制。</p>
<p>比如说我们要根据不同的请求去做不同的跳转页面控制，比如普通用户登录就跳转到普通用户的登录界面，管理员就跳转到管理员登录的登录页面。</p>
<p>我们新建LoginAuthFailHandler并且继承simpleUrlAuthenticationFailureHandler</p>
<p>并且定义一个属性 ，LoginUrlEntryPoint
用来跳转到需要跳转的url并附带一些其他信息。</p>
<p>并且实现一个覆盖类onAuthenticationFailure</p>
<p>里面方法写this.urlEntryPoint.determineUrlToUseForThisRequest(request,response,exception)，并且返回的是targetUrl。</p>
<p>接下来对我们获取到的targetUrl进行处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">targetUrl += “？” +exception.getMessage()</span><br></pre></td></tr></table></figure>
<p>然后再用父类的一个方法，跳转到targetUrl。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">super</span>.setDefaultFailureUrl(targetUrl);</span><br></pre></td></tr></table></figure>
<p>执行父级的跳转逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">super</span>.onAuthenticationFailure(request,response,exception);</span><br></pre></td></tr></table></figure>
<p>这个时候呢，验证失败处理器LoginAuthFailHandler就配置完成了，但是还要设置另外一个地方，那就是WebSecurityConfig中设置failureHandler（authFailHandler（））</p>
<p>authFailHandler是新建的一个Bean类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> LoginAuthFailHandler <span class="title function_">authFailHandler</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginAuthFailHandler</span>(urlEntryPoint())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="十六房源信息管理模块">十六、房源信息管理模块</h2>
<h3 id="业务与功能分析-1">业务与功能分析：</h3>
<p>​
已经搭建了后台管理模块的框架，另外还需要完善网站的房源信息管理子模块，那么接下来就要实现房源信息的增删改查。</p>
<h3 id="实现目标">实现目标：</h3>
<ul>
<li>​ 新增房源</li>
<li>​ 房源信息管理（查、改、删）</li>
<li>​ 房源审核（一些完善性的工作）</li>
</ul>
<h2
id="十七基于七牛云的图片上传上传到本地">十七、基于七牛云的图片上传（上传到本地）</h2>
<p>图片上传功能：</p>
<ul>
<li>​ 上传到本地</li>
<li>​ 上传到七牛云</li>
</ul>
<p>七牛依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.qiniu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifacId</span>&gt;</span>qiniu-java-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>[7.2.0, 7.2.99]<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>前端使用的是百度开源的webuploader。</p>
<p>后段需要在AdminController中定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;admin/upload/photo&quot;, consumes = MediaType.MULTIPART_FROM_DATA_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">uploadPhoto</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ApiResponse.ofSuccess(<span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>另外新建一个文件上传配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;Servlet.class, StandardServletMultipartResolver.class, MultipartConfigElement.class&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.http.multipart&quot;, name = &quot;enabled&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(MultipartProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebFileUploadConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外呢还要去properties类中设置mutipartProperties multipart config</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.http.multipart.enabled=<span class="literal">true</span></span><br><span class="line">spring.http.multipart.location=/Users/zhiqiang/Downloads/zq/有趣的项目/soufang-test/tmp</span><br><span class="line">spring.http.multipart.file-size-threshold=5MB</span><br><span class="line">spring.http.multipart.max-file-size=20MB</span><br></pre></td></tr></table></figure>
<p>然后继续完善类里面的配置，因为我们让springboot自动配置了MultipartProperties.class类，所以我们要定义一个MultipartProperties
变量。</p>
<p>然后新建一个WebFileUploadConfig类去注入这个属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MultipartProperties multipartProperties;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WebFileUploadConfig</span><span class="params">(MultipartProperties multipartProperties, MultipartProperties multipartProperties1)</span>&#123;</span><br><span class="line">      <span class="built_in">this</span>.multipartProperties = multipartProperties;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>另外还需要创建一个上传配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> MultipartConfigElement <span class="title function_">multipartConfigElement</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.multipartProperties.createMultipartConfig();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外还需要创建一个注册解析器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 注册解析器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(MultipartResolver.class)</span></span><br><span class="line">   <span class="keyword">public</span> StandardServletMultipartResolver <span class="title function_">multipartResolver</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="type">StandardServletMultipartResolver</span> <span class="variable">multipartResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardServletMultipartResolver</span>();</span><br><span class="line">       multipartResolver.setResolveLazily(<span class="built_in">this</span>.multipartProperties.isResolveLazily());</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> multipartResolver;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>创建完毕后需要再完善一下webUpload的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;admin/upload/photo&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="keyword">public</span> ApiResponse <span class="title function_">uploadPhoto</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (file.isEmpty())&#123;</span><br><span class="line">           <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">       <span class="type">File</span> <span class="variable">target</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/zhiqiang/Downloads/zq/tmp/&quot;</span> +fileName);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           file.transferTo(target);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">           <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.INTERNAL_SERVER_ERROR);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> ApiResponse.ofSuccess(<span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这样图片上传就到了我们的本地/Users/zhiqiang/Downloads/zq/tmp/了。</p>
<h2
id="十八基于七牛云的图片上传上传到七牛云">十八、基于七牛云的图片上传（上传到七牛云）</h2>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h51nur7z9yj20m30ld769.jpg" alt="image-20220810143709446"  /></p>
<p>配置七牛云服务器直传，需要设置一个Bean类去配置qiniuConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 为七牛云配置华东机房zone0</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> com.qiniu.storage.Configuration <span class="title function_">qiniuConfig</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">com</span>.qiniu.storage.Configuration(Zone.zone1());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>并且设置一个七牛云上传工具管理类，把上面设置的配置类当作参数传入进去。</p>
<p>另外七牛云还需要配置AccessKey， SecretKey和Bucket</p>
<p>另外，七牛云新建对象存储后会有30天的临时测试域名。</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h51p89puj6j215w0cm0ts.jpg"
alt="image-20220810152446672" />
<figcaption aria-hidden="true">image-20220810152446672</figcaption>
</figure>
<p>并且在properties文件中定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># qiniu config</span><br><span class="line">qiniu.AccessKey=FQ_nf-hE1Bu7ZE-ffCgkSxQnbUGXhBGgT0UVwP-J</span><br><span class="line">qiniu.SecretKey=mPHwqW5mYIp3Wgdj2vFvWAATN8NBgwVo0rHduz44</span><br><span class="line">qiniu.Bucket=soufang-zryy</span><br><span class="line">qiniu.cdn.prefix=http:<span class="comment">//rge19896q.hb-bkt.clouddn.com/</span></span><br></pre></td></tr></table></figure>
<p>然后在WebFileUploadConfig文件中以注解的方式注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;qiniu.AccessKey&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String accessKey;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;qiniu.SecretKey&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String secretKey;</span><br></pre></td></tr></table></figure>
<p>然后利用这两个变量来生成认证信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证信息实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Auth <span class="title function_">auth</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Auth.create(accessKey,secretKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且构建七牛云空间管理实例，把认证类auth当作参数传入，并且把qiniuConfig传入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建七牛空间管理实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> BucketManager <span class="title function_">bucketManager</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BucketManager</span>(auth(),qiniuConfig());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样配置文件弄好了，就可以去设计业务了。从设计业务角度来讲，从顶层由上自下设计是合适的。从开发流程来说，从数据库建表开始进行开始是最为合适的。</p>
<p>新建IQiNiuService接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span>  <span class="title class_">IQiNiuService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件形式上传</span></span><br><span class="line">    Response <span class="title function_">uploadFile</span><span class="params">(File file)</span> <span class="keyword">throws</span> QiniuException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件流形式上传</span></span><br><span class="line">    Response <span class="title function_">uploadFile</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> QiniuException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除文件</span></span><br><span class="line">    Response <span class="title function_">delete</span><span class="params">(String key)</span> <span class="keyword">throws</span> QiniuException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后新建QiNiuServiceImpl实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QiNiuServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IQiNiuService</span>, InitializingBean &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UploadManager uploadManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BucketManager bucketManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Auth auth;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;qiniu.Bucket&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringMap putPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">uploadFile</span><span class="params">(File file)</span> <span class="keyword">throws</span> QiniuException &#123;</span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span>  <span class="operator">=</span> <span class="built_in">this</span>.uploadManager.put(file,<span class="literal">null</span>,getUploadToken());</span><br><span class="line">        <span class="type">int</span> <span class="variable">retry</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(response.needRetry() &amp;&amp; retry &lt; <span class="number">3</span>)&#123;</span><br><span class="line">            response  = <span class="built_in">this</span>.uploadManager.put(file,<span class="literal">null</span>,getUploadToken());</span><br><span class="line">            retry++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">uploadFile</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> QiniuException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">delete</span><span class="params">(String key)</span> <span class="keyword">throws</span> QiniuException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">this</span>.putPolicy = <span class="keyword">new</span> <span class="title class_">StringMap</span>();</span><br><span class="line">        putPolicy.put(<span class="string">&quot;returnBody&quot;</span>, <span class="string">&quot;&#123;\&quot;key\&quot;:\&quot;$(key)\&quot;,\&quot;hash\&quot;:\&quot;$(etag)\&quot;,\&quot;bucket\&quot;:\&quot;$(bucket)\&quot;,\&quot;width\&quot;:$(imageInfo.width), \&quot;height\&quot;:$&#123;imageInfo.height&#125;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取上传凭证</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getUploadToken</span><span class="params">()</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">this</span>.auth.uploadToken(bucket,<span class="literal">null</span>,<span class="number">3600</span>, putPolicy);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中自动配置@Autowired upLoadManager类，</p>
<p>uploadManager.put传的参数是file、null、以及return
this.auth.uploadToken(bucket,null,3600, putPolicy);</p>
<p>其中InitializingBean、afterPropertiesSet当一个类实现这个接口之后，Spring启动后，初始化Bean时，若该Bean实现InitialzingBean接口，会自动调用afterPropertiesSet()方法，完成一些用户自定义的初始化操作。</p>
<p>putPolicy是七牛云固定的returnBody的格式。</p>
<p>最后我们建立一个测试类并且继承之前定义好的SoufangtestApplicationTests</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QiNiuServiceTests</span> <span class="keyword">extends</span> <span class="title class_">SoufangTestApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IQiNiuService qiNiuService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUploadFile</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;/Users/zhiqiang/Downloads/zq/tmp/664328b2a21a76bd8de7c629eeff7e.jpg&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileName);</span><br><span class="line">        Assert.assertTrue(file.exists());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> qiNiuService.uploadFile(file);</span><br><span class="line">            Assert.assertTrue(response.isOK());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (QiniuException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试通过，成功上传到七牛云上面。</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h52sr9r1c0j21gg0u0wia.jpg"
alt="image-20220811141223495" />
<figcaption aria-hidden="true">image-20220811141223495</figcaption>
</figure>
<blockquote>
<p>另外除了uploadFile外，我们还定义了uploadInputStream。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;admin/upload/photo&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">uploadPhoto</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> file.getInputStream();</span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> iQiNiuService.uploadFile(inputStream);</span><br><span class="line">        <span class="keyword">if</span> (response.isOK())&#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofSuccess();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofMessage(response.statusCode,response.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.INTERNAL_SERVER_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过在return
ApiResponse.ofSuccess的时候，需要定义一个dto来接收，这时候新建一个QiNiuPutRet类，并且定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">QiNiuPutRet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String key;</span><br><span class="line">    <span class="keyword">public</span> String hash;</span><br><span class="line">    <span class="keyword">public</span> String bucket;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> width;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> height;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;QiNiuPutRet&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;key=&#x27;&quot;</span> + key + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, hash=&#x27;&quot;</span> + hash + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, bucket=&#x27;&quot;</span> + bucket + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, width=&quot;</span> + width +</span><br><span class="line">                <span class="string">&quot;, height=&quot;</span> + height +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而且在WebFileUploadConfig类中定义一个Gson解析json</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Gson <span class="title function_">gson</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样呢，就可以在controller中去自动注入Gson了</p>
<p>AdminController ————》</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Gson gson;</span><br><span class="line"></span><br><span class="line">gson.fromJson(response.bodyString(), QiNiuPutRet.class);</span><br></pre></td></tr></table></figure>
<p>gson.fromJson需要输入两个参数一个是string类型的json数据，另外一个是对应变量的类。所以需要定义一个dto类QiNiuPutRet.class</p>
<p>另外呢还需要定义一个catch去抓取QiNiu的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> file.getInputStream();</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> iQiNiuService.uploadFile(inputStream);</span><br><span class="line">    <span class="keyword">if</span> (response.isOK())&#123;</span><br><span class="line">        <span class="type">QiNiuPutRet</span> <span class="variable">ret</span> <span class="operator">=</span> gson.fromJson(response.bodyString(), QiNiuPutRet.class);</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(ret);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofMessage(response.statusCode,response.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (QiniuException e)&#123;</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> e.response; </span><br><span class="line">    <span class="keyword">return</span> ApiResponse.ofMessage(response.statusCode,response.bodyString());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.INTERNAL_SERVER_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们编写完以文件流方式上传图片后，获取到了文件的key：FnJXb0TSb-ImeX1PzxIRo9wc1AkX</p>
<p>然后我们就去实现delete操作：</p>
<p>但是这里需要注意的是delete是操作的BucketManager，而上传使用的是uploadManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">delete</span><span class="params">(String key)</span> <span class="keyword">throws</span> QiniuException &#123;</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> bucketManager.delete(<span class="built_in">this</span>.bucket, key);</span><br><span class="line">    <span class="type">int</span> <span class="variable">retry</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (response.needRetry() &amp;&amp; retry++ &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        response = bucketManager.delete(bucket, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后编辑测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteFile</span><span class="params">()</span> <span class="keyword">throws</span> QiniuException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;FnJXb0TSb-ImeX1PzxIRo9wc1AkX&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Response</span> <span class="variable">delete</span> <span class="operator">=</span> qiNiuService.delete(key);</span><br><span class="line">        Assert.assertTrue(delete.isOK());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (QiniuException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的QiNiuServiceImpl类的实现代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QiNiuServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IQiNiuService</span>, InitializingBean &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UploadManager uploadManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BucketManager bucketManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Auth auth;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;qiniu.Bucket&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringMap putPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">uploadFile</span><span class="params">(File file)</span> <span class="keyword">throws</span> QiniuException &#123;</span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span>  <span class="operator">=</span> <span class="built_in">this</span>.uploadManager.put(file,<span class="literal">null</span>,getUploadToken());</span><br><span class="line">        <span class="type">int</span> <span class="variable">retry</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(response.needRetry() &amp;&amp; retry &lt; <span class="number">3</span>)&#123;</span><br><span class="line">            response  = <span class="built_in">this</span>.uploadManager.put(file,<span class="literal">null</span>,getUploadToken());</span><br><span class="line">            retry++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">uploadFile</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> QiniuException &#123;</span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span>  <span class="operator">=</span> <span class="built_in">this</span>.uploadManager.put(inputStream,<span class="literal">null</span>,getUploadToken(),<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">retry</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(response.needRetry() &amp;&amp; retry &lt; <span class="number">3</span>)&#123;</span><br><span class="line">            response  = <span class="built_in">this</span>.uploadManager.put(inputStream,<span class="literal">null</span>,getUploadToken(),<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">            retry++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">delete</span><span class="params">(String key)</span> <span class="keyword">throws</span> QiniuException &#123;</span><br><span class="line">        <span class="type">Response</span> <span class="variable">deleteResponse</span> <span class="operator">=</span> bucketManager.delete(<span class="built_in">this</span>.bucket, key);</span><br><span class="line">        <span class="type">int</span> <span class="variable">retry</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(deleteResponse.needRetry() &amp;&amp; retry++ &lt;<span class="number">3</span> )&#123;</span><br><span class="line">            deleteResponse = bucketManager.delete(bucket,key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deleteResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">this</span>.putPolicy = <span class="keyword">new</span> <span class="title class_">StringMap</span>();</span><br><span class="line">        putPolicy.put(<span class="string">&quot;returnBody&quot;</span>, <span class="string">&quot;&#123;\&quot;key\&quot;:\&quot;$(key)\&quot;,\&quot;hash\&quot;:\&quot;$(etag)\&quot;,\&quot;bucket\&quot;:\&quot;$(bucket)\&quot;,\&quot;width\&quot;:$(imageInfo.width), \&quot;height\&quot;:$&#123;imageInfo.height&#125;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取上传凭证</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getUploadToken</span><span class="params">()</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">this</span>.auth.uploadToken(bucket,<span class="literal">null</span>,<span class="number">3600</span>, putPolicy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="十九新增房源信息功能1">十九、新增房源信息功能(1)</h2>
<p>在新增房源这里我们设定了支持城市下拉的选择：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h53qpzhcenj218u0emabu.jpg"
alt="image-20220812094729522" />
<figcaption aria-hidden="true">image-20220812094729522</figcaption>
</figure>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h53qqn8xc5j21z20luwgu.jpg"
alt="image-20220812094810146" />
<figcaption aria-hidden="true">image-20220812094810146</figcaption>
</figure>
<p>我们从下到上开始创建：</p>
<p>新建一个controller类。HouseController</p>
<p>并且新建实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;support_address&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SupportAddress</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//上一级行政单位</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;belong_to&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String belongTo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//英文名称</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;en_name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String enName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//中文名称</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;cn_name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String cnName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//行政级别</span></span><br><span class="line">    <span class="keyword">private</span> String level;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBelongTo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> belongTo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBelongTo</span><span class="params">(String belongTo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.belongTo = belongTo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnName</span><span class="params">(String enName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enName = enName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCnName</span><span class="params">(String cnName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cnName = cnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLevel</span><span class="params">(String level)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 行政级别定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Level</span>&#123;</span><br><span class="line">        CITY(<span class="string">&quot;city&quot;</span>),</span><br><span class="line">        REGION(<span class="string">&quot;region&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造函数</span></span><br><span class="line">        Level(String value)&#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getvalue</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Level <span class="title function_">of</span><span class="params">(String value)</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (Level level : Level.values()) &#123;</span><br><span class="line">                <span class="keyword">if</span>(level.getvalue().equals(value))&#123;</span><br><span class="line">                    <span class="keyword">return</span> level;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外呢，要新建Repository接口SupportAddressRepository去继承CrudRepository&lt;SupportAddress,Long&gt;</p>
<p>第一个参数是实体类，第二个参数是id的类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SupportAddressRepository</span> <span class="keyword">extends</span> <span class="title class_">CrudRepository</span>&lt;SupportAddress,Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们去定义controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/cities&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportCities</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然我们定义了support/cities路径所以我们的dao就需要一个获取所有城市列表的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SupportAddressRepository</span> <span class="keyword">extends</span> <span class="title class_">CrudRepository</span>&lt;SupportAddress,Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有对应行政级别的信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SupportAddress&gt; <span class="title function_">findAllByLevel</span><span class="params">(String level)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再去定义service层：</p>
<p>新建IAddressService接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IAddressService</span>()&#123;</span><br><span class="line">	List&lt;SupportAddress&gt; <span class="title function_">findAllCities</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>虽然我们可以这样定义接口，
但是不建议，我们的dao和返回的dto（也就是传输到前端的类型）尽量要有一个数据的隔阂。也就是对数据进行保护，并不是所有的数据都可以被前端获取到。所以我们要定义一个中间的转换对象，所以我们新建一个新的类型SupportAddressDTO</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SupportAddressDTO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(value = &quot;belong_to&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String belongTo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(value = &quot;en_name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String enName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(value = &quot;cn_name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String cnName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String level;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBelongTo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> belongTo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBelongTo</span><span class="params">(String belongTo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.belongTo = belongTo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnName</span><span class="params">(String enName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enName = enName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCnName</span><span class="params">(String cnName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cnName = cnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLevel</span><span class="params">(String level)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这样呢我们就需要在IAddressService这里去修改返回list的类型了，由SupportAddress转换成了SupportAddressDTO：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IAddressService</span>()&#123;</span><br><span class="line">	List&lt;SupportAddressDTO&gt; <span class="title function_">findAllCities</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后新建一个service实现类，AddressServiceImpl
实现IAddressService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;SupportAddressDTO&gt; <span class="title function_">findAllCities</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;SupportAddress&gt; addresses = supportAddressRepository.findAllByLevel(SupportAddress.Level.CITY.getValue());</span><br><span class="line">    List&lt;SupportAddressDTO&gt; addressDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (SupportAddress supportAddress : addresses) &#123;</span><br><span class="line">        <span class="type">SupportAddressDTO</span> <span class="variable">target</span> <span class="operator">=</span> modelMapper.map(supportAddress, SupportAddressDTO.class);</span><br><span class="line">        addressDTOS.add(target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(addressDTOS.size(), addressDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​ 在上面的函数中
我们使supportAddressRepository去查询所有的地址后，返回了supportAddress的list，然后新建了一个List<SupportAddressDTO>的列表，进行for循环，然后通过建立的modelMapper进行映射。</p>
<p>​
在我们对SupportAddress类型转换为SupportAddressDto类型的时候在webMvcConfig中定义了一个Bean
Util，modelMapper是一个复制bean的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bean Util</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ModelMapper <span class="title function_">modelMapper</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelMapper</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样呢我们就存在一个问题，虽然这样我们虽然返回了一个List列表（findAllCities函数中），</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;SupportAddressDTO&gt; <span class="title function_">findAllCities</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>但是其他接口也有返回一个supportAddress列表呢？比如说分页，所以说我们要定义这个返回的列表，设置所有的返回都有一个list，同时呢还要有一个表示数据总集的字段（result），下面去定义一个通用的结构：</p>
<p>ServiceMultiResult</p>
<p>我们定义了total、List<T> result
、以及getResultSize方法作为该类的返回结构。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用多结果Service返回结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceMultiResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> total;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceMultiResult</span><span class="params">(<span class="type">long</span> total, List&lt;T&gt; result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.total = total;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTotal</span><span class="params">(<span class="type">long</span> total)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.total = total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">getResult</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResult</span><span class="params">(List&lt;T&gt; result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getResultSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.result == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.result.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样呢我们在AddressServiceImpl中定义的返回就不用List了，而是使用我们自己定义好的ServiceMultiResult了。</p>
<p>修改前：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;SupportAddressDTO&gt; <span class="title function_">findAllCities</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>修改后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;SupportAddressDTO&gt; <span class="title function_">findAllCities</span><span class="params">()</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//省略具体操作</span></span><br><span class="line">  </span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(addressDTO.size(), addressDTOS)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面传递的两个参数是因为我们定义的ServiceMultiResult需要传入两个类变量，而第二个变量需要传入的是一个List<T>类型。</p>
<p>在设计完service层后，我们去定义controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IAddressService addressService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/cities&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportCities</span><span class="params">()</span>&#123;</span><br><span class="line">        ServiceMultiResult&lt;SupportAddressDTO&gt; result = addressService.findAllCities();</span><br><span class="line">        <span class="keyword">if</span> (result.getResultSize() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofSuccess(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(result.getResult());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h57jnatbypj20th0eignw.jpg"
alt="image-20220815164459062" />
<figcaption aria-hidden="true">image-20220815164459062</figcaption>
</figure>
<p>在查询的时候，我们是根据ByLevel进行查询的，传递的是定义好的Enum类型SupportAddress.Level.CITY来进行条件检索的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;SupportAddress&gt; addresses = supportAddressRepository.findAllByLevel(SupportAddress.Level.CITY.getValue());</span><br></pre></td></tr></table></figure>
<blockquote>
<p>另外还有区县、地铁站、地铁线路的接口实现，这里不做过多说明，只列举相关代码。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IAddressService addressService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取支持城市列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/cities&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportCities</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceMultiResult&lt;SupportAddressDTO&gt; result = addressService.findAllCities();</span><br><span class="line">        <span class="keyword">if</span> (result.getResultSize() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofSuccess(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(result.getResult());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对应城市支持区域列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cityEnName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/regions&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportRegions</span><span class="params">(<span class="meta">@RequestParam(name = &quot;city_name&quot;)</span> String cityEnName)</span> &#123;</span><br><span class="line">        ServiceMultiResult&lt;SupportAddressDTO&gt; addressResult = addressService.findAllRegionsByCityName(cityEnName);</span><br><span class="line">        <span class="keyword">if</span> (addressResult.getResult() == <span class="literal">null</span> || addressResult.getTotal() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(addressResult.getResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取具体城市所支持的地铁线路</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cityEnName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/subway/line&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportSubwayLine</span><span class="params">(<span class="meta">@RequestParam(name = &quot;city_name&quot;)</span> String cityEnName)</span> &#123;</span><br><span class="line">        List&lt;SubwayDTO&gt; subways = addressService.findAllSubwayByCity(cityEnName);</span><br><span class="line">        <span class="keyword">if</span> (subways.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(subways);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对应地铁线路所支持的地铁站点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subwayId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/subway/station&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportSubwayStation</span><span class="params">(<span class="meta">@RequestParam(name = &quot;subway_id&quot;)</span> Long subwayId)</span> &#123;</span><br><span class="line">        List&lt;SubwayStationDTO&gt; stationDTOS = addressService.findAllStationBySubway(subwayId);</span><br><span class="line">        <span class="keyword">if</span> (stationDTOS.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(stationDTOS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从总体上来说，关于其他（地铁站、地铁线等等）的查询以及展示都是类似思想，无非就是通过前端联结查询，当选择城市的时候，会传递城市名称并请求地铁站api，然后再前端并联渲染出来，不过需要注意的地方是我们定义了DTO类，并非原来的Entity实体类直接返回出来，而是定义了其他的一些的返回类，并非原来的List，定义了其他的一些返回类定义了一些关于ResultSize等等之类的信息，非常方便获取。</p>
</blockquote>
<h2 id="二十新增房源信息功能2">二十、新增房源信息功能(2)</h2>
<p>我们新建了实体类：</p>
<p>​ House</p>
<p>​ HouseDetail</p>
<p>​ HousePicture</p>
<p>​ HouseSubscribe</p>
<p>​ HouseTag</p>
<p>然后我们新建新的HouseRepository、HouseDetailRepository、HousePictureRepository、HouseTagRepository</p>
<p>Repository创建完了，我们新建一个IService接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IHouseService</span> &#123;</span><br><span class="line">	save()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Service接口中我们去定义一个save房源类，可是它返回什么类型呢？</p>
<p>我们考虑像之前定义的ServiceMultiResult类一样，去定义这个返回类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务接口通用结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success, String message, T result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccess</span><span class="params">(<span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getResult</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResult</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样定义完返回的类类型后，重新去service中去设置save方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IHouseService</span> &#123;</span><br><span class="line">    ServiceResult&lt;&gt; save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，ServiceResult我们定义的是一个范型类T，直接设置成House
Entity的话就会暴露，所以我们需要重新去定义一个HouseDTO类，并且附带定义了HostDetailDTO类、HousePictrueDTO类。</p>
<p>这样呢service中的save方法就可以设置了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IHouseService</span> &#123;</span><br><span class="line">    ServiceResult&lt;HouseDTO&gt; <span class="title function_">save</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这里save方法接收的参数类是什么？实质上是前端页面传过来的form表单，这里我们也重新定义一个类去接收这个表单一一对应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseForm</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;大标题不允许为空!&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 30, message = &quot;标题长度必须在1~30之间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须选中一个城市&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 1, message = &quot;非法的城市&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String cityEnName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须选中一个地区&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 1, message = &quot;非法的地区&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String regionEnName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写街道&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 1, message = &quot;非法的街道&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String street;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写小区&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String district;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;详细地址不允许为空!&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 30, message = &quot;详细地址长度必须在1~30之间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String detailAddress;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写卧室数量&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1, message = &quot;非法的卧室数量&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer room;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> parlour;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写所属楼层&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer floor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写总楼层&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalFloor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写房屋朝向&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer direction;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写建筑起始时间&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1900, message = &quot;非法的建筑起始时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer buildYear;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写面积&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1)</span></span><br><span class="line">    <span class="keyword">private</span> Integer area;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须填写租赁价格&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1)</span></span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;必须选中一个租赁方式&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 0)</span></span><br><span class="line">    <span class="meta">@Max(value = 1)</span></span><br><span class="line">    <span class="keyword">private</span> Integer rentWay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long subwayLineId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long subwayStationId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">distanceToSubway</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String layoutDesc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String roundService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String traffic;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Size(max = 255)</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cover;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; tags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;PhotoForm&gt; photos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTitle</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCityEnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cityEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCityEnName</span><span class="params">(String cityEnName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cityEnName = cityEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRegionEnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> regionEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRegionEnName</span><span class="params">(String regionEnName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.regionEnName = regionEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStreet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> street;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStreet</span><span class="params">(String street)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.street = street;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDistrict</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> district;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDistrict</span><span class="params">(String district)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.district = district;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDetailAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> detailAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDetailAddress</span><span class="params">(String detailAddress)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.detailAddress = detailAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getRoom</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> room;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoom</span><span class="params">(Integer room)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.room = room;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getParlour</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parlour;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParlour</span><span class="params">(<span class="type">int</span> parlour)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.parlour = parlour;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getFloor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> floor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFloor</span><span class="params">(Integer floor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.floor = floor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getTotalFloor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> totalFloor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTotalFloor</span><span class="params">(Integer totalFloor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.totalFloor = totalFloor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getDirection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> direction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDirection</span><span class="params">(Integer direction)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.direction = direction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getBuildYear</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buildYear;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBuildYear</span><span class="params">(Integer buildYear)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.buildYear = buildYear;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getArea</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> area;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setArea</span><span class="params">(Integer area)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.area = area;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrice</span><span class="params">(Integer price)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getRentWay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rentWay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRentWay</span><span class="params">(Integer rentWay)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rentWay = rentWay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getSubwayLineId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> subwayLineId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSubwayLineId</span><span class="params">(Long subwayLineId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subwayLineId = subwayLineId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getSubwayStationId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> subwayStationId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSubwayStationId</span><span class="params">(Long subwayStationId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subwayStationId = subwayStationId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDistanceToSubway</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> distanceToSubway;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDistanceToSubway</span><span class="params">(<span class="type">int</span> distanceToSubway)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.distanceToSubway = distanceToSubway;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLayoutDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> layoutDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLayoutDesc</span><span class="params">(String layoutDesc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.layoutDesc = layoutDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRoundService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> roundService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoundService</span><span class="params">(String roundService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roundService = roundService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTraffic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> traffic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTraffic</span><span class="params">(String traffic)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.traffic = traffic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDescription</span><span class="params">(String description)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCover</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cover;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCover</span><span class="params">(String cover)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cover = cover;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getTags</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTags</span><span class="params">(List&lt;String&gt; tags)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tags = tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;PhotoForm&gt; <span class="title function_">getPhotos</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> photos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPhotos</span><span class="params">(List&lt;PhotoForm&gt; photos)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.photos = photos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HouseForm&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, title=&#x27;&quot;</span> + title + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, cityEnName=&#x27;&quot;</span> + cityEnName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, regionEnName=&#x27;&quot;</span> + regionEnName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, district=&#x27;&quot;</span> + district + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, detailAddress=&#x27;&quot;</span> + detailAddress + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, room=&quot;</span> + room +</span><br><span class="line">                <span class="string">&quot;, parlour=&quot;</span> + parlour +</span><br><span class="line">                <span class="string">&quot;, floor=&quot;</span> + floor +</span><br><span class="line">                <span class="string">&quot;, totalFloor=&quot;</span> + totalFloor +</span><br><span class="line">                <span class="string">&quot;, direction=&quot;</span> + direction +</span><br><span class="line">                <span class="string">&quot;, buildYear=&quot;</span> + buildYear +</span><br><span class="line">                <span class="string">&quot;, area=&quot;</span> + area +</span><br><span class="line">                <span class="string">&quot;, price=&quot;</span> + price +</span><br><span class="line">                <span class="string">&quot;, rentWay=&quot;</span> + rentWay +</span><br><span class="line">                <span class="string">&quot;, subwayLineId=&quot;</span> + subwayLineId +</span><br><span class="line">                <span class="string">&quot;, subwayStationId=&quot;</span> + subwayStationId +</span><br><span class="line">                <span class="string">&quot;, distanceToSubway=&quot;</span> + distanceToSubway +</span><br><span class="line">                <span class="string">&quot;, layoutDesc=&#x27;&quot;</span> + layoutDesc + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, roundService=&#x27;&quot;</span> + roundService + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, traffic=&#x27;&quot;</span> + traffic + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, description=&#x27;&quot;</span> + description + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, cover=&#x27;&quot;</span> + cover + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, photos=&quot;</span> + photos +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在就变成了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IHouseService</span> &#123;</span><br><span class="line">    ServiceResult&lt;HouseDTO&gt; <span class="title function_">save</span><span class="params">(HouseForm)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>service编写完毕后，房源信息的添加应该是在admin下，所以我们在adminController下编写controller类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;admin/add/house&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">addHouse</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@ModelAttribute(&quot;form-house-add&quot;)</span> HouseForm houseForm, BindingResult bindingResult)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bindingResult.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(HttpStatus.BAD_REQUEST.value(),bindingResult.getAllErrors().get(<span class="number">0</span>).getDefaultMessage(),<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(houseForm.getPhotos() ==<span class="literal">null</span> || houseForm.getCover() ==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofMessage(HttpStatus.BAD_REQUEST.value(), <span class="string">&quot;必须上传图片&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  	<span class="comment">//对传入的地址表单进行校验</span></span><br><span class="line">    Map&lt;SupportAddress.Level, SupportAddressDTO&gt; cityAndRegionMap = addressService.findCityAndRegion(houseForm.getCityEnName(), houseForm.getRegionEnName());</span><br><span class="line">    <span class="keyword">if</span>(cityAndRegionMap.keySet().size() != <span class="number">2</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="comment">//HouseService的处理</span></span><br><span class="line">  <span class="comment">//对定义的houseForm进行操作</span></span><br><span class="line">        ServiceResult&lt;HouseDTO&gt; result = houseService.save(houseForm);</span><br><span class="line">        <span class="keyword">if</span>(result.isSuccess())&#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofSuccess(result.getResult());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们接口的参数名称是form-house-add，并使用ModelAttribute注解来使用，另外使用@Valid来自动的对表单进行验证。</p>
<p><strong>另外我们定义了一个BindingResult类：作用：用于对前端穿进来的参数进行校验，省去了大量的逻辑判断操作，一开始传入的参数没有使用@Validated
修饰，结果绑定不起作用，参数校验不成功，加上此注解即可生效。
所以BingdingResult是要与@Validated同时使用的。</strong></p>
<p>bindingResult类如果entity类校验错误的话，错误信息就会绑定到bindingResult类上面去。</p>
<blockquote>
<p>关于bindingResult的详细内容需要后期补充</p>
</blockquote>
<p>另外在编辑完毕对传入的地址表单进行验证后（使用的是IAddressService）</p>
<p>我们之前在上面定义的IHouseService，虽然没有定义HouseServiceImpl但是我们是面向接口编程，所以我们先假设使用HouseService执行。</p>
<p>然后我们编辑了对定义的houseForm进行操作后，开始实现IHouseSevice的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.第一步 定义一个House实体类</span></span><br><span class="line"><span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">House</span>();</span><br><span class="line">house.setParlour(houseForm.getParlour());</span><br></pre></td></tr></table></figure>
<p>当然这里我们可以去设置house.set( houseForm.getXXXX)</p>
<p>不过如果我们有很多个变量的话这样写就会变的很麻烦很繁琐。</p>
<p><strong>这样可以直接使用我们之前用过的ModelMapper映射过去。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modelMapper.map(houseForm, house);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//另外还需要创建一些其他的变量</span></span><br><span class="line"><span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">house.setCreateTime(now);</span><br><span class="line">house.setLastUpdateTime(now);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置当前登陆用户的id</span></span><br><span class="line">house.setAdminId(LoginUserUtil.getUserId());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">houseRepository.save(house);</span><br><span class="line"><span class="type">HouseDetail</span> <span class="variable">houseDetail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HouseDetail</span>();</span><br><span class="line"></span><br><span class="line">ServiceResult&lt;HouseDTO&gt; subwayValidtionResult = wrapperSubwayDetailInfo(houseDetail, houseForm);</span><br></pre></td></tr></table></figure>
<p>另外呢不只是house的信息，还有houseDetail的信息需要（围绕houseDetail做一些属性的设置，将地铁以及地铁站的信息设置进去。），所以我们定义了一个W
rapperSubwayDetailInfo类去得到关于地铁的一些信息设置成houseDetail的一些属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 围绕houseDetail做一些属性的设置，将地铁以及地铁站的信息设置进去。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> houseDetail</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> houseForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ServiceResult&lt;HouseDTO&gt; <span class="title function_">wrapperSubwayDetailInfo</span><span class="params">(HouseDetail houseDetail, HouseForm houseForm)</span>&#123;</span><br><span class="line">    <span class="type">Subway</span> <span class="variable">subwayInfo</span> <span class="operator">=</span> subwayRepository.findOne(houseForm.getSubwayLineId());</span><br><span class="line">    <span class="keyword">if</span> (subwayInfo == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">false</span>,<span class="string">&quot;Not valid subway line!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubwayStation</span> <span class="variable">subwayStationInfo</span> <span class="operator">=</span> subwayStationRepository.findOne(houseForm.getSubwayStationId());</span><br><span class="line">    <span class="keyword">if</span>(subwayStationInfo == <span class="literal">null</span> || subwayInfo.getId() != subwayStationInfo.getSubwayId())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">false</span>,<span class="string">&quot;Not valid subway staition&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    houseDetail.setSubwayLineId(subwayInfo.getId());</span><br><span class="line">    houseDetail.setSubwayLineName(subwayInfo.getName());</span><br><span class="line"></span><br><span class="line">    houseDetail.setSubwayStationId(subwayStationInfo.getSubwayId());</span><br><span class="line">    houseDetail.setSubwayStationName(subwayStationInfo.getName());</span><br><span class="line"></span><br><span class="line">    houseDetail.setDescription(houseForm.getDescription());</span><br><span class="line">    houseDetail.setDetailAddress(houseForm.getDetailAddress());</span><br><span class="line">    houseDetail.setLayoutDesc(houseForm.getLayoutDesc());</span><br><span class="line">    houseDetail.setRentWay(houseForm.getRentWay());</span><br><span class="line">    houseDetail.setRoundService(houseForm.getRoundService());</span><br><span class="line">    houseDetail.setTraffic(houseDetail.getTraffic());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面虽然返回了null，但是houseDetail的属性是添加进去了的。</p>
</blockquote>
<p>然后houseDetail.setHouseId(house.getId())</p>
<p>使用houseDetailRepository存储到数据库。</p>
<p>接下来就是housePictrue的实现包装类generatePictures了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;HousePicture&gt; <span class="title function_">generatePictures</span><span class="params">(HouseForm houseForm, Long houseId)</span>&#123;</span><br><span class="line">    List&lt;HousePicture&gt; pictures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(houseForm.getPhotos() ==<span class="literal">null</span> || houseForm.getPhotos().isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> pictures;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (PhotoForm photo : houseForm.getPhotos()) &#123;</span><br><span class="line">        <span class="type">HousePicture</span> <span class="variable">housePicture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HousePicture</span>();</span><br><span class="line">        housePicture.setHouseId(houseId);</span><br><span class="line">        housePicture.setCdnPrefix(cdnPrefix);</span><br><span class="line">        housePicture.setPath(photo.getPath());</span><br><span class="line">        housePicture.setWidth(photo.getWidth());</span><br><span class="line">        housePicture.setHeight(photo.getHeight());</span><br><span class="line">        pictures.add(housePicture);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pictures;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中通过houseForm前端传递的参数获取到photos，然后循环，新建一个HousePicture的List放进去，最后返回出来。然后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Iterable&lt;HousePicture&gt; housePictures = housePictureRepository.save(pictures);</span><br></pre></td></tr></table></figure>
<p>另外返回的都是存储着实体类的List，我们要对其转换成DTO类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用modelMapper映射到DTO</span></span><br><span class="line"><span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> modelMapper.map(house,HouseDTO.class);</span><br><span class="line"><span class="type">HouseDetailDTO</span> <span class="variable">houseDetailDTO</span> <span class="operator">=</span> modelMapper.map(houseDetail, HouseDetailDTO.class);</span><br><span class="line"></span><br><span class="line">houseDTO.setHouseDetail(houseDetailDTO);</span><br><span class="line">List&lt;HousePictureDTO&gt; pictureDTOS  = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">housePictures.forEach(housePicture -&gt; pictureDTOS.add(modelMapper.map(housePicture,HousePictureDTO.class)));</span><br><span class="line">houseDTO.setPictures(pictureDTOS);</span><br><span class="line">houseDTO.setCover(<span class="built_in">this</span>.cdnPrefix + houseDTO.getCover());</span><br></pre></td></tr></table></figure>
<p>其中使用到了peoperties文件中定义的cdnPrefix变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;qiniu.cdn.prefix&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String cdnPrefix;</span><br></pre></td></tr></table></figure>
<p>另外呢还需要得到前端点击标记的标签，然后存储在houseTagRespository中，最后都在houseDTO类中去定义类型。</p>
<p>最后的最后；</p>
<p>return 一个我们定义好的ServiceResult类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;HouseDTO&gt;(<span class="literal">true</span>,<span class="literal">null</span>,houseDTO);</span><br></pre></td></tr></table></figure>
<p><strong>测试插入数据：</strong></p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h58wcr1rl6j21410doq5v.jpg"
alt="image-20220816205011825" />
<figcaption aria-hidden="true">image-20220816205011825</figcaption>
</figure>
<h2 id="二十一房源信息浏览功能1">二十一、房源信息浏览功能(1)</h2>
<h3 id="基础开发">1）基础开发</h3>
<h3 id="分页实现">2）分页实现</h3>
<h3 id="多维度排序">3）多维度排序</h3>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h59lmo8693j21it0u0gop.jpg"
alt="image-20220817112443451" />
<figcaption aria-hidden="true">image-20220817112443451</figcaption>
</figure>
<p>每次刷新后会出现页面重复情况，这种情况出现的原因在于：每次项目呢session会存在内存里面，每次重启呢项目内存就会丢失，这样session就过期了，这样为了保证每次登陆都不受此情况烦恼，所以<strong>提出了使用redis来保存我们的对话信息</strong>。</p>
<blockquote>
<p>我们怎么去实现呢？</p>
</blockquote>
<h3
id="加一个redissessionconfig配置">1、加一个RedisSessionConfig配置</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 86400)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSessionConfig</span> &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加配置类注解、</p>
<p>添加EnableRedisHttpSession，让Springboot自动为我们配置redisSession服务。</p>
<p>并且设置其生效时间为一天86400秒（(maxInactiveIntervalInSeconds =
86400)）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 86400)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSessionConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String,String&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>(factory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然也可以自己进行手动的配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis config</span></span><br><span class="line"><span class="attr">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">localhost</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="attr">spring.redis.pool.min-idle</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">spring.redis.timeout</span>=<span class="string">3000</span></span><br></pre></td></tr></table></figure>
<p>另外呢之前存储缓存在hash_map下也就是在本机内存中，现在需要修改成：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># session会话存储类型</span></span><br><span class="line"><span class="attr">spring.session.store-type</span> = <span class="string">redis</span></span><br></pre></td></tr></table></figure>
<p>但是在上面写localhost就出错了，应该调整为127.0.0.1</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis config</span></span><br><span class="line"><span class="attr">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="attr">spring.redis.pool.min-idle</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">spring.redis.timeout</span>=<span class="string">3000</span></span><br></pre></td></tr></table></figure>
<p>然后这样呢在登录的时候就会将session自动的存储到redis中了：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h59qtvrkmvj20mp043mxn.jpg"
alt="image-20220817142440167" />
<figcaption aria-hidden="true">image-20220817142440167</figcaption>
</figure>
<p>但是这些session是怎么被写进redis中的呢？什么时候写进去的呢？</p>
<p>猜想是在RedisSessionConfig的时候后台自动对session进行的操作。</p>
<p>另外在pom.xml 中添加的依赖是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>关于spring-session的更多详细文章见：</p>
<p>https://www.cnblogs.com/54chensongxia/p/12096493.html</p>
</blockquote>
<p>在房屋列表页面中我们使用的dataTables这个插件，对请求的接口有一些特殊的要求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;admin/houses&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse</span><br></pre></td></tr></table></figure>
<p>但是我们就不能用ApiResponse了，因为dataTables有一个固定的格式。</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h59vm230kbj21wj0u043e.jpg"
alt="image-20220817171008284" />
<figcaption aria-hidden="true">image-20220817171008284</figcaption>
</figure>
<p>所以我们需要单独给它定制一个格式类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Datatables响应结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiDataTableResponse</span> <span class="keyword">extends</span> <span class="title class_">ApiResponse</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> draw;</span><br><span class="line">    <span class="keyword">private</span> Long recordsTotal;</span><br><span class="line">    <span class="keyword">private</span> Long recordsFiltered;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ApiDataTableResponse</span><span class="params">(<span class="type">int</span> code, String message, Object data, <span class="type">int</span> draw, Long recordsTotal, Long recordsFiltered)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(code, message, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDraw</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> draw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDraw</span><span class="params">(<span class="type">int</span> draw)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.draw = draw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getRecordsTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> recordsTotal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRecordsTotal</span><span class="params">(Long recordsTotal)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.recordsTotal = recordsTotal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getRecordsFiltered</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> recordsFiltered;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRecordsFiltered</span><span class="params">(Long recordsFiltered)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.recordsFiltered = recordsFiltered;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就可以在controller中进行定义了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;admin/houses&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiDataTableResponse <span class="title function_">houses</span><span class="params">()</span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是我们需要去定义一个dataTables 的表单类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataTableSearch</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Datatables要求回显字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> draw;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Datatables规定分页字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTimeMin;</span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTimeMax;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String direction;</span><br><span class="line">    <span class="keyword">private</span> String orderBy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDraw</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> draw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDraw</span><span class="params">(<span class="type">int</span> draw)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.draw = draw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStart</span><span class="params">(<span class="type">int</span> start)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLength</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLength</span><span class="params">(<span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.length = length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getStatus</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStatus</span><span class="params">(Integer status)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.status = status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTimeMin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTimeMin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTimeMin</span><span class="params">(Date createTimeMin)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTimeMin = createTimeMin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTimeMax</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTimeMax;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTimeMax</span><span class="params">(Date createTimeMax)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTimeMax = createTimeMax;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> city;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCity</span><span class="params">(String city)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.city = city;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTitle</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDirection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> direction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDirection</span><span class="params">(String direction)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.direction = direction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrderBy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orderBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOrderBy</span><span class="params">(String orderBy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderBy = orderBy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，关于start、length都定义的是int类型，但是关于status定义的是Integer类型，这里定义了一个小技巧，Integer当为空的时候，代表返回所有的状态码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date createTimeMin;</span><br></pre></td></tr></table></figure>
<p>DateTimeFormat去定义了字段的格式校验。</p>
<p>定义好了返回类之后，返回到controller中，我们定义@ModelAttribut固定化返回的结构DataTableSearch.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;admin/houses&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiDataTableResponse <span class="title function_">houses</span><span class="params">(<span class="meta">@ModelAttribute</span> DataTableSearch SearchBody)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先暂时返回null。</p>
<p>这时候我们去定义service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">adminQuery</span><span class="params">(DataTableSearch searchBody)</span>;</span><br></pre></td></tr></table></figure>
<p>在serviceImpl中定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">adminQuery</span><span class="params">(DataTableSearch searchBody)</span> &#123;</span><br><span class="line">    List&lt;HouseDTO&gt; houseDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Iterable&lt;House&gt; houses = houseRepository.findAll();</span><br><span class="line">    houses.forEach(house -&gt; &#123;</span><br><span class="line">        <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> modelMapper.map(house,HouseDTO.class);</span><br><span class="line">        houseDTO.setCover(<span class="built_in">this</span>.cdnPrefix + house.getCover());</span><br><span class="line">        houseDTOS.add(houseDTO);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(houseDTOS.size(),houseDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面我们只定义了findAll，并没有用到searchBody做一些比较详细的查找，会在后续中进行查找。</p>
<p>serviceImpl实现了之后我们就返回去去整理controller。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServiceMultiResult&lt;HouseDTO&gt; result = houseService.adminQuery(SearchBody);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;admin/houses&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiDataTableResponse <span class="title function_">houses</span><span class="params">(<span class="meta">@ModelAttribute</span> DataTableSearch SearchBody)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们返回的是ApiDataTableRespose类型，所以我们需要做一个封装:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApiDataTableResponse</span> <span class="variable">apiDataTableResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiDataTableResponse</span>(ApiResponse.Status.SUCCESS);</span><br></pre></td></tr></table></figure>
<p>然后给ApiDataTableResponese去定义一个构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ApiDataTableResponse</span><span class="params">(ApiResponse.Status status)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>(status.getCode(),status.getStandardMessage(),<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后我们定义的controller如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;admin/houses&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiDataTableResponse <span class="title function_">houses</span><span class="params">(<span class="meta">@ModelAttribute</span> DataTableSearch searchBody)</span>&#123;</span><br><span class="line">    ServiceMultiResult&lt;HouseDTO&gt; result = houseService.adminQuery(searchBody);</span><br><span class="line">    <span class="type">ApiDataTableResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiDataTableResponse</span>(ApiResponse.Status.SUCCESS);</span><br><span class="line">    response.setData(result.getResult());</span><br><span class="line">    response.setRecordsFiltered(result.getTotal());</span><br><span class="line">    response.setRecordsTotal(result.getTotal());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个字段需要回显，所以我们从searchBody中获取，防伪的一个验证</span></span><br><span class="line">    response.setDraw(searchBody.getDraw());</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的结果界面如下：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5fodvfaa7j21qs0u0zpj.jpg"
alt="image-20220822173105778" />
<figcaption aria-hidden="true">image-20220822173105778</figcaption>
</figure>
<p>但是这里我们方法是findAll，另外分页是在前端做的，如果数据量很多的话，很容易就会请求接口的时候把内存撑爆。所以我们不仅要有前端的分页还得要有后端的分页。</p>
<h2 id="二十二房源信息浏览功能2">二十二、房源信息浏览功能(2)</h2>
<p>我们来实现分页，实现基本的分页和基本的排序，这时候就用到了我们controller中的参数searchBody了。</p>
<p>之前我们定义的事House
Repository继承的是CrudRepository，使用的是findAll方法，用到分页所以我们就不能继承这个了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HouseRepository</span> <span class="keyword">extends</span> <span class="title class_">PagingAndSortingRepository</span>&lt;House,Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们重构了Repository方法后，又重新定义了ServiceImpl方法类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">adminQuery</span><span class="params">(DataTableSearch searchBody)</span> &#123;</span><br><span class="line">    List&lt;HouseDTO&gt; houseDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//新建排序类</span></span><br><span class="line">    <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sort</span>(Sort.Direction.fromString(searchBody.getDirection()),searchBody.getOrderBy());</span><br><span class="line">    <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> searchBody.getStart() / searchBody.getLength() ;</span><br><span class="line"></span><br><span class="line">    <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageRequest</span>(page,searchBody.getLength(),sort);</span><br><span class="line">    Page&lt;House&gt; houses = houseRepository.findAll(pageable);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以前的方法就不能用了 Iterable&lt;House&gt; houses = houseRepository.findAll();</span></span><br><span class="line">    houses.forEach(house -&gt; &#123;</span><br><span class="line">        <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> modelMapper.map(house,HouseDTO.class);</span><br><span class="line">        houseDTO.setCover(<span class="built_in">this</span>.cdnPrefix + house.getCover());</span><br><span class="line">        houseDTOS.add(houseDTO);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(houses.getTotalElements(),houseDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先要新建一个排序类：</p>
<p>new Sort()
，里面需要传的第一个参数是排序的方式（正排还是倒排），需要用Sort.Direction.fromString来进行转换。第二个参数是根据什么字段来进行排序，也就是GetOrderBy，</p>
<p>然后再去定义page，固定的公式就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> searchBody.getStart() / searchBody.getLength() ;</span><br></pre></td></tr></table></figure>
<p>然后新建一个Pageable类，需要传递的参数就是page，searchBody.getLength()，sort类，然后把返回的pageable类使用PagingAndSortingRepository的findAll(<strong>Pageable</strong>)重构方法。</p>
<p>另外呢需要调整的地方还有：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(houses.getTotalElements(),houseDTOS);</span><br></pre></td></tr></table></figure>
<p>之前是houseDTOS.size()，现在是返回结果houses.getTotalElements()。<strong>这里因为使用的是findAll，所以getTotalElements返回的是查询的所有的数量总和</strong></p>
<hr />
<p>另外发现：在前端页面中，配置都定义在了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 【关键】数据显示控制 服务器分页</span></span><br><span class="line"><span class="keyword">var</span> table = $(<span class="string">&#x27;#data-table&#x27;</span>).<span class="title class_">DataTable</span>(&#123;</span><br><span class="line">    <span class="string">&quot;order&quot;</span>: [[<span class="number">7</span>, <span class="string">&quot;desc&quot;</span>]],<span class="comment">//默认创建时间排序</span></span><br><span class="line">    <span class="string">&quot;pageLength&quot;</span>: <span class="number">3</span>, <span class="comment">// 配置单页显示条数</span></span><br><span class="line">    <span class="string">&quot;paging&quot;</span>: <span class="literal">true</span>, <span class="comment">// 关闭本地分页</span></span><br><span class="line">    <span class="string">&quot;lengthChange&quot;</span>: <span class="literal">false</span>, <span class="comment">// 不允许用户改变表格每页显示的记录数</span></span><br><span class="line">    <span class="string">&quot;searching&quot;</span>: <span class="literal">false</span>, <span class="comment">// 不允许Datatables开启本地搜索</span></span><br><span class="line">    <span class="string">&quot;ordering&quot;</span>: <span class="literal">true</span>, <span class="comment">// 启用Datatables排序</span></span><br><span class="line">    <span class="string">&quot;info&quot;</span>: <span class="literal">true</span>, <span class="comment">// 表格左边显示搜索信息</span></span><br><span class="line">    <span class="string">&quot;autoWidth&quot;</span>: <span class="literal">true</span>, <span class="comment">// 自动计算表格宽度</span></span><br><span class="line">    <span class="string">&quot;stateSave&quot;</span>: <span class="literal">false</span>, <span class="comment">// 允许表格缓存Datatables，以便下次恢复之前的状态</span></span><br><span class="line">    <span class="string">&quot;retrieve&quot;</span>: <span class="literal">true</span>, <span class="comment">// 如果已经初始化了，则继续使用之前的Datatables实例</span></span><br><span class="line">    <span class="string">&quot;processing&quot;</span>: <span class="literal">true</span>, <span class="comment">// 显示正在处理的状态</span></span><br><span class="line">    <span class="string">&quot;serverSide&quot;</span>: <span class="literal">true</span>, <span class="comment">// 服务器模式，数据由服务器掌控</span></span><br><span class="line">    <span class="string">&quot;pagingType&quot;</span>: <span class="string">&quot;simple_numbers&quot;</span>, <span class="comment">// 翻页显示: 上一页和下一页两个按钮，加上页数按钮</span></span><br><span class="line">    <span class="string">&quot;language&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;sProcessing&quot;</span>: <span class="string">&quot;处理中...&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sLengthMenu&quot;</span>: <span class="string">&quot;显示 _MENU_ 项结果&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sZeroRecords&quot;</span>: <span class="string">&quot;没有匹配结果&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sInfo&quot;</span>: <span class="string">&quot;显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sInfoEmpty&quot;</span>: <span class="string">&quot;显示第 0 至 0 项结果，共 0 项&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sInfoFiltered&quot;</span>: <span class="string">&quot;(由 _MAX_ 项结果过滤)&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sInfoPostFix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sUrl&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sEmptyTable&quot;</span>: <span class="string">&quot;未搜索到数据&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sLoadingRecords&quot;</span>: <span class="string">&quot;载入中...&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sInfoThousands&quot;</span>: <span class="string">&quot;,&quot;</span>,</span><br><span class="line">        <span class="string">&quot;oPaginate&quot;</span>: &#123;</span><br></pre></td></tr></table></figure>
<p>这里，所以在前端发送ajax请求的时候就会把这些预设好的参数传到服务器url。</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5gpgt741zj20u60e3mzd.jpg"
alt="image-20220823145625654" />
<figcaption aria-hidden="true">image-20220823145625654</figcaption>
</figure>
<p>定义的Sort类，实际传入的值是：createTime: DESC</p>
<p>定义的Pageable类，实际传入的值是：Page request [number: 0, size 3,
sort: createTime: DESC]</p>
<blockquote>
<p>这里对于前端的技术代码只做了浏览，并未对其进行详细阅读，至于说熟练掌握，那还需要更多时间去了解。</p>
</blockquote>
<p>这里的翻页，就是使用服务器来完成的。然后使用前端html按钮来发送请求。</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5gpw3v4g4j22c00tqwjm.jpg"
alt="image-20220823151109688" />
<figcaption aria-hidden="true">image-20220823151109688</figcaption>
</figure>
<h2 id="二十三房源信息浏览功能3">二十三、房源信息浏览功能(3)</h2>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5gpxohml2j21rk0pejvq.jpg"
alt="image-20220823151240457" />
<figcaption aria-hidden="true">image-20220823151240457</figcaption>
</figure>
<p>目前的筛选条件等等只能通过表格的字段进行升序、降序的筛选，而不能通过上面城市、房源、创建时间、标题等进行搜索筛选，本节就解决这个问题。</p>
<p>所以我们在repository类中增加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HouseRepository</span> <span class="keyword">extends</span> <span class="title class_">PagingAndSortingRepository</span>&lt;House,Long&gt;, JpaSpecificationExecutor&lt;House&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样不仅可以实现分页，也可以实现对指定内容的查询。</p>
<p>然后需要在ServiceImpl中定义一个Specification。</p>
<blockquote>
<p>spring data
jpa为我们提供了JpaSpecificationExecutor接口，只要简单实现toPredicate方法就可以实现复杂的查询。JpaSpecification查询的关键在于怎么构建Predicates。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">adminQuery</span><span class="params">(DataTableSearch searchBody)</span> &#123;</span><br><span class="line">    List&lt;HouseDTO&gt; houseDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//新建排序类</span></span><br><span class="line">    <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sort</span>(Sort.Direction.fromString(searchBody.getDirection()),searchBody.getOrderBy());</span><br><span class="line">    <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> searchBody.getStart() / searchBody.getLength() ;</span><br><span class="line"></span><br><span class="line">    <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageRequest</span>(page,searchBody.getLength(),sort);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Specification&lt;House&gt; specification = <span class="keyword">new</span> <span class="title class_">Specification</span>&lt;House&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Predicate <span class="title function_">toPredicate</span><span class="params">(Root root, CriteriaQuery query, CriteriaBuilder cb)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里我们使用java8的lambda形式来定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">adminQuery</span><span class="params">(DataTableSearch searchBody)</span> &#123;</span><br><span class="line">    List&lt;HouseDTO&gt; houseDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//新建排序类</span></span><br><span class="line">    <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sort</span>(Sort.Direction.fromString(searchBody.getDirection()),searchBody.getOrderBy());</span><br><span class="line">    <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> searchBody.getStart() / searchBody.getLength() ;</span><br><span class="line"></span><br><span class="line">    <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageRequest</span>(page,searchBody.getLength(),sort);</span><br><span class="line"></span><br><span class="line">    Specification&lt;House&gt; specification = (root, query,cb) -&gt;&#123;</span><br><span class="line">        <span class="type">Predicate</span> <span class="variable">predicate</span> <span class="operator">=</span> cb.equal((root.get(<span class="string">&quot;adminId&quot;</span>),LoginUserUtil.getUserId()));</span><br><span class="line">        predicate = cb.and(predicate,cb.notEqual(root.get(<span class="string">&quot;status&quot;</span>), HouseStatus.DELETED.getValue()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(searchBody.getCity() !=<span class="literal">null</span>)&#123;</span><br><span class="line">            predicate = cb.and(predicate, cb.equal(root.get(<span class="string">&quot;cityEnName&quot;</span>), searchBody.getCity()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (searchBody.getStatus() !=<span class="literal">null</span>)&#123;</span><br><span class="line">            predicate = cb.and(predicate, cb.equal(root.get(<span class="string">&quot;status&quot;</span>),searchBody.getStatus()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(searchBody.getCreateTimeMin() !=<span class="literal">null</span>)&#123;</span><br><span class="line">            predicate = cb.and(predicate,cb.greaterThanOrEqualTo(root.get(<span class="string">&quot;createTime&quot;</span>),searchBody.getCreateTimeMin()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(searchBody.getCreateTimeMax() !=<span class="literal">null</span>)&#123;</span><br><span class="line">            predicate = cb.and(predicate,cb.lessThanOrEqualTo(root.get(<span class="string">&quot;createTime&quot;</span>),searchBody.getCreateTimeMax()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(searchBody.getTitle() !=<span class="literal">null</span>)&#123;</span><br><span class="line">            predicate = cb.and(predicate, cb.like(root.get(<span class="string">&quot;title&quot;</span>),<span class="string">&quot;%&quot;</span>+searchBody.getTitle()+<span class="string">&quot;%&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> predicate;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>root.get("country")，对应着实体类的相关属性country，root.get属性对应的实体类，我认为从使用该spec的Repository对应的实体类相对应，比如此处的playerRepo对应的实体类PlayerEntity，实际上如果属性对不上，运行时会报错。root.get取得相应实体的操作字段。</p>
<p>而criteriaBuilder.equal和criteriaBuilder.and，则是用来构建复杂查询</p>
<p>criteriaBuilder.add 或者
criteriaBuilder.or等方法的返回值也为Predicate对象。</p>
</blockquote>
<p>如果添加一些搜索条件找不到的话，显示结果图如下所示：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5gtriepryj22bc0kcad6.jpg"
alt="image-20220823172508134" />
<figcaption aria-hidden="true">image-20220823172508134</figcaption>
</figure>
<h2 id="二十四编辑功能实现1">二十四、编辑功能实现1</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 房源信息编辑页</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;admin/house/edit&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">houseEditPage</span><span class="params">(<span class="meta">@RequestParam(value = &quot;id&quot;)</span> Long id, Model model)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(id == <span class="literal">null</span> || id &lt;<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;404&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;admin/house-edit&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在controller层中新家房源信息编辑代码，然后在serviceImpl中去新建一个service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务接口通用结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success, String message, T result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccess</span><span class="params">(<span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getResult</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResult</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ServiceResult&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ServiceResult&lt;T&gt; <span class="title function_">of</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        ServiceResult&lt;T&gt; serviceResult = <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">true</span>);</span><br><span class="line">        serviceResult.setResult(result);</span><br><span class="line">        <span class="keyword">return</span> serviceResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ServiceResult&lt;T&gt; <span class="title function_">notFound</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">false</span>, Message.NOT_FOUND.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">        NOT_FOUND(<span class="string">&quot;Not Found Resource!&quot;</span>),</span><br><span class="line">        NOT_LOGIN(<span class="string">&quot;User not login!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">        Message(String value) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在serviceImpl中去定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult&lt;HouseDTO&gt; <span class="title function_">findCompleteOne</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(house ==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HouseDetail detail;</span><br><span class="line">    </span><br><span class="line">    List&lt;HouseTag&gt; tags;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为需要获取到完整的house信息，上面代码部分我们不仅要查询house，还要查询houseDetail、housetag（注意这里HouseTag是List类型）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult&lt;HouseDTO&gt; <span class="title function_">findCompleteOne</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(house ==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">HouseDetail</span> <span class="variable">detail</span> <span class="operator">=</span> houseDetailRepository.findOne(id);</span><br><span class="line">    List&lt;HousePicture&gt; housePictures = housePictureRepository.findAllByhouseId(id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要把do转换成dto</span></span><br><span class="line">    <span class="type">HouseDetailDTO</span> <span class="variable">houseDetailDTO</span> <span class="operator">=</span>  modelMapper.map(detail,HouseDetailDTO.class);</span><br><span class="line">    List&lt;HousePictureDTO&gt; pictureDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (HousePicture housePicture : housePictures) &#123;</span><br><span class="line">        <span class="type">HousePictureDTO</span> <span class="variable">housePictureDTO</span>  <span class="operator">=</span> modelMapper.map(housePicture,HousePictureDTO.class);</span><br><span class="line">        pictureDTOS.add(housePictureDTO);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;HouseTag&gt; tags = houseTagRepository.findAllById(id);</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; tagList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (HouseTag tag : tags) &#123;</span><br><span class="line">        tagList.add(tag.getName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">HouseDTO</span> <span class="variable">result</span> <span class="operator">=</span> modelMapper.map(house, HouseDTO.class);</span><br><span class="line">    result.setHouseDetail(houseDetailDTO);</span><br><span class="line">    result.setPictures(pictureDTOS);</span><br><span class="line">    result.setTags(tagList);</span><br><span class="line">    ServiceResult&lt;HouseDTO&gt; serviceResult = ServiceResult.of(result);</span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>都是一些查询的操作，没有什么好纪录的了，不过有一个类倒是需要纪录一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务接口通用结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceResult</span><span class="params">(<span class="type">boolean</span> success, String message, T result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccess</span><span class="params">(<span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getResult</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResult</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ServiceResult&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ServiceResult&lt;T&gt; <span class="title function_">of</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        ServiceResult&lt;T&gt; serviceResult = <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">true</span>);</span><br><span class="line">        serviceResult.setResult(result);</span><br><span class="line">        <span class="keyword">return</span> serviceResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ServiceResult&lt;T&gt; <span class="title function_">notFound</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">false</span>, Message.NOT_FOUND.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">        NOT_FOUND(<span class="string">&quot;Not Found Resource!&quot;</span>),</span><br><span class="line">        NOT_LOGIN(<span class="string">&quot;User not login!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">        Message(String value) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这个封装好的返回类的of方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ServiceResult&lt;T&gt; <span class="title function_">of</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        ServiceResult&lt;T&gt; serviceResult = <span class="keyword">new</span> <span class="title class_">ServiceResult</span>&lt;&gt;(<span class="literal">true</span>);</span><br><span class="line">        serviceResult.setResult(result);</span><br><span class="line">        <span class="keyword">return</span> serviceResult;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>ServiceResult<T>这里不是很理解，为什么后面加一个范型类T</strong></p>
<p>最后测试，点击编辑按钮，返回页面：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5i56k81zbj21o90u0n05.jpg"
alt="image-20220824204543117" />
<figcaption aria-hidden="true">image-20220824204543117</figcaption>
</figure>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5i56yb8igj21rz0u0q72.jpg"
alt="image-20220824204607629" />
<figcaption aria-hidden="true">image-20220824204607629</figcaption>
</figure>
<p>但是我们点击更新的时候会报如下错误：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5i5ku36fmj21km0rw0v3.jpg"
alt="image-20220824205928885" />
<figcaption aria-hidden="true">image-20220824205928885</figcaption>
</figure>
<p><strong>我们重新定义@GetMapping("admin/house/edit")</strong></p>
<p><strong>使用post请求，即重载</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;admin/house/edit&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">saveHouse</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@ModelAttribute(&quot;form-house-edit&quot;)</span> HouseForm houseForm, BindingResult bindingResult)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们定义了@valid验证注解
并设置model参数为form-house-edit，还有设定一个绑定的变量参数bindingResult。</p>
<p>并在IHouseService中定义updae接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> houseForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ServiceResult <span class="title function_">update</span><span class="params">(HouseForm houseForm)</span>;</span><br></pre></td></tr></table></figure>
<p>因为是修改更新，所以我们不同于add一样需要验证，所以我们不需要进行返回参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult&lt;HouseDTO&gt; <span class="title function_">update</span><span class="params">(HouseForm houseForm)</span> &#123;</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(houseForm.getId());</span><br><span class="line">    <span class="keyword">if</span>(house == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">HouseDetail</span> <span class="variable">houseDetail</span> <span class="operator">=</span> houseDetailRepository.findOne(houseForm.getId());</span><br><span class="line">    <span class="keyword">if</span>(houseDetail == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//围绕houseDetail做一些属性的设置，将地铁以及地铁站的信息设置进去。</span></span><br><span class="line">    <span class="type">ServiceResult</span> <span class="variable">wrapperResult</span> <span class="operator">=</span>  wrapperDetailInfo(houseDetail,houseForm);</span><br><span class="line">    <span class="comment">//因为wraperResult正常返回的就是null，如果不返回null，就直接返回，说明有问题。</span></span><br><span class="line">    <span class="keyword">if</span> (wrapperResult != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> wrapperResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//另外只要是有save、update、delete操作都要在接口上加上@Transactional事务操作，另外有jpa的原因，如果不加事务，是不会让这段代码去运行的</span></span><br><span class="line">    houseDetailRepository.save(houseDetail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//另外呢除了Detail，Picture也是需要进行保存的</span></span><br><span class="line">    List&lt;HousePicture&gt; pictures = generatePictures(houseForm, houseDetail.getHouseId());</span><br><span class="line">    housePictureRepository.save(pictures);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//因为有时候cover并不能很及时的返回，所以这里设置重新加载一次设置，保存的时候不要丢掉数据</span></span><br><span class="line">    <span class="keyword">if</span>(houseForm.getCover() == <span class="literal">null</span>)&#123;</span><br><span class="line">        houseForm.setCover(house.getCover());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//然后把houseform内容映射到house中。为什么？是因为只有houseform增加了setCover吗？那为什么不直接去增加house呢？</span></span><br><span class="line">    <span class="comment">//原来是houseForm是最新的数据，而houseDetail存储的是根据id查询出来的历史的未修改的地铁相关数据。</span></span><br><span class="line">    <span class="comment">//在上面houseDetail这里已经将修改好的地铁详情信息存储了，这里再对主体的house信息进行entity的映射。当然map并非一对一，是有对应的变量就对应过去。有些对应不上的（detail类的信息）就不会映射过去。</span></span><br><span class="line">    modelMapper.map(houseForm,house);</span><br><span class="line">    <span class="comment">//另外有个字段需要重新设置一下</span></span><br><span class="line">    house.setLastUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    houseRepository.save(house);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ServiceResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后去编辑controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编辑接口，更新按钮的重载</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;admin/house/edit&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">saveHouse</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@ModelAttribute(&quot;form-house-edit&quot;)</span> HouseForm houseForm, BindingResult bindingResult)</span>&#123;</span><br><span class="line">    <span class="comment">//首先要判断绑定的参数有没有问题</span></span><br><span class="line">    <span class="keyword">if</span>(bindingResult.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(HttpStatus.BAD_REQUEST.value(), bindingResult.getAllErrors().get(<span class="number">0</span>).getDefaultMessage(),<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;SupportAddress.Level, SupportAddressDTO&gt; cityAndRegion = addressService.findCityAndRegion(houseForm.getCityEnName(), houseForm.getRegionEnName());</span><br><span class="line">    <span class="comment">//如果返回的地址城市city和Regin两个，就没有问题</span></span><br><span class="line">    <span class="keyword">if</span>(cityAndRegion.size() !=<span class="number">2</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对houseForm表单进行更新操作</span></span><br><span class="line">    <span class="type">ServiceResult</span> <span class="variable">result</span> <span class="operator">=</span> houseService.update(houseForm);</span><br><span class="line">    <span class="keyword">if</span>(result.isSuccess())&#123;</span><br><span class="line">        <span class="comment">//更新成功并不需要返回什么数据</span></span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果不成功的话就返回bad——request</span></span><br><span class="line">    <span class="type">ApiResponse</span> <span class="variable">apiResponse</span> <span class="operator">=</span> ApiResponse.ofStatus(ApiResponse.Status.BAD_REQUEST);</span><br><span class="line">    apiResponse.setMessage(result.getMessage());</span><br><span class="line">    <span class="keyword">return</span> apiResponse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="二十五编辑功能实现2">二十五、编辑功能实现2</h2>
<p>虽然上节中我们实现了更新的操作，但是对于房源标签修改，移除图片等操作还没有具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 移除图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ServiceResult <span class="title function_">removePhoto</span><span class="params">(Long id )</span>;</span><br><span class="line">ServiceResult <span class="title function_">addTag</span><span class="params">(Long houseId, String tag)</span>;</span><br><span class="line">ServiceResult <span class="title function_">updateCover</span><span class="params">(Long coverId, Long targetId)</span>;</span><br></pre></td></tr></table></figure>
<p>然后在serviceImpl实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult <span class="title function_">removePhoto</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>暂列返回为null。</p>
<p>然后定义修改封面接口、移除图片接口、增加标签接口的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 移除图片接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;admin/house/photo&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">removeHousePhoto</span><span class="params">(<span class="meta">@RequestParam(value = &quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="type">ServiceResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.houseService.removePhoto(id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.isSuccess()) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofMessage(HttpStatus.BAD_REQUEST.value(), result.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改封面接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> coverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> targetId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;admin/house/cover&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">updateCover</span><span class="params">(<span class="meta">@RequestParam(value = &quot;cover_id&quot;)</span> Long coverId,</span></span><br><span class="line"><span class="params">                               <span class="meta">@RequestParam(value = &quot;target_id&quot;)</span> Long targetId)</span> &#123;</span><br><span class="line">    <span class="type">ServiceResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.houseService.updateCover(coverId, targetId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.isSuccess()) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofMessage(HttpStatus.BAD_REQUEST.value(), result.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 增加标签接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> houseId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tag</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;admin/house/tag&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">addHouseTag</span><span class="params">(<span class="meta">@RequestParam(value = &quot;house_id&quot;)</span> Long houseId,</span></span><br><span class="line"><span class="params">                               <span class="meta">@RequestParam(value = &quot;tag&quot;)</span> String tag)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (houseId &lt; <span class="number">1</span> || Strings.isNullOrEmpty(tag)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ServiceResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.houseService.addTag(houseId, tag);</span><br><span class="line">    <span class="keyword">if</span> (result.isSuccess()) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofMessage(HttpStatus.BAD_REQUEST.value(), result.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 移除标签接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> houseId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tag</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;admin/house/tag&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">removeHouseTag</span><span class="params">(<span class="meta">@RequestParam(value = &quot;house_id&quot;)</span> Long houseId,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam(value = &quot;tag&quot;)</span> String tag)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (houseId &lt; <span class="number">1</span> || Strings.isNullOrEmpty(tag)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ServiceResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.houseService.removeTag(houseId, tag);</span><br><span class="line">    <span class="keyword">if</span> (result.isSuccess()) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofMessage(HttpStatus.BAD_REQUEST.value(), result.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就到service实现类中去实现移除图片具体逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult <span class="title function_">removePhoto</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//首先要去判断photo的id，万一有人冒充该接口删除了一些不该删除的照片就会导致错误</span></span><br><span class="line">    <span class="type">HousePicture</span> <span class="variable">picture</span> <span class="operator">=</span> housePictureRepository.findOne(id);</span><br><span class="line">    <span class="keyword">if</span>(picture == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = iQiNiuService.delete(picture.getPath());</span><br><span class="line">        <span class="comment">//也要判断七牛返回的删除接口是否是ok的状态</span></span><br><span class="line">        <span class="keyword">if</span>(response.isOK())&#123;</span><br><span class="line">            <span class="keyword">return</span> ServiceResult.success();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//如果删除异常的话，也返回七牛发给我们的error信息</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>,response.error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (QiniuException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>,e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>另外发现一个问题缺陷</p>
</blockquote>
<p>在房源编辑的时候，上传完毕图片，在封面设置那里是一个错误的视图。所以找了半天，发现在upload.js文件下有一个设置封面图片的地方，需要拼接src+Photopath，需要修改成在七牛云申请的域名。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;#upload-cover-container&quot;</span>).<span class="title function_">append</span>(</span><br><span class="line">    <span class="string">&#x27;&lt;div style=&quot;float: left; margin: 2px; padding: 2px; border: 1px dashed; width:&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27; 120px; height: 100px;&quot;&gt;&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;&lt;span&gt;&lt;img src=&quot;http://rge19896q.hb-bkt.clouddn.com//&#x27;</span> +</span><br><span class="line">    photo_path + <span class="string">&#x27;?imageView2/1/w/100/h/100&quot; title=&quot;待选封面&quot; /&gt;&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;&lt;input style=&quot;margin-left: 5px;&quot; type=&quot;radio&quot; name=&quot;cover&quot; value=&quot;&#x27;</span> +</span><br><span class="line">    photo_path + <span class="string">&#x27;&quot;/&gt;&lt;/span&gt;&lt;/div&gt;&#x27;</span></span><br><span class="line">);		</span><br></pre></td></tr></table></figure>
<p>才可以正常显示，显示成功的图如下所示：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5j3e1z84cj20u70ratah.jpg"
alt="image-20220825162919557" />
<figcaption aria-hidden="true">image-20220825162919557</figcaption>
</figure>
<p>service实现类中去实现移除图片具体逻辑后再去实现updateCover的具体逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult <span class="title function_">updateCover</span><span class="params">(Long coverId, Long targetId)</span> &#123;</span><br><span class="line">    <span class="type">HousePicture</span> <span class="variable">cover</span> <span class="operator">=</span> housePictureRepository.findOne(coverId);</span><br><span class="line">    <span class="keyword">if</span> (cover == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line">    houseRepository.updateCover(targetId, cover.getPath());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在repository中去定义增删改查的语句，注意：</p>
<p>要增加@Modify注解，告诉其这是一个修改的方法。</p>
<p>要增加@Query注解，自定义一些crud的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HouseRepository</span> <span class="keyword">extends</span> <span class="title class_">PagingAndSortingRepository</span>&lt;House,Long&gt;, JpaSpecificationExecutor&lt;House&gt; &#123;</span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="meta">@Query(value =&quot;update House as house set house.cover = :cover where house.id = :id&quot; )</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateCover</span><span class="params">(<span class="meta">@Param(value = &quot;id&quot;)</span> Long id, <span class="meta">@Param(value = &quot;cover&quot;)</span> String cover)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>其中关于jpa的语法需要更多的去学习了解</strong></p>
<p>然后返回写serviceImpl类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult <span class="title function_">updateCover</span><span class="params">(Long coverId, Long targetId)</span> &#123;</span><br><span class="line">    <span class="type">HousePicture</span> <span class="variable">cover</span> <span class="operator">=</span> housePictureRepository.findOne(coverId);</span><br><span class="line">    <span class="keyword">if</span> (cover == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line">    houseRepository.updateCover(targetId, cover.getPath());</span><br><span class="line">    <span class="keyword">return</span> ServiceResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为是update操作，所以不需要返回值。但是这里似乎并没有添加什么校验。</p>
<p>效果图：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5j4zosgsqj21ki0u0gnz.jpg"
alt="image-20220825172443129" />
<figcaption aria-hidden="true">image-20220825172443129</figcaption>
</figure>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5j4zwf075j22580r8jvc.jpg"
alt="image-20220825172455963" />
<figcaption aria-hidden="true">image-20220825172455963</figcaption>
</figure>
<p>另外呢还需要添加增加标签和删除标签serviceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult <span class="title function_">addTag</span><span class="params">(Long houseId, String tag)</span> &#123;</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(houseId);</span><br><span class="line">    <span class="keyword">if</span> (house == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">HouseTag</span> <span class="variable">houseTag</span> <span class="operator">=</span> houseTagRepository.findByNameAndHouseId(tag, houseId);</span><br><span class="line">    <span class="keyword">if</span> (houseTag != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>, <span class="string">&quot;标签已存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    houseTagRepository.save(<span class="keyword">new</span> <span class="title class_">HouseTag</span>(houseId, tag));</span><br><span class="line">    <span class="keyword">return</span> ServiceResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult <span class="title function_">removeTag</span><span class="params">(Long houseId, String tag)</span> &#123;</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(houseId);</span><br><span class="line">    <span class="keyword">if</span> (house == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">HouseTag</span> <span class="variable">houseTag</span> <span class="operator">=</span> houseTagRepository.findByNameAndHouseId(tag, houseId);</span><br><span class="line">    <span class="keyword">if</span> (houseTag == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>, <span class="string">&quot;标签不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    houseTagRepository.delete(houseTag.getId());</span><br><span class="line">    <span class="keyword">return</span> ServiceResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="二十六审核功能实现">二十六、审核功能实现</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 审核接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> operation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;admin/house/operate/&#123;id&#125;/&#123;operation&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">operateHouse</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span> Long id , <span class="meta">@PathVariable(value = &quot;operation&quot;)</span> <span class="type">int</span> operation)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先设定审核通过这个简单功能测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 审核接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> operation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;admin/house/operate/&#123;id&#125;/&#123;operation&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">operateHouse</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span> Long id , <span class="meta">@PathVariable(value = &quot;operation&quot;)</span> <span class="type">int</span> operation)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(id &lt;=<span class="number">1</span>  )&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(operation ==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">this</span>.houseService.updateStatus(id, HouseStatus.PASSES.getValue());</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.BAD_REQUEST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在编辑的时候把@PutMapping写成了<span class="citation"
data-cites="PostMapping">@PostMapping</span>，导致了错误</p>
</blockquote>
<p>原因在于：<span class="citation"
data-cites="PutMapping和">@PutMapping和</span><span class="citation"
data-cites="PostMapping的区别">@PostMapping的区别</span>？</p>
<p><strong>如果执行添加操作, 后面的添加请求不会覆盖前面的请求,
所以使用@Postmapping</strong></p>
<p><strong>如果执行修改操作, 后面的修改请求会把前面的请求给覆盖掉,
所以使用@PutMapping</strong></p>
<p>然后我们在serviceImpl类中去实现updateStatus。</p>
<p>因为在controller层中我们对传过来的id进行了校验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(id &lt;=<span class="number">1</span>  )&#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们也只是对id做个简单的校验，而没有对查询出来的house进行校验。</p>
<p>所以我们在serviceImpl层进行了校验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult <span class="title function_">updateStatus</span><span class="params">(Long id, <span class="type">int</span> status)</span> &#123;</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(id);</span><br><span class="line">    <span class="keyword">if</span>(house == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(house.getStatus() == status)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>,<span class="string">&quot;状态没有发生变化！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (house.getStatus() == HouseStatus.RENTED.getValue()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>,<span class="string">&quot;已出租的房屋不允许发生状态改变！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(house.getStatus() == HouseStatus.DELETED.getValue())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>,<span class="string">&quot;已删除的房屋不允许操作！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    houseRepository.updateStatus();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然了，在update之前我们要做一些其他的校验，比如说状态是否发生了改变？是否已出租房屋？是否已删除房屋？等等</p>
<p>然后在repository中执行数据层的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query(value = &quot;update House as house set house.status = :status where house.id = :id&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">updateStatus</span><span class="params">(<span class="meta">@Param(value =&quot;id&quot;)</span> Long id, <span class="meta">@Param(value = &quot;status&quot;)</span> <span class="type">int</span> status)</span>;</span><br></pre></td></tr></table></figure>
<p>同样的，在repositpory中并非简单的增删查操作，所以需要单独去编写@Modifying注解，和@Query注解去自定义JPA的语句。</p>
<p>然后都编辑好了之后，就可以在serviceImpl中完善了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult <span class="title function_">updateStatus</span><span class="params">(Long id, <span class="type">int</span> status)</span> &#123;</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(id);</span><br><span class="line">    <span class="keyword">if</span>(house == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(house.getStatus() == status)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>,<span class="string">&quot;状态没有发生变化！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (house.getStatus() == HouseStatus.RENTED.getValue()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>,<span class="string">&quot;已出租的房屋不允许发生状态改变！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(house.getStatus() == HouseStatus.DELETED.getValue())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceResult</span>(<span class="literal">false</span>,<span class="string">&quot;已删除的房屋不允许操作！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    houseRepository.updateStatus(id,status);</span><br><span class="line">    <span class="keyword">return</span> ServiceResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后实现的审核：发布效果如下所示：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5k6k0gwpcj22600rigpt.jpg"
alt="image-20220826150416712" />
<figcaption aria-hidden="true">image-20220826150416712</figcaption>
</figure>
<p>当然了，在controller中我们不能定义operation=1、2、3、4这样的操作，所以要去定义一些通用的类库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;admin/house/operate/&#123;id&#125;/&#123;operation&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">operateHouse</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span> Long id , <span class="meta">@PathVariable(value = &quot;operation&quot;)</span> <span class="type">int</span> operation)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(id &lt;=<span class="number">1</span>  )&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(operation ==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">this</span>.houseService.updateStatus(id, HouseStatus.PASSES.getValue());</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.BAD_REQUEST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 房屋操作状态常量定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseOperation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PASS</span> <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">//通过审核</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PULL_OUT</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">//下架，重新审核</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DELETE</span> <span class="operator">=</span> <span class="number">3</span>; <span class="comment">//逻辑删除</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RENT</span> <span class="operator">=</span> <span class="number">4</span>; <span class="comment">//出租</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义好之后，就修改验证代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(operation == HouseOperation.PASS)&#123;</span><br><span class="line">    <span class="built_in">this</span>.houseService.updateStatus(id, HouseStatus.PASSES.getValue());</span><br><span class="line">    <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那既然这样，我们也可以换成swich( ) case的形式了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审核接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> operation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;admin/house/operate/&#123;id&#125;/&#123;operation&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">operateHouse</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span> Long id , <span class="meta">@PathVariable(value = &quot;operation&quot;)</span> <span class="type">int</span> operation)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(id &lt;=<span class="number">1</span>  )&#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        if(operation == HouseOperation.PASS)&#123;</span></span><br><span class="line"><span class="comment">//            this.houseService.updateStatus(id, HouseStatus.PASSES.getValue());</span></span><br><span class="line"><span class="comment">//            return ApiResponse.ofStatus(ApiResponse.Status.SUCCESS);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        ServiceResult result;</span><br><span class="line">        <span class="keyword">switch</span>(operation)&#123;</span><br><span class="line">            <span class="keyword">case</span> HouseOperation.PASS:</span><br><span class="line">                result = <span class="built_in">this</span>.houseService.updateStatus(id, operation);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> HouseOperation.PULL_OUT:</span><br><span class="line">                result = <span class="built_in">this</span>.houseService.updateStatus(id, operation);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> HouseOperation.DELETE:</span><br><span class="line">                result = <span class="built_in">this</span>.houseService.updateStatus(id, operation);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> HouseOperation.RENT:</span><br><span class="line">                result = <span class="built_in">this</span>.houseService.updateStatus(id, operation);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.BAD_REQUEST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(result == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofSuccess(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofMessage(HttpStatus.BAD_REQUEST.value(), result.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而在我们设置PASS=1、PULL_OUT=2、DELETE=3、RENT=4的时候，发现点击上架按钮，前端显示的是已出租。所以找前端发现是这样设计的逻辑：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">targets</span>: <span class="number">8</span>,</span><br><span class="line">     <span class="attr">render</span>: <span class="keyword">function</span> (<span class="params">data, type, row, meta</span>) &#123;</span><br><span class="line">         <span class="keyword">var</span> html = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">         <span class="keyword">if</span> (data === <span class="number">0</span>) &#123;</span><br><span class="line">             html = <span class="string">&#x27;&lt;td class=&quot;td-status&quot;&gt;&lt;span class=&quot;label label-danger radius&quot;&gt;待审核&lt;/span&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="number">1</span>) &#123;</span><br><span class="line">             html = <span class="string">&#x27;&lt;td class=&quot;td-status&quot;&gt;&lt;span class=&quot;label label-success radius&quot;&gt;已发布&lt;/span&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="number">2</span>) &#123;</span><br><span class="line">             html = <span class="string">&#x27;&lt;td class=&quot;td-status&quot;&gt;&lt;span class=&quot;label label-warning radius&quot;&gt;已出租&lt;/span&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             html = <span class="string">&#x27;&lt;td class=&quot;td-status&quot;&gt;&lt;span class=&quot;label label-danger radius&quot;&gt;未知状态&lt;/span&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> html;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>然后在house-list.js中我们又调整了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*房源-下架*/</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">house_stop</span>(<span class="params">obj, id</span>) &#123;</span><br><span class="line">    layer.<span class="title function_">confirm</span>(<span class="string">&#x27;确认要下架吗？&#x27;</span>, <span class="keyword">function</span> (<span class="params">index</span>) &#123;</span><br><span class="line">        $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;PUT&#x27;</span>,</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/admin/house/operate/&#x27;</span> + id + <span class="string">&#x27;/&#x27;</span> + <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (data.<span class="property">code</span> === <span class="number">200</span>) &#123;</span><br><span class="line">                    $(obj).<span class="title function_">parents</span>(<span class="string">&quot;tr&quot;</span>).<span class="title function_">find</span>(<span class="string">&quot;.td-manage&quot;</span>).<span class="title function_">prepend</span>(<span class="string">&#x27;&lt;a style=&quot;text-decoration:none&quot;&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27; onClick=&quot;house_pass(this,id)&quot; href=&quot;javascript:;&quot; title=&quot;发布&quot;&gt;&lt;i&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27; class=&quot;Hui-iconfont&quot;&gt;&amp;#xe603;&lt;/i&gt;&lt;/a&gt;&#x27;</span>);</span><br><span class="line">                    $(obj).<span class="title function_">parents</span>(<span class="string">&quot;tr&quot;</span>).<span class="title function_">find</span>(<span class="string">&quot;.td-status&quot;</span>).<span class="title function_">html</span>(<span class="string">&#x27;&lt;span class=&quot;label label-defaunt radius&quot;&gt;已下架&lt;/span&gt;&#x27;</span>);</span><br><span class="line">                    $(obj).<span class="title function_">remove</span>();</span><br><span class="line">                    layer.<span class="title function_">msg</span>(<span class="string">&#x27;已下架!&#x27;</span>, &#123;<span class="attr">icon</span>: <span class="number">5</span>, <span class="attr">time</span>: <span class="number">1000</span>&#125;);</span><br><span class="line">                    <span class="title function_">reloadTable</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    layer.<span class="title function_">msg</span>(<span class="string">&#x27;下架失败！&#x27;</span> + data.<span class="property">message</span>, &#123;<span class="attr">icon</span>: <span class="number">5</span>, <span class="attr">time</span>: <span class="number">1000</span>&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">jqXHR, textStatus, errorThrown</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(jqXHR);</span><br><span class="line">                layer.<span class="title function_">msg</span>(<span class="string">&#x27;下架失败！&#x27;</span> + jqXHR.<span class="property">responseText</span>, &#123;<span class="attr">icon</span>: <span class="number">5</span>, <span class="attr">time</span>: <span class="number">3000</span>&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里对下架的按钮修改为发送/admin/house/operate/' + id + '/' + '0'
的请求，也就是重新设置为状态<strong>待审核</strong></p>
<p>现在点击下架按钮就变为状态：待审核，而不是已出租的状态了。</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5kac8a1tsj21b10gpq4h.jpg"
alt="image-20220826171519957" />
<figcaption aria-hidden="true">image-20220826171519957</figcaption>
</figure>
<h2 id="二十七基础功能分析">二十七、基础功能分析</h2>
<h3 id="业务与功能分析-2">1、业务与功能分析</h3>
<ul>
<li>作为一个租房网站，要有基本的房源浏览功能，让用户在我们的网站可以浏览房源信息，并在找到目标房源后，能够查看房源的详细信息，这一章节就要实现租房网站的核心基础功能。</li>
</ul>
<h3 id="实现目标-1">2、实现目标</h3>
<ul>
<li>网站基本布局</li>
<li>房源信息浏览</li>
<li>房源信息详情页</li>
</ul>
<h2 id="二十八基础功能实现">二十八、基础功能实现</h2>
<h3 id="房源信息浏览功能">1、房源信息浏览功能</h3>
<ul>
<li>默认排序实现</li>
<li>其他维度实现</li>
</ul>
<p>首先我们定义form结构体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.web.form;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 租房请求参数结构体</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RentSearch</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String cityEnName;</span><br><span class="line">    <span class="keyword">private</span> String regionEnName;</span><br><span class="line">    <span class="keyword">private</span> String priceBlock;</span><br><span class="line">    <span class="keyword">private</span> String areaBlock;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> room;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> direction;</span><br><span class="line">    <span class="keyword">private</span> String keywords;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">rentWay</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">orderBy</span> <span class="operator">=</span> <span class="string">&quot;lastUpdateTime&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">orderDirection</span> <span class="operator">=</span> <span class="string">&quot;desc&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDirection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> direction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDirection</span><span class="params">(<span class="type">int</span> direction)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.direction = direction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCityEnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cityEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCityEnName</span><span class="params">(String cityEnName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cityEnName = cityEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> start &gt; <span class="number">0</span> ? start : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStart</span><span class="params">(<span class="type">int</span> start)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.size &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.size &gt; <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSize</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRegionEnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> regionEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRegionEnName</span><span class="params">(String regionEnName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.regionEnName = regionEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPriceBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> priceBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPriceBlock</span><span class="params">(String priceBlock)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.priceBlock = priceBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAreaBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> areaBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAreaBlock</span><span class="params">(String areaBlock)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.areaBlock = areaBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRoom</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> room;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoom</span><span class="params">(<span class="type">int</span> room)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.room = room;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKeywords</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> keywords;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKeywords</span><span class="params">(String keywords)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.keywords = keywords;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRentWay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rentWay &gt; -<span class="number">2</span> &amp;&amp; rentWay &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> rentWay;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRentWay</span><span class="params">(<span class="type">int</span> rentWay)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rentWay = rentWay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrderBy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orderBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOrderBy</span><span class="params">(String orderBy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderBy = orderBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrderDirection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orderDirection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOrderDirection</span><span class="params">(String orderDirection)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderDirection = orderDirection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;RentSearch &#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cityEnName=&#x27;&quot;</span> + cityEnName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, regionEnName=&#x27;&quot;</span> + regionEnName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, priceBlock=&#x27;&quot;</span> + priceBlock + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, areaBlock=&#x27;&quot;</span> + areaBlock + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, room=&quot;</span> + room +</span><br><span class="line">                <span class="string">&quot;, direction=&quot;</span> + direction +</span><br><span class="line">                <span class="string">&quot;, keywords=&#x27;&quot;</span> + keywords + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, rentWay=&quot;</span> + rentWay +</span><br><span class="line">                <span class="string">&quot;, orderBy=&#x27;&quot;</span> + orderBy + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, orderDirection=&#x27;&quot;</span> + orderDirection + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, start=&quot;</span> + start +</span><br><span class="line">                <span class="string">&quot;, size=&quot;</span> + size +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后定义HouseController类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.web.controller.house;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.base.ApiResponse;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.base.RentValueBLock;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.service.ServiceMultiResult;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.service.ServiceResult;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.service.house.IAddressService;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.service.house.IHouseService;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.web.dto.HouseDTO;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.web.dto.SubwayDTO;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.web.dto.SubwayStationDTO;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.web.dto.SupportAddressDTO;</span><br><span class="line"><span class="keyword">import</span> com.zryy.soufangtest.web.form.RentSearch;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ModelAttribute;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.support.RedirectAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IAddressService addressService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IHouseService houseService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取支持城市列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/cities&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportCities</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceMultiResult&lt;SupportAddressDTO&gt; result = addressService.findAllCities();</span><br><span class="line">        <span class="keyword">if</span> (result.getResultSize() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofSuccess(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(result.getResult());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对应城市支持区域列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cityEnName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/regions&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportRegions</span><span class="params">(<span class="meta">@RequestParam(name = &quot;city_name&quot;)</span> String cityEnName)</span> &#123;</span><br><span class="line">        ServiceMultiResult&lt;SupportAddressDTO&gt; addressResult = addressService.findAllRegionsByCityName(cityEnName);</span><br><span class="line">        <span class="keyword">if</span> (addressResult.getResult() == <span class="literal">null</span> || addressResult.getTotal() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(addressResult.getResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取具体城市所支持的地铁线路</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cityEnName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/subway/line&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportSubwayLine</span><span class="params">(<span class="meta">@RequestParam(name = &quot;city_name&quot;)</span> String cityEnName)</span> &#123;</span><br><span class="line">        List&lt;SubwayDTO&gt; subways = addressService.findAllSubwayByCity(cityEnName);</span><br><span class="line">        <span class="keyword">if</span> (subways.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(subways);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对应地铁线路所支持的地铁站点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subwayId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;address/support/subway/station&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">getSupportSubwayStation</span><span class="params">(<span class="meta">@RequestParam(name = &quot;subway_id&quot;)</span> Long subwayId)</span> &#123;</span><br><span class="line">        List&lt;SubwayStationDTO&gt; stationDTOS = addressService.findAllStationBySubway(subwayId);</span><br><span class="line">        <span class="keyword">if</span> (stationDTOS.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofSuccess(stationDTOS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;rent/house&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">rentHousePage</span><span class="params">(<span class="meta">@ModelAttribute</span> RentSearch rentSearch,</span></span><br><span class="line"><span class="params">                                Model model, HttpSession httpSession,</span></span><br><span class="line"><span class="params">                                RedirectAttributes redirectAttributes)</span>&#123;</span><br><span class="line">        <span class="comment">//表单中先验证有没有城市</span></span><br><span class="line">        <span class="keyword">if</span>(rentSearch.getCityEnName() ==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//从session中获取城市</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cityEnNameInSession</span> <span class="operator">=</span> (String) httpSession.getAttribute(<span class="string">&quot;cityEnName&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(cityEnNameInSession == <span class="literal">null</span>)&#123;</span><br><span class="line">                redirectAttributes.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;must_chose_city&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//从session里面读出来并设置到form表单中</span></span><br><span class="line">                rentSearch.setCityEnName(cityEnNameInSession);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            httpSession.setAttribute(<span class="string">&quot;cityEnName&quot;</span>,rentSearch.getCityEnName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ServiceResult&lt;SupportAddressDTO&gt; city = addressService.queryCity(rentSearch.getCityEnName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( !city.isSuccess())&#123;</span><br><span class="line">            redirectAttributes.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;must_chose_city&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentCity&quot;</span>, city.getResult());</span><br><span class="line"></span><br><span class="line">        ServiceMultiResult&lt;SupportAddressDTO&gt; addressResult = addressService.findAllRegionsByCityName(rentSearch.getCityEnName());</span><br><span class="line">        <span class="keyword">if</span>(addressResult.getTotal() &lt; <span class="number">1</span> ||addressResult.getResult() == <span class="literal">null</span>)&#123;</span><br><span class="line">            redirectAttributes.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;must_chose_city&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ServiceMultiResult&lt;HouseDTO&gt; serviceMultiResult = houseService.query(rentSearch);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置一些页面的信息</span></span><br><span class="line"><span class="comment">//        model.addAttribute(&quot;total&quot;,serviceMultiResult.getTotal());</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;total&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;houses&quot;</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果用户没有设置区域，那么就默认选择所有区域的进行展示</span></span><br><span class="line">        <span class="keyword">if</span>(rentSearch.getRegionEnName() ==<span class="literal">null</span>)&#123;</span><br><span class="line">            rentSearch.setRegionEnName(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//每次查完都会把这个放在searchbody中防止用户刷新页面后，为其重新加载搜索结果</span></span><br><span class="line">        <span class="comment">//在前端的逻辑是，我们把后端发送的serachbody数据读取好了后传入到js中然后拼接后再传到后端整理成一个url重新请求</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;searchBody&quot;</span>,rentSearch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//区域信息</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;regions&quot;</span>, addressResult.getResult());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//并且设置价格区间，对于区间正式开发中要存放在数据库里面的，这里我们先简单固化在内存中。</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;priceBlocks&quot;</span>, RentValueBLock.PRICE_BLOCK);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置面积区间</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;areaBlocks&quot;</span>,RentValueBLock.AREA_BLOCK);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//另外还要设置当前的搜索条件，不能说翻了页之后就不带着这个搜索条件了</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentPriceBlock&quot;</span>,RentValueBLock.matchPrice(rentSearch.getPriceBlock()));</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentAreaBlock&quot;</span>,RentValueBLock.matchArea(rentSearch.getAreaBlock()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;rent-list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>然后我们去新建一个区间范围类，参数，以及方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.ImmutableMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 带区间的常用数值定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RentValueBLock</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 价格区间定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, RentValueBLock&gt; PRICE_BLOCK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 面积区间定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, RentValueBLock&gt; AREA_BLOCK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无限制区间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">RentValueBLock</span> <span class="variable">ALL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RentValueBLock</span>(<span class="string">&quot;*&quot;</span>,-<span class="number">1</span>,-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        PRICE_BLOCK = ImmutableMap.&lt;String, RentValueBLock&gt;builder()</span><br><span class="line">                <span class="comment">//设置最小值-1到1000区间范围</span></span><br><span class="line">                .put(<span class="string">&quot;*-1000&quot;</span>,<span class="keyword">new</span> <span class="title class_">RentValueBLock</span>(<span class="string">&quot;*-1000&quot;</span>,-<span class="number">1</span>,<span class="number">1000</span>))</span><br><span class="line">                <span class="comment">//设置1000到3000的区间范围</span></span><br><span class="line">                .put(<span class="string">&quot;1000-3000&quot;</span>, <span class="keyword">new</span> <span class="title class_">RentValueBLock</span>(<span class="string">&quot;1000-3000&quot;</span>,<span class="number">1000</span>,<span class="number">3000</span>))</span><br><span class="line">                <span class="comment">//设置3000到无限制的区间范围</span></span><br><span class="line">                .put(<span class="string">&quot;3000-*&quot;</span>, <span class="keyword">new</span> <span class="title class_">RentValueBLock</span>(<span class="string">&quot;3000-*&quot;</span>,<span class="number">3000</span>,-<span class="number">1</span>))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        AREA_BLOCK = ImmutableMap.&lt;String, RentValueBLock&gt;builder()</span><br><span class="line">                <span class="comment">//设置最小值-1到1000区间范围</span></span><br><span class="line">                .put(<span class="string">&quot;*-30&quot;</span>,<span class="keyword">new</span> <span class="title class_">RentValueBLock</span>(<span class="string">&quot;*-30&quot;</span>,-<span class="number">1</span>,<span class="number">30</span>))</span><br><span class="line">                <span class="comment">//设置1000到3000的区间范围</span></span><br><span class="line">                .put(<span class="string">&quot;30-50&quot;</span>, <span class="keyword">new</span> <span class="title class_">RentValueBLock</span>(<span class="string">&quot;30-50&quot;</span>,<span class="number">30</span>,<span class="number">50</span>))</span><br><span class="line">                <span class="comment">//设置3000到无限制的区间范围</span></span><br><span class="line">                .put(<span class="string">&quot;50-*&quot;</span>, <span class="keyword">new</span> <span class="title class_">RentValueBLock</span>(<span class="string">&quot;50-*&quot;</span>,<span class="number">50</span>,-<span class="number">1</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> min;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> max;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RentValueBLock</span><span class="params">(String key, <span class="type">int</span> min, <span class="type">int</span> max)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="built_in">this</span>.min = min;</span><br><span class="line">        <span class="built_in">this</span>.max = max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//因为是javaBean所以需要定义一些get、set方法</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> min;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMin</span><span class="params">(<span class="type">int</span> min)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.min = min;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMax</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMax</span><span class="params">(<span class="type">int</span> max)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.max = max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//然后需要写一些方法执行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RentValueBLock <span class="title function_">matchPrice</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        <span class="comment">//首先通过key来获取到区间</span></span><br><span class="line">        <span class="type">RentValueBLock</span> <span class="variable">block</span> <span class="operator">=</span> PRICE_BLOCK.get(key);</span><br><span class="line">        <span class="comment">//判断区间是否存在，如果不存在，那么就返回一个全部的ALL区间</span></span><br><span class="line">        <span class="keyword">if</span>(block == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ALL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> block;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//面积区间匹配方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RentValueBLock <span class="title function_">matchArea</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        <span class="comment">//首先通过key来获取到区间</span></span><br><span class="line">        <span class="type">RentValueBLock</span> <span class="variable">block</span> <span class="operator">=</span> AREA_BLOCK.get(key);</span><br><span class="line">        <span class="comment">//判断区间是否存在，如果不存在，那么就返回一个全部的ALL区间</span></span><br><span class="line">        <span class="keyword">if</span>(block == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ALL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> block;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//当然还可以写一些其他的区间筛选办法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后返回到controller中去编辑范围区间的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//并且设置价格区间，对于区间正式开发中要存放在数据库里面的，这里我们先简单固化在内存中。</span></span><br><span class="line">model.addAttribute(<span class="string">&quot;priceBlocks&quot;</span>, RentValueBLock.PRICE_BLOCK);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置面积区间</span></span><br><span class="line">model.addAttribute(<span class="string">&quot;areaBlocks&quot;</span>,RentValueBLock.AREA_BLOCK);</span><br><span class="line"></span><br><span class="line"><span class="comment">//另外还要设置当前的搜索条件，不能说翻了页之后就不带着这个搜索条件了</span></span><br><span class="line">model.addAttribute(<span class="string">&quot;currentPriceBlock&quot;</span>,RentValueBLock.matchPrice(rentSearch.getPriceBlock()));</span><br><span class="line"></span><br><span class="line">model.addAttribute(<span class="string">&quot;currentAreaBlock&quot;</span>,RentValueBLock.matchArea(rentSearch.getAreaBlock()));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;rent-list&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>因为我们的houseServiceImpl中的query并未具体实现，所以先测试一下其他代码，结果如下：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5oztbly0aj21kg0u0why.jpg"
alt="image-20220830185856406" />
<figcaption aria-hidden="true">image-20220830185856406</figcaption>
</figure>
<p>其中model.addAttribute("total",10);设置了一个固定的值，原来是model.addAttribute("total",serviceMultiResult.getTotal());</p>
<p>因为结果是空的，所以getTotal的话会报错。暂时先设定一个静态值。</p>
<blockquote>
<p>注意这里的一个细节</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(addressResult.getTotal() &lt; <span class="number">1</span> ||addressResult.getResult() == <span class="literal">null</span>)&#123;</span><br><span class="line">    redirectAttributes.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;must_chose_city&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当判断条件成立的时候，那么url链接地址显示的是：http://localhost:8080/index?msg=must_chose_city</p>
<p>也就是redirect到了index.html页，然后添加了msg参数。重新请求url。</p>
<p>上面我们定义的query是一个空的，所以现在我们去定义具体的serviceImpl实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">query</span><span class="params">(RentSearch rentSearch)</span> &#123;</span><br><span class="line">    <span class="comment">//定义排序字段类</span></span><br><span class="line">    <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sort</span>(Sort.Direction.DESC, <span class="string">&quot;lastUpdateTime&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义页面</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> rentSearch.getStart() / rentSearch.getSize();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//* @param page 页面开始的序号</span></span><br><span class="line">    <span class="comment">//  * @param size 页面需要返回的数量</span></span><br><span class="line">    <span class="comment">//  * @param sort sort类</span></span><br><span class="line">    <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageRequest</span>(page, rentSearch.getSize(), sort);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//然后还需要定义特殊条件，比如逻辑删除的数据不被查询出来，根据状态、城市名称等</span></span><br><span class="line">    Specification&lt;House&gt; specification = (root, criteriaQuery, criteriaBuilder) -&gt;&#123;</span><br><span class="line">        <span class="type">Predicate</span> <span class="variable">predicate</span> <span class="operator">=</span> criteriaBuilder.equal(root.get(<span class="string">&quot;status&quot;</span>), HouseStatus.PASSES.getValue());</span><br><span class="line">        criteriaBuilder.and(predicate,criteriaBuilder.equal(root.get(<span class="string">&quot;cityEnName&quot;</span>),rentSearch.getCityEnName()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> predicate;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里我们使用的JPA的findAll，传递的参数第一个是特殊查询变量，第二个是分页</span></span><br><span class="line">    Page&lt;House&gt; houses = houseRepository.findAll(specification, pageable);</span><br><span class="line">    <span class="comment">//因为返回的是一个list列表的形式，所以我们这里要定义一个HouseDTO类型的列表</span></span><br><span class="line">    ArrayList&lt;HouseDTO&gt; houseDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    houses.forEach(house -&gt; &#123;</span><br><span class="line">        <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> modelMapper.map(house, HouseDTO.class);</span><br><span class="line">        <span class="comment">//奇怪的是这里为什么要重复的去设置下cover呢。初步猜测原因是cover有时候会更新不出来，所以做一个异步的延时加载</span></span><br><span class="line">        houseDTO.setCover(<span class="built_in">this</span>.cdnPrefix + house.getCover());</span><br><span class="line">        houseDTOS.add(houseDTO);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//最后返回ServiceMultiResult</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span>  <span class="title class_">ServiceMultiResult</span>&lt;&gt;(houses.getTotalElements(), houseDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>serviceimpl实现了，那么我们返回controller层中对返回的结果进行修改（之前定义的是一个null值）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">//设置一些页面的信息</span></span><br><span class="line"><span class="comment">//        model.addAttribute(&quot;total&quot;,serviceMultiResult.getTotal());</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;total&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;houses&quot;</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br></pre></td></tr></table></figure>
<p>修改后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ServiceMultiResult&lt;HouseDTO&gt; serviceMultiResult = houseService.query(rentSearch);</span><br><span class="line"></span><br><span class="line">model.addAttribute(<span class="string">&quot;total&quot;</span>, serviceMultiResult.getTotal());</span><br><span class="line">model.addAttribute(<span class="string">&quot;houses&quot;</span>, serviceMultiResult.getResult());</span><br></pre></td></tr></table></figure>
<p>但是这里的houses并未把houseDetail的信息添加进去，所以导致了前端页面的错乱：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5r8nws4k3j21l30u0jum.jpg"
alt="image-20220901173616255" />
<figcaption aria-hidden="true">image-20220901173616255</figcaption>
</figure>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2022-09-01 17:35:48.071 ERROR 29197 --- [nio-8080-exec-5] org.thymeleaf.TemplateEngine             : [THYMELEAF][http-nio-8080-exec-5] Exception processing template &quot;rent-list&quot;: Exception evaluating SpringEL expression: &quot;house.houseDetail.subwayLineName != null&quot; (template: &quot;rent-list&quot; - line 269, col 55)</span><br><span class="line"></span><br><span class="line">org.thymeleaf.exceptions.TemplateProcessingException: Exception evaluating SpringEL expression: &quot;house.houseDetail.subwayLineName != null&quot; (template: &quot;rent-list&quot; - line 269, col 55)</span><br></pre></td></tr></table></figure>
<p>也就是说在传给前端参数的时候并没有house.houseDetail这个变量，所以导致了页面的错乱。</p>
<p>所以暂时把house.houseDetail这个属性给注释掉，因为点击房子后详情的信息才能够展示出来，在rent-list这个页面上并无房屋详情页的信息展示。后续会做一个封装的操作类把houseDetail传递给前端页面进行渲染。</p>
<p>我们对房源列表的排序设计一个排序类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Sets;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 排序生成器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseSort</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_SORT_KEY</span> <span class="operator">=</span> <span class="string">&quot;lastUpdateTime&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DISTANCE_TO_SUBWAY_KEY</span> <span class="operator">=</span> <span class="string">&quot;distanceToSubway&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义排序的字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; SORT_KEYS = Sets.newHashSet(</span><br><span class="line">            DEFAULT_SORT_KEY,</span><br><span class="line">            <span class="string">&quot;createTime&quot;</span>,</span><br><span class="line">            <span class="string">&quot;price&quot;</span>,</span><br><span class="line">            <span class="string">&quot;area&quot;</span>,</span><br><span class="line">            DISTANCE_TO_SUBWAY_KEY</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成排序策略（加入了一些默认的设计逻辑）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Sort <span class="title function_">generateSort</span><span class="params">(String key, String directionKey)</span>&#123;</span><br><span class="line">        key = getSortKey(key);</span><br><span class="line"></span><br><span class="line">        Sort.<span class="type">Direction</span> <span class="variable">direction</span> <span class="operator">=</span> Sort.Direction.fromStringOrNull(directionKey);</span><br><span class="line">        <span class="keyword">if</span>(direction == <span class="literal">null</span>)&#123;</span><br><span class="line">            direction = Sort.Direction.DESC;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sort</span>(direction, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSortKey</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!SORT_KEYS.contains(key))&#123;</span><br><span class="line">            key = DEFAULT_SORT_KEY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在houseServiceimpl中我们就可以修改排序变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">query</span><span class="params">(RentSearch rentSearch)</span> &#123;</span><br><span class="line">        <span class="comment">//定义排序字段类</span></span><br><span class="line"><span class="comment">//        Sort sort = new Sort(Sort.Direction.DESC, &quot;lastUpdateTime&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义页面</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> rentSearch.getStart() / rentSearch.getSize();</span><br></pre></td></tr></table></figure>
<p>修改后的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">query</span><span class="params">(RentSearch rentSearch)</span> &#123;</span><br><span class="line">        <span class="comment">//定义排序字段类</span></span><br><span class="line"><span class="comment">//        Sort sort = new Sort(Sort.Direction.DESC, &quot;lastUpdateTime&quot;);</span></span><br><span class="line">        <span class="comment">//自定义的排序方法-修改后</span></span><br><span class="line">        <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> HouseSort.generateSort(rentSearch.getOrderBy(), rentSearch.getOrderDirection());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义页面</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> rentSearch.getStart() / rentSearch.getSize();</span><br></pre></td></tr></table></figure>
<p>另外呢，我们现在查询出来展示的只是house的信息，但是对于houseDetail的信息并未查询出来。</p>
<p>然后就把houseId加进去了，然后通过id去查询出相关的详情信息，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Long&gt; houseIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">Map&lt;Long, HouseDTO&gt; idToHouseMap = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里我们使用的JPA的findAll，传递的参数第一个是特殊查询变量，第二个是分页</span></span><br><span class="line">Page&lt;House&gt; houses = houseRepository.findAll(specification, pageable);</span><br><span class="line"><span class="comment">//因为返回的是一个list列表的形式，所以我们这里要定义一个HouseDTO类型的列表</span></span><br><span class="line">ArrayList&lt;HouseDTO&gt; houseDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">houses.forEach(house -&gt; &#123;</span><br><span class="line">    <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> modelMapper.map(house, HouseDTO.class);</span><br><span class="line">    <span class="comment">//奇怪的是这里为什么要重复的去设置下cover呢。初步猜测原因是cover有时候会更新不出来，所以做一个异步的延时加载</span></span><br><span class="line">    houseDTO.setCover(<span class="built_in">this</span>.cdnPrefix + house.getCover());</span><br><span class="line">    houseDTOS.add(houseDTO);</span><br><span class="line">    houseIds.add(house.getId());</span><br><span class="line">    idToHouseMap.put(house.getId(),houseDTO);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wrapperHouseList(houseIds,idToHouseMap);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 渲染详细信息 及标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> houseIds</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> idToHouseMap</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">wrapperHouseList</span><span class="params">(List&lt;Long&gt; houseIds, Map&lt;Long, HouseDTO&gt; idToHouseMap)</span> &#123;</span><br><span class="line">    List&lt;HouseDetail&gt; details = houseDetailRepository.findAllByHouseIdIn(houseIds);</span><br><span class="line">    details.forEach(houseDetail -&gt; &#123;</span><br><span class="line">        <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> idToHouseMap.get(houseDetail.getHouseId());</span><br><span class="line">        <span class="type">HouseDetailDTO</span> <span class="variable">houseDetailDTO</span> <span class="operator">=</span> modelMapper.map(houseDetail, HouseDetailDTO.class);</span><br><span class="line">        houseDTO.setHouseDetail(houseDetailDTO);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    List&lt;HouseTag&gt; houseTags = houseTagRepository.findAllByHouseIdIn(houseIds);</span><br><span class="line">    houseTags.forEach(houseTag -&gt; &#123;</span><br><span class="line">        <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> idToHouseMap.get(houseTag.getHouseId());</span><br><span class="line">       houseDTO.getTags().add(houseTag.getName());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外：</p>
<p>对于距离地铁最近的排序，要加一个判断条件，就是如果要按照地铁距离进行排序的话，那么就判断HouseSort.DISTANCE_to_SUBWAY_KEY字段必须大于-1，如果不添加这个判断的话，那么倒排的话，-1始终是在最前面的。</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5y3uabd5dj20zg0u0427.jpg" alt="image-20220907160821320" style="zoom: 50%;" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Specification&lt;House&gt; specification = (root, criteriaQuery, criteriaBuilder) -&gt; &#123;</span><br><span class="line">    Predicate predicate = criteriaBuilder.equal(root.get(&quot;status&quot;), HouseStatus.PASSES.getValue());</span><br><span class="line"></span><br><span class="line">    predicate = criteriaBuilder.and(predicate, criteriaBuilder.equal(root.get(&quot;cityEnName&quot;), rentSearch.getCityEnName()));</span><br><span class="line"></span><br><span class="line">    if (HouseSort.DISTANCE_TO_SUBWAY_KEY.equals(rentSearch.getOrderBy())) &#123;</span><br><span class="line">        predicate = criteriaBuilder.and(predicate, criteriaBuilder.gt(root.get(HouseSort.DISTANCE_TO_SUBWAY_KEY), -1));</span><br><span class="line">    &#125;</span><br><span class="line">    return predicate;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="二十九房源信息详情页">二十九、房源信息详情页</h2>
<p>上节中我们把房源信息列表查询出来了，那么接下来用户需要点击链接查看详情。</p>
<p>首先我们定义一个GetMapping的url：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;rent/house/show/&#123;id&#125;&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;rent/house/show/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">show</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span>, Long houseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(houseId &lt;= <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;404&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ServiceResult&lt;HouseDTO&gt; serviceResult = houseService.findCompleteOne(houseId);</span><br><span class="line">    <span class="keyword">if</span>(!serviceResult.isSuccess())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;404&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> serviceResult.getResult();</span><br><span class="line">    Map&lt;SupportAddress.Level, SupportAddressDTO&gt; addressMap = addressService.findCityAndRegion(houseDTO.getCityEnName(), houseDTO.getRegionEnName());</span><br><span class="line"></span><br><span class="line">    <span class="type">SupportAddressDTO</span> <span class="variable">city</span> <span class="operator">=</span> addressMap.get(SupportAddress.Level.CITY);</span><br><span class="line">    <span class="type">SupportAddressDTO</span> <span class="variable">region</span> <span class="operator">=</span> addressMap.get(SupportAddress.Level.REGION);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//另外还需要添加一个房屋管理员，或者是经纪人来管理的。</span></span><br><span class="line">    userService.findUserById(houseDTO.getAdminId());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;house-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在userService接口类中去定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  用户服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line">    User <span class="title function_">findUserByUsername</span><span class="params">(String username)</span>;</span><br><span class="line"></span><br><span class="line">    ServiceResult&lt;UserDTO&gt; <span class="title function_">findUserById</span><span class="params">(Long userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这里UserDTO并未定义，所以我们去定义UserDTO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.web.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String avatar;</span><br><span class="line">    <span class="keyword">private</span> String phoneNumber;</span><br><span class="line">    <span class="keyword">private</span> String lastLoginTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAvatar</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> avatar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAvatar</span><span class="params">(String avatar)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.avatar = avatar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPhoneNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> phoneNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPhoneNumber</span><span class="params">(String phoneNumber)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.phoneNumber = phoneNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLastLoginTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lastLoginTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLastLoginTime</span><span class="params">(String lastLoginTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lastLoginTime = lastLoginTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后去实现UserService的Impl实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult&lt;UserDTO&gt; <span class="title function_">findUserById</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userRepository.findOne(userId);</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceResult.notFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> modelMapper.map(user, UserDTO.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ServiceResult.of(userDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的houseController的show方法代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;rent/house/show/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">show</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span> Long houseId,</span></span><br><span class="line"><span class="params">                   Model model)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(houseId &lt;= <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;404&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ServiceResult&lt;HouseDTO&gt; serviceResult = houseService.findCompleteOne(houseId);</span><br><span class="line">    <span class="keyword">if</span>(!serviceResult.isSuccess())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;404&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> serviceResult.getResult();</span><br><span class="line">    Map&lt;SupportAddress.Level, SupportAddressDTO&gt; addressMap = addressService.findCityAndRegion(houseDTO.getCityEnName(), houseDTO.getRegionEnName());</span><br><span class="line"></span><br><span class="line">    <span class="type">SupportAddressDTO</span> <span class="variable">city</span> <span class="operator">=</span> addressMap.get(SupportAddress.Level.CITY);</span><br><span class="line">    <span class="type">SupportAddressDTO</span> <span class="variable">region</span> <span class="operator">=</span> addressMap.get(SupportAddress.Level.REGION);</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">&quot;city&quot;</span>,city);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;region&quot;</span>,region);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//另外还需要添加一个房屋管理员，或者是经纪人来管理的。</span></span><br><span class="line">    ServiceResult&lt;UserDTO&gt; userDTOServiceResult = userService.findUserById(houseDTO.getAdminId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//经纪人相关的信息</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;agent&quot;</span>,userDTOServiceResult.getResult());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;house&quot;</span>,houseDTO);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;house-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后的结果如下图所示：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5y7vk496dj21jm0u0dj5.jpg"
alt="image-20220907182800817" />
<figcaption aria-hidden="true">image-20220907182800817</figcaption>
</figure>
<p>不过其中关于详情中，共有*套出租中
这个接口并未实现。这个会在es中进行聚合的字段。</p>
<h2
id="三十搜索引擎实现-业务与功能分析">三十、搜索引擎实现-业务与功能分析</h2>
<h3 id="搜索引擎实现">搜索引擎实现</h3>
<p>在我们网站实现了<strong>基础信息浏览功能</strong>以后，用户就可以看到网站上的所有房源，但是在网站房源<strong>信息量爆炸</strong>的时候，用户是很难找到自己想要的信息的，这时候，网站就必须要有<strong>站内搜索引擎功能</strong>，帮助用户根据用户自身的需求快速找到想要的房源信息。那么，我们这一章节实现网站的<strong>搜索引擎</strong>。</p>
<blockquote>
<p>实现目标</p>
</blockquote>
<ul>
<li>构建ES房源索引</li>
<li>基于ES构建搜索引擎</li>
<li>解决中文分词问题</li>
<li>Search-as-you-type（搜索提示）</li>
<li>使搜索引擎结果集最优</li>
</ul>
<h2 id="三十一es与mysql技术选型">三十一、ES与MySQL技术选型</h2>
<h3
id="elasticsearch与mysql实现搜索对比">ElasticSearch与MySQL实现搜索对比</h3>
<p>mysql是做数据存储，来实现数据事务的特性。那么使用mysql构建搜索引擎的困境：</p>
<p>如果想要复杂查询就需要写很复杂的sql语句去做联表查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> house <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span> house_detail <span class="keyword">as</span> b <span class="keyword">on</span> a.id <span class="operator">=</span> b.house_id</span><br><span class="line"><span class="keyword">where</span> a.title <span class="keyword">like</span> <span class="string">&#x27;%国贸%&#x27;</span> <span class="keyword">AND</span> b.round_service <span class="keyword">like</span> <span class="string">&#x27;%故宫%&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h5yypgk75jj217b0jjgo0.jpg" alt="image-20220908095617560" style="zoom:50%;" /></p>
<p>那么就可以看到我们查询两个条件就需要用到了两个联表查询。非常麻烦。</p>
<p>如果还有其他条件，比如暖气、路线等等，那么就非常的麻烦了。</p>
<p>当然可以使用phoneix加mysql来实现搜索，具体的链接可以查看：https://baijiahao.baidu.com/s?id=1708618149251629430&amp;wfr=spider&amp;for=pc</p>
<blockquote>
<h6
id="phoenix是一个基于hbase的开源sql引擎可以使用标准的jdbc-api代替hbase客户端api来创建表插入数据查询你的hbase数据它是完全使用java编写作为hbase内嵌的jdbc驱动使用">Phoenix是一个基于HBase的开源<strong>SQL引擎</strong>，可以使用标准的JDBC
API代替HBase客户端API来创建表，插入数据，查询你的HBase数据，它是完全使用Java编写，作为HBase内嵌的JDBC驱动使用。</h6>
<p><strong>Phoenix查询引擎会将SQL查询转换为一个或多个HBase扫描，并编排执行以生成标准的JDBC结果集。</strong></p>
<h6
id="直接使用hbase-api协同处理器与自定义过滤器对于简单查询来说其性能量级是毫秒对于百万级别的行数来说其性能量级">直接使用HBase
API、协同处理器与自定义过滤器，对于简单查询来说，其性能量级是毫秒，对于百万级别的行数来说，其性能量级</h6>
<h6 id="是秒">是秒。</h6>
</blockquote>
<ul>
<li>使用MySQL构建搜索引擎的困境</li>
<li>使用ES的优点</li>
</ul>
<h2 id="三十二索引结构设计">三十二、索引结构设计</h2>
<blockquote>
<p>目标房源信息的索引结构如何设计？</p>
</blockquote>
<p>首先要实现对信息的检索，哪些信息是用户比较需要的，是他们想要去检索的。</p>
<p>然后启动es和es-head</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;house&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>   <span class="comment">//tag</span></span><br><span class="line">			<span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span>  <span class="comment">//索引不希望它变动，所以设置为false</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>    <span class="comment">//设置索引的属性</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>       <span class="comment">//字段设置</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analyzed&quot;</span>   <span class="comment">//需要被分析的</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;area&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> 		 <span class="comment">//不只搜索相关信息，还需要做排序</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastUpdateTime&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cityEnName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span>  <span class="comment">//城市名称不需要分词</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regionEnName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span>   </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span>  <span class="comment">//方向是固定的 1 2 3 4等来表示</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;distanceToSubway&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span>   <span class="comment">//距离地铁的距离</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;subwayLineName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;subwayStationName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span>   <span class="comment">//虽然是一个数组，在es中存储一个数组完全可以用一个单字段来存储的</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;district&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span>   <span class="comment">//需要被分析的</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;layoutDesc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>     <span class="comment">//展示的文本描述</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;traffic&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>    <span class="comment">//交通情况</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;roundService&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>   <span class="comment">//周边的服务</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;rentWay&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>基本的索引结构就如上面这个样子。</p>
<p>另外呢还不能直接创建，目前只有一个节点，默认是有5个分片、1个备份的。如果备份没有另外一台机器去存放的话，就会报状态是黄色。所以呢我们需要在前面添加一个：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>所以完整的json是：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;house&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>   <span class="comment">//tag</span></span><br><span class="line">			<span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span>  <span class="comment">//索引不希望它变动，所以设置为false</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>    <span class="comment">//设置索引的属性</span></span><br><span class="line">        <span class="attr">&quot;houseId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>       <span class="comment">//字段设置</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analyzed&quot;</span>   <span class="comment">//需要被分析的</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;area&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> 		 <span class="comment">//不只搜索相关信息，还需要做排序</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastUpdateTime&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cityEnName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span>  <span class="comment">//城市名称不需要分词</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regionEnName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span>   </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span>  <span class="comment">//方向是固定的 1 2 3 4等来表示</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;distanceToSubway&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span>   <span class="comment">//距离地铁的距离</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;subwayLineName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;subwayStationName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span>   <span class="comment">//虽然是一个数组，在es中存储一个数组完全可以用一个单字段来存储的</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;district&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span>   <span class="comment">//需要被分析的</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;layoutDesc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>     <span class="comment">//展示的文本描述</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;traffic&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>    <span class="comment">//交通情况</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;roundService&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>   <span class="comment">//周边的服务</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;rentWay&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意上面的是number_of_replicas，而不是number_of_replica。</p>
</blockquote>
<p>然后在IDEA编译器中发送request请求：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">PUT http<span class="punctuation">:</span><span class="comment">//localhost:9200/house</span></span><br><span class="line">Accept<span class="punctuation">:</span> text/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;house&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;houseId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Long&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;area&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>	<span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastUpdateTime&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cityEnName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regionEnName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;distanceToSubway&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;subwayLineName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;subwayStationName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;district&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;layoutDesc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;traffic&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;roundService&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;rentWay&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>得到的结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http<span class="punctuation">:</span><span class="comment">//localhost:9200/house</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Warning<span class="punctuation">:</span> <span class="number">299</span> Elasticsearch<span class="number">-5.6</span><span class="number">.1</span><span class="number">-667</span>b497 <span class="string">&quot;Content type detection for rest requests is deprecated. Specify the content type using the [Content-Type] header.&quot;</span> <span class="string">&quot;Tue, 13 Sep 2022 06:14:50 GMT&quot;</span></span><br><span class="line">Warning<span class="punctuation">:</span> <span class="number">299</span> Elasticsearch<span class="number">-5.6</span><span class="number">.1</span><span class="number">-667</span>b497 <span class="string">&quot;Expected a boolean [true/false] for property [index] but got [analyzed]&quot;</span> <span class="string">&quot;Tue, 13 Sep 2022 06:14:50 GMT&quot;</span></span><br><span class="line">content-type<span class="punctuation">:</span> application/json; charset=UTF<span class="number">-8</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;house&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">Response file saved.</span><br><span class="line">&gt; <span class="number">2022</span><span class="number">-09</span><span class="number">-13</span>T141450<span class="number">.200</span>.json</span><br><span class="line"></span><br><span class="line">Response code<span class="punctuation">:</span> <span class="number">200</span> (OK); Time<span class="punctuation">:</span> <span class="number">392</span>ms; Content length<span class="punctuation">:</span> <span class="number">64</span> bytes</span><br></pre></td></tr></table></figure>
<p>在es-head中查看结果：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h64ycpzt0ej20xd0bxjtb.jpg"
alt="image-20220913141723776" />
<figcaption aria-hidden="true">image-20220913141723776</figcaption>
</figure>
<p>发现house索引已经被创建成功。</p>
<p>然后将这个house_index_mapping.json保存在db文件夹下。</p>
<p>另外，我们不能直接使用es把数据存入进去，因为es是弱事务性的，在有增删改的时候会导致其产生很多乱糟糟的数据，当然这里我们使用es只是为了查出其索引来，并不是查询出其每个字段来。所以es对于我们来说只是检索其id，所以我们要得到的其实是他们的house_id，然后再到mysql中去查询出来。</p>
<p>另外呢我们需要单独在java代码中新建一个类去操纵es代码，而不是去操作json代码。</p>
<p>我们在service中新建一个search包，并新建一个索引结构模板：HouseIndexTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.service.search;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 索引结构模板</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseIndexTemplate</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long houseId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> area;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date lastUpdateTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cityEnName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String regionEnName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> direction;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> distanceToSubway;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String subwayLineName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String subwayStationName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String street;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String district;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String layoutDesc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String traffic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String roundService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> rentWay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; tags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getHouseId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> houseId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHouseId</span><span class="params">(Long houseId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.houseId = houseId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTitle</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrice</span><span class="params">(<span class="type">int</span> price)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getArea</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> area;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setArea</span><span class="params">(<span class="type">int</span> area)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.area = area;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getLastUpdateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lastUpdateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLastUpdateTime</span><span class="params">(Date lastUpdateTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lastUpdateTime = lastUpdateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCityEnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cityEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCityEnName</span><span class="params">(String cityEnName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cityEnName = cityEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRegionEnName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> regionEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRegionEnName</span><span class="params">(String regionEnName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.regionEnName = regionEnName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDirection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> direction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDirection</span><span class="params">(<span class="type">int</span> direction)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.direction = direction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDistanceToSubway</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> distanceToSubway;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDistanceToSubway</span><span class="params">(<span class="type">int</span> distanceToSubway)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.distanceToSubway = distanceToSubway;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSubwayLineName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> subwayLineName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSubwayLineName</span><span class="params">(String subwayLineName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subwayLineName = subwayLineName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSubwayStationName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> subwayStationName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSubwayStationName</span><span class="params">(String subwayStationName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subwayStationName = subwayStationName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStreet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> street;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStreet</span><span class="params">(String street)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.street = street;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDistrict</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> district;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDistrict</span><span class="params">(String district)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.district = district;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDescription</span><span class="params">(String description)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLayoutDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> layoutDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLayoutDesc</span><span class="params">(String layoutDesc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.layoutDesc = layoutDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTraffic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> traffic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTraffic</span><span class="params">(String traffic)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.traffic = traffic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRoundService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> roundService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoundService</span><span class="params">(String roundService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roundService = roundService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRentWay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rentWay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRentWay</span><span class="params">(<span class="type">int</span> rentWay)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rentWay = rentWay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getTags</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTags</span><span class="params">(List&lt;String&gt; tags)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tags = tags;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>另外我们还需要创建一个常量类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.service.search;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 索引关键字统一定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseIndexKey</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOUSE_ID</span> <span class="operator">=</span> <span class="string">&quot;houseId&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TITLE</span> <span class="operator">=</span> <span class="string">&quot;title&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRICE</span> <span class="operator">=</span> <span class="string">&quot;price&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AREA</span> <span class="operator">=</span> <span class="string">&quot;area&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CREATE_TIME</span> <span class="operator">=</span> <span class="string">&quot;createTime&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LAST_UPDATE_TIME</span> <span class="operator">=</span> <span class="string">&quot;lastUpdateTime&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CITY_EN_NAME</span> <span class="operator">=</span> <span class="string">&quot;cityEnName&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REGION_EN_NAME</span> <span class="operator">=</span> <span class="string">&quot;regionEnName&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECTION</span> <span class="operator">=</span> <span class="string">&quot;direction&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DISTANCE_TO_SUBWAY</span> <span class="operator">=</span> <span class="string">&quot;distanceToSubway&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STREET</span> <span class="operator">=</span> <span class="string">&quot;street&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DISTRICT</span> <span class="operator">=</span> <span class="string">&quot;district&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DESCRIPTION</span> <span class="operator">=</span> <span class="string">&quot;description&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LAYOUT_DESC</span> <span class="operator">=</span> <span class="string">&quot;layoutDesc&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TRAFFIC</span> <span class="operator">=</span> <span class="string">&quot;traffic&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUND_SERVICE</span> <span class="operator">=</span> <span class="string">&quot;roundService&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RENT_WAY</span> <span class="operator">=</span> <span class="string">&quot;rentWay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBWAY_LINE_NAME</span> <span class="operator">=</span> <span class="string">&quot;subwayLineName&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBWAY_STATION_NAME</span> <span class="operator">=</span> <span class="string">&quot;subwayStationName&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAGS</span> <span class="operator">=</span> <span class="string">&quot;tags&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立这样一个类方便我们后面在java代码中使用代码的形式去编辑，而不是使用json的方式去操作。</p>
<blockquote>
<p>ES更适合用来检索，Mysql更适合用来做存储</p>
</blockquote>
<h2 id="三十三索引构建-核心逻辑">三十三、索引构建-核心逻辑</h2>
<ul>
<li>核心逻辑实现</li>
<li>基于Kafka的异步构建</li>
</ul>
<h3 id="新建esconfig类">1、新建esConfig类</h3>
<p>然后设置目标地址 注意这里使用tcp的9300，而不是http的9200
原因不知.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TransportClient <span class="title function_">esClient</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException&#123;</span><br><span class="line">        <span class="type">Settings</span> <span class="variable">settings</span> <span class="operator">=</span> Settings.builder()</span><br><span class="line">                .put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;elasticsearch&quot;</span>)</span><br><span class="line">                .put(<span class="string">&quot;client.transport.sniff&quot;</span>, <span class="literal">true</span>)  <span class="comment">//自动发现节点</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//然后设置目标地址   注意这里使用tcp的9300，而不是http的9200 原因不知</span></span><br><span class="line">        <span class="type">InetSocketTransportAddress</span> <span class="variable">master</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketTransportAddress</span>(</span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9300</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//然后构建，把配置当进去，把地址放进去</span></span><br><span class="line">        <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(master);</span><br><span class="line"><span class="comment">//                .addTransportAddress(****)    当然这里可以把其他的节点加进来</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后新建ISearchService类，暂时增加检索、移除接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检索接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ISearchService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 索引目标房源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> houseId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">index</span><span class="params">(Long houseId)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除目标房源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> houseId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Long houseId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后编辑SearchServiceImpl实现类。</p>
<p><strong>注意要在里面添加logger的话，使用</strong></p>
<p><strong>private static final Logger logger =
LoggerFactory.getLogger(ISearchService.class);</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ISearchService</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ISearchService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HouseRepository houseRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ModelMapper modelMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">index</span><span class="params">(Long houseId)</span> &#123;</span><br><span class="line">        <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(houseId);</span><br><span class="line">        <span class="keyword">if</span>(house == <span class="literal">null</span>)&#123;</span><br><span class="line">             logger.error(<span class="string">&quot;index house &#123;&#125; does not exist&quot;</span>,houseId);</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">HouseIndexTemplate</span> <span class="variable">indexTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HouseIndexTemplate</span>();</span><br><span class="line">        modelMapper.map(house,indexTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//create</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//update</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//delete &amp; create</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Long houseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外呢我们还是用了log把错误输出，使用了modelMapper来把house类转换成houseIndexTemplate类。</p>
<p>另外我们不仅仅有index检索索引、移除索引，还得有创建索、更新索引。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">create</span><span class="params">(HouseIndexTemplate houseIndexTemplate)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">update</span><span class="params">(HouseIndexTemplate houseIndexTemplate)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">deleteAndCreate</span><span class="params">(HouseIndexTemplate houseIndexTemplate)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时候呢，我们需要用到刚才定义的esClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TransportClient esclient;</span><br></pre></td></tr></table></figure>
<p>这里关联到了我们之前定义的ElasticSearchConfig类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TransportClient <span class="title function_">esClient</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException&#123;</span><br><span class="line">        <span class="type">Settings</span> <span class="variable">settings</span> <span class="operator">=</span> Settings.builder()</span><br><span class="line">                .put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;elasticsearch&quot;</span>)</span><br><span class="line">                .put(<span class="string">&quot;client.transport.sniff&quot;</span>, <span class="literal">true</span>)  <span class="comment">//自动发现节点</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//然后设置目标地址   注意这里使用tcp的9300，而不是http的9200 原因不知</span></span><br><span class="line">        <span class="type">InetSocketTransportAddress</span> <span class="variable">master</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketTransportAddress</span>(</span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9300</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//然后构建，把配置当进去，把地址放进去</span></span><br><span class="line">        <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(master);</span><br><span class="line"><span class="comment">//                .addTransportAddress(****)    当然这里可以把其他的节点加进来</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义索引名称，定义索引类型，然后在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">create</span><span class="params">(HouseIndexTemplate houseIndexTemplate)</span>&#123;</span><br><span class="line">        esclient.prepareIndex(INDEX_NAME,INDEX_TYPE)</span><br><span class="line">                .setSource()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>需要使用TransportClient的esclient的prepareIndex方法，传入的参数是index_name、index_type，然后使用setSource来定义json代码，这里我们使用定义的HouseIndexTemplate类来使用json方法。我们使用obejctMapper来转换json。</p>
<p>所以需要自动注解:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ObjectMapper objectMapper;</span><br></pre></td></tr></table></figure>
<p>使用objectMapper.writeValueAsBytes(houseIndexTemplate)来对houseIndexTemplate转换格式，另外在es5.6中需要转换成json格式，所以我们在setSource中定义了一个XContentType.JSON的参数，然后其返回值是一个IndexResponse我们获取到这个response。</p>
<p>在下面进行判断，其有一个response.status，然后我们使用其与RestStatus.CREATED做比较。</p>
<p>其中对于RestStatus.CREATED，其enum值有很多。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">RestStatus</span> &#123;</span><br><span class="line">    CONTINUE(<span class="number">100</span>),</span><br><span class="line">    SWITCHING_PROTOCOLS(<span class="number">101</span>),</span><br><span class="line">    OK(<span class="number">200</span>),</span><br><span class="line">    CREATED(<span class="number">201</span>),</span><br><span class="line">    ACCEPTED(<span class="number">202</span>),</span><br><span class="line">    NON_AUTHORITATIVE_INFORMATION(<span class="number">203</span>),</span><br><span class="line">    NO_CONTENT(<span class="number">204</span>),</span><br><span class="line">    RESET_CONTENT(<span class="number">205</span>),</span><br><span class="line">    PARTIAL_CONTENT(<span class="number">206</span>),</span><br><span class="line">    MULTI_STATUS(<span class="number">207</span>),</span><br><span class="line">    MULTIPLE_CHOICES(<span class="number">300</span>),</span><br><span class="line">    MOVED_PERMANENTLY(<span class="number">301</span>),</span><br><span class="line">    FOUND(<span class="number">302</span>),</span><br><span class="line">    SEE_OTHER(<span class="number">303</span>),</span><br><span class="line">    NOT_MODIFIED(<span class="number">304</span>),</span><br><span class="line">    USE_PROXY(<span class="number">305</span>),</span><br><span class="line">    TEMPORARY_REDIRECT(<span class="number">307</span>),</span><br><span class="line">    BAD_REQUEST(<span class="number">400</span>),</span><br></pre></td></tr></table></figure>
<p>都是一些状态码什么的。</p>
<p>完整的create方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">create</span><span class="params">(HouseIndexTemplate houseIndexTemplate)</span>  &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">IndexResponse</span> <span class="variable">response</span> <span class="operator">=</span> esclient.prepareIndex(INDEX_NAME,INDEX_TYPE)</span><br><span class="line">                .setSource(objectMapper.writeValueAsBytes(houseIndexTemplate), XContentType.JSON).get();</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">&quot;Create index with house: &quot;</span>+ houseIndexTemplate.getHouseId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(response.status() == RestStatus.CREATED)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Error to index house &quot;</span> + houseIndexTemplate.getHouseId(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们去定义update方法，其逻辑同create大同小异。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">update</span><span class="params">(String esId,HouseIndexTemplate houseIndexTemplate)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UpdateResponse</span> <span class="variable">response</span> <span class="operator">=</span> esclient.prepareUpdate(INDEX_NAME,INDEX_TYPE,esId)</span><br><span class="line">                .setDoc(objectMapper.writeValueAsBytes(houseIndexTemplate), XContentType.JSON).get();</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">&quot;update index with house: &quot;</span>+ houseIndexTemplate.getHouseId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(response.status() == RestStatus.CREATED)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Error to update house &quot;</span> + houseIndexTemplate.getHouseId(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;sss</span><br></pre></td></tr></table></figure>
<p>只不过esclient不使用prepareIndex了而是使用prepareUpdate，然后需要多传入一个esId的参数，另外在json串那里也不是使用setSource，而是使用setDoc，另外返回的是UpdateResponse也不是IndexResponse了。另外RestStatus.CREATED也需要换成RestStatus.OK。</p>
<p>然后就是编写delete方法了，在5.0版本已经没有delete相关的直接接口了，所以我们使用deleteByQuery方法。</p>
<p>我们需要使用new
RequestBuilder方法，然后使用其filter方法，filter方法中query出来的东西都会被删除掉，</p>
<p>souce方法返回的是DeleteByQueryRequestBuilder，然后需要//通过buider.get来获得返回值，通过返回值去得到已删除的数量（long
deleted = response.getDeleted()
）所以我们需要在参数中接收一个总的需要删除的数量，最后再去做一个比较，如果不相等的话就报一个logger的警告，如果相等，那么就去调用create方法，把houseId当做参数传入进去创建。</p>
<p>最后的deleteAndCreate方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">deleteAndCreate</span><span class="params">(<span class="type">long</span> totalHit,HouseIndexTemplate houseIndexTemplate)</span>&#123;</span><br><span class="line">    <span class="type">DeleteByQueryRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> DeleteByQueryAction.INSTANCE</span><br><span class="line">            .newRequestBuilder(esclient)</span><br><span class="line">            .filter(QueryBuilders.termQuery(HouseIndexKey.HOUSE_ID, houseIndexTemplate.getHouseId()))    <span class="comment">//query出来的东西都会被删除掉</span></span><br><span class="line">            .source(INDEX_NAME);<span class="comment">//设置source，也就是索引名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">&quot;Delete by query for house:&quot;</span> + builder);</span><br><span class="line">    <span class="type">BulkByScrollResponse</span> <span class="variable">response</span> <span class="operator">=</span> builder.get();  <span class="comment">//通过buider.get来获得返回值</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">deleted</span> <span class="operator">=</span> response.getDeleted();  <span class="comment">//通过返回值去得到已删除的数量</span></span><br><span class="line">    <span class="keyword">if</span>(deleted != totalHit)&#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Need delete &#123;&#125; , but &#123;&#125; was deleted&quot;</span>,totalHit, deleted);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(houseIndexTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三十四索引构建-核心逻辑2">三十四、索引构建-核心逻辑2</h2>
<p>在我们的houseIndexTemplate中除了houseId之外，还有一些关于subway、subwayStation等在其他的表中。我们需要查出来，然后放进来。</p>
<p>所以我们把：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> HouseDetailRepository houseDetailRepository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> HouseTagRepository houseTagRepository;</span><br></pre></td></tr></table></figure>
<p>两个repository先自动装配进来。</p>
<p>然后把相关的信息查询出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HouseDetail</span> <span class="variable">houseDetail</span> <span class="operator">=</span> houseDetailRepository.findByHouseId(houseId);</span><br><span class="line"><span class="keyword">if</span>(houseDetail == <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="comment">// TODO 异常情况</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//然后呢把查询出来的detail映射到我们定义好的HouseIndexTemplate里面</span></span><br><span class="line">modelMapper.map(houseDetail,indexTemplate);</span><br><span class="line"></span><br><span class="line">List&lt;HouseTag&gt; tags = houseTagRepository.findAllById(houseId);</span><br><span class="line"><span class="keyword">if</span>(tags !=<span class="literal">null</span> &amp;&amp; !tags.isEmpty())&#123;</span><br><span class="line">    List&lt;String&gt; tagStrings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    tags.forEach(houseTag -&gt; tagStrings.add(houseTag.getName()));</span><br><span class="line">    indexTemplate.setTags(tagStrings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里来说，整个业务逻辑的查询就完成了，然后需要我们去查一下异常情况，比如数据是否在es中已经存在了，再去决定进行下一步的操作。</p>
<p>然后我们去esClient查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.esclient.prepareSearch(INDEX_NAME).setTypes(INDEX_TYPE)</span><br><span class="line">        .setQuery(QueryBuilders.termQuery(HouseIndexKey.HOUSE_ID, houseId));</span><br><span class="line"></span><br><span class="line">logger.debug(requestBuilder.toString());</span><br><span class="line"></span><br><span class="line"><span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> requestBuilder.get();</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">totalHit</span> <span class="operator">=</span> searchResponse.getHits().totalHits;</span><br></pre></td></tr></table></figure>
<p>然后再去判断totalHit命中的数量，如果0则创建、如果1则更新、如果其他则删除重建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">index</span><span class="params">(Long houseId)</span> &#123;</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(houseId);</span><br><span class="line">    <span class="keyword">if</span>(house == <span class="literal">null</span>)&#123;</span><br><span class="line">         logger.error(<span class="string">&quot;index house &#123;&#125; does not exist&quot;</span>,houseId);</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">HouseIndexTemplate</span> <span class="variable">indexTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HouseIndexTemplate</span>();</span><br><span class="line">    modelMapper.map(house,indexTemplate);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">HouseDetail</span> <span class="variable">houseDetail</span> <span class="operator">=</span> houseDetailRepository.findByHouseId(houseId);</span><br><span class="line">    <span class="keyword">if</span>(houseDetail == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">// TODO 异常情况</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//然后呢把查询出来的detail映射到我们定义好的HouseIndexTemplate里面</span></span><br><span class="line">    modelMapper.map(houseDetail,indexTemplate);</span><br><span class="line"></span><br><span class="line">    List&lt;HouseTag&gt; tags = houseTagRepository.findAllById(houseId);</span><br><span class="line">    <span class="keyword">if</span>(tags !=<span class="literal">null</span> &amp;&amp; !tags.isEmpty())&#123;</span><br><span class="line">        List&lt;String&gt; tagStrings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        tags.forEach(houseTag -&gt; tagStrings.add(houseTag.getName()));</span><br><span class="line">        indexTemplate.setTags(tagStrings);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从这里来说，整个业务逻辑的查询就完成了，然后需要我们去查一下异常情况，比如数据是否在es中已经存在了，再去决定进行下一步的操作。</span></span><br><span class="line"></span><br><span class="line">    <span class="type">SearchRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.esclient.prepareSearch(INDEX_NAME).setTypes(INDEX_TYPE)</span><br><span class="line">            .setQuery(QueryBuilders.termQuery(HouseIndexKey.HOUSE_ID, houseId));</span><br><span class="line"></span><br><span class="line">    logger.debug(requestBuilder.toString());</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> requestBuilder.get();</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">totalHit</span> <span class="operator">=</span> searchResponse.getHits().totalHits;</span><br><span class="line">    <span class="type">boolean</span> success;</span><br><span class="line">    <span class="keyword">if</span>(totalHit == <span class="number">0</span>)&#123;  <span class="comment">//如果没有的话，就需要创建</span></span><br><span class="line">        success = create(indexTemplate);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(totalHit ==<span class="number">1</span>)&#123;   <span class="comment">//如果有一个的情况，那就是需要更新</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">esId</span> <span class="operator">=</span> searchResponse.getHits().getAt(<span class="number">0</span>).getId();</span><br><span class="line">        success = update(esId,indexTemplate);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;   <span class="comment">//如果其他情况都没有的话（比如一条查出了多条重复的），那么就需要删除掉然后重新创建一条</span></span><br><span class="line">        success = deleteAndCreate(totalHit,indexTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(success)&#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Index success with house &quot;</span> + houseId);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试的时候报了这个错误：</p>
<p>NoNodeAvailableException None of the configured nodes are
available:</p>
<p>然后去追踪问题发现：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h66990s1sdj20jc06974n.jpg"
alt="image-20220914171955528" />
<figcaption aria-hidden="true">image-20220914171955528</figcaption>
</figure>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h669bvajkij20j40bwdh4.jpg"
alt="image-20220914172248936" />
<figcaption aria-hidden="true">image-20220914172248936</figcaption>
</figure>
<p>没有匹配上，所以修改elasticsearch为xunwu，再次尝试。</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h669zygi6bj20vd09fq3i.jpg"
alt="image-20220914174557710" />
<figcaption aria-hidden="true">image-20220914174557710</figcaption>
</figure>
<p>测试成功，总结：</p>
<p>在mapping中我们定义的是索引的名称：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h66a1nc5oij20a30dp0t4.jpg" alt="image-20220914174735343"  /></p>
<p>然后在代码中去定义索引的类型，这里当然是可以随意输入的，经测试输入house2，然后可以创建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.esclient.prepareSearch(INDEX_NAME).setTypes(INDEX_TYPE)</span><br><span class="line">        .setQuery(QueryBuilders.termQuery(HouseIndexKey.HOUSE_ID, houseId));</span><br></pre></td></tr></table></figure>
<p>哦对了，在test中因为我们使用的是application-test.properties
，所以是使用的h2内存数据库，直接在db文件夹下的sql文件修改就可以。</p>
<p>然后我们去定义remove方法逻辑：</p>
<p>​</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Long houseId)</span> &#123;</span><br><span class="line">    <span class="type">DeleteByQueryRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> DeleteByQueryAction.INSTANCE</span><br><span class="line">            .newRequestBuilder(esclient)</span><br><span class="line">            .filter(QueryBuilders.termQuery(HouseIndexKey.HOUSE_ID, houseId))    <span class="comment">//query出来的东西都会被删除掉</span></span><br><span class="line">            .source(INDEX_NAME);<span class="comment">//设置source，也就是索引名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">&quot;Delete by query for house: &quot;</span> + builder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">BulkByScrollResponse</span> <span class="variable">response</span> <span class="operator">=</span> builder.get();</span><br><span class="line">    <span class="type">long</span> <span class="variable">deleted</span> <span class="operator">=</span> response.getDeleted();</span><br><span class="line">    logger.debug(<span class="string">&quot;Delete total: &quot;</span> + deleted);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试程序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRemove</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">houseId</span> <span class="operator">=</span> <span class="number">15L</span>;</span><br><span class="line">    searchService.remove(houseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试成功，删除。</p>
<blockquote>
<p>index 和remove接口是在特定情况下去执行的</p>
</blockquote>
<p>首先数组刚增加的时候，是不需要建立索引的，因为管理员需要进行审核，数据经过出租、下架都是一个状态的改变，所以在接口的必要路径去改变就可以了。</p>
<p>在HouseServiceImpl的update方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在数据更新的时候，如果检测到其状态是审核通过，那么就需要更新一下索引</span></span><br><span class="line"><span class="keyword">if</span>(house.getStatus() == HouseStatus.PASSES.getValue())&#123;</span><br><span class="line">    searchService.index(house.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外在HouseServiceImpl的updateStatus方法中，在更新状态的时候也要去对索引进行操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上架更新索引，其他情况下都要删除索引</span></span><br><span class="line"><span class="keyword">if</span> (status == HouseStatus.PASSES.getValue())&#123;</span><br><span class="line">    searchService.index(id);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   searchService.remove(id); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>页面测试数据正常，不过对于下架上架这里，有一些0、1、2、3的操作码不太正确，需要进行调整。</strong></p>
<p><strong>另外对于SearchServiceImpl中</strong></p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h66eoos3h0j20ki07vgm8.jpg"
alt="image-20220914202807798" />
<figcaption aria-hidden="true">image-20220914202807798</figcaption>
</figure>
<p>这里的异常情况需要进行调整，如果houseDetail==null，return
false虽然没办法走下面的代码逻辑，但是前端返回值仍然是发布成功的状态。当然，对于索引的操作肯定不会去执行。但是在前端页面中有一些错误的显示，未作调整。</p>
<p>不止测试了下架上架功能，同样的测试了编辑功能，都可以成功的创建索引。</p>
<p>本节我们实现了通过java代码对es索引操作，下一节就要实现异步的创建索引，也就是增加kafka消息队列。</p>
<h2 id="三十五索引构建-消息中间件">三十五、索引构建-消息中间件</h2>
<p>Kafka，一个分布式发布订阅消息系统，同时也是一个强大的消息队列，可以处理大量的数据，可以将一个消息从一个端点传送到另外一个端点。</p>
<p>Kafka适合离线和在线的消息消费，消息是保存在磁盘上的，和其他消息队列比较：很多队列是基于内存的模型来制作的。</p>
<blockquote>
<p>Spark Streaming实时流处理项目实战，可以学习一下</p>
</blockquote>
<p>kafka是基于zookeeper的，zookeeper是一个分布式配置，和同步服务，zookeeper是kafka代理和消费者之间的协调接口，kafka就是通过zookeeper集群来共享信息的。</p>
<p>我们进入zookeeper的文件夹下，然后先启动zookeeper服务，
其默认是自动开放2181端口的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/zookeeper-server-start.sh config/zookeeper.properties </span><br></pre></td></tr></table></figure>
<p>启动后的结果：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h67f2c95dbj20wa0ki7ab.jpg" alt="image-20220915172632829" style="zoom:50%;" /></p>
<p>当然我们可以使用命令在后台运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./bin/zookeeper-server-start.sh config/zookeeper.peoperties &amp;		</span><br></pre></td></tr></table></figure>
<p>然后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nohup.out	</span><br></pre></td></tr></table></figure>
<p>去查看后台运行输出的情况。</p>
<p>然后就是启动kafka，启动一个单实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-server-start.sh config/server.properties</span><br></pre></td></tr></table></figure>
<p>结果图如下：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6juiu9z5sj20u00yx7f6.jpg" alt="image-20220916094227465" style="zoom:50%;" /></p>
<p>我们可以查看server.properties的详情：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h687dgh918j20u00yg7bw.jpg" alt="image-20220916094616488" style="zoom:50%;" /></p>
<p>其中broker.id在整个集群中是唯一值， （broker：经纪人、掮客）</p>
<p>另外还有，如果想让外网访问的话，可以把listeners=PLAINTEXT://localhost:9092打开，然后把localhost换成自己的外网ip即可。</p>
<p>advertised.listeners=PLAINTEXT://localhost:9092中的localhost也替换。</p>
<p>接下来我们创建一个topic：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh  --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic hello</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(base) zhiqiang@zhiQiangdeMacBook-Pro kafka_2.11-1.0.0 % ./bin/kafka-topics.sh  --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic hello</span><br><span class="line">Created topic &quot;hello&quot;.</span><br></pre></td></tr></table></figure>
<p>获取主题列表：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --list --zookeeper localhost:2181</span><br><span class="line">//结果就是</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>
<p>模拟生产消息(9092是kafka的地址)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(base) zhiqiang@zhiQiangdeMacBook-Pro kafka_2.11-1.0.0 % ./bin/kafka-console-producer.sh --broker-list localhost:9092 --topic hello</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">hello zhiqiang</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">hello zhiqiang , two</span></span><br></pre></td></tr></table></figure>
<p>模拟消费者（2181是zookeeper地址，添加参数--from-beginning是从头开始消费消息）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(base) zhiqiang@zhiQiangdeMacBook-Pro kafka_2.11-1.0.0 % ./bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic hello --from-beginning</span><br><span class="line">Using the ConsoleConsumer with old consumer is deprecated and will be removed in a future major release. Consider using the new consumer by passing [bootstrap-server] instead of [zookeeper].</span><br><span class="line">hello zhiqiang</span><br><span class="line">hello zhiqiang , two</span><br></pre></td></tr></table></figure>
<p>然后我们同时启动生产消息和消费消息，界面如下：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h68ex9wh0vj21050as76i.jpg"
alt="image-20220916140729770" />
<figcaption aria-hidden="true">image-20220916140729770</figcaption>
</figure>
<p>我们可以实时的把消息发送到中间件中，然后再实时的消费掉。</p>
<p>我们用的话怎么用呢？</p>
<p>用户在创建数据，我们把数据发送到kafka的队列，通过异步的模型把消息消费掉，再去构建我们的索引。dengzhe</p>
<h2 id="三十六索引构建-代码实践">三十六、索引构建-代码实践</h2>
<blockquote>
<p>代码水平的高低不在于能不能实现功能，而在于对异常情况的处理水平。</p>
</blockquote>
<p>当管理员在处理数据的时候，比如说上架下架的时候，es有一些不稳定，或者说当下时间会很久的话，就很影响用户的一个体验。这时候就需要考虑这个情况，比如说index创建索引的时候需要时间很久，用户不希望等待这么久，这时候就可能需要消息队列来进行。</p>
<h4 id="然后进行kafka的代码实践">然后进行kafka的代码实践：</h4>
<h5
id="首先得有kafka的properties的配置">首先得有kafka的properties的配置：</h5>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#kafka</span></span><br><span class="line"><span class="attr">spring.kafka.bootstrap-servers</span>=<span class="string">localhost:9092</span></span><br><span class="line"><span class="attr">spring.kafka.consumer.group-id</span>=<span class="string">xunwu</span></span><br></pre></td></tr></table></figure>
<p>kafka得有一个group-id，这里我们定义为xunwu</p>
<h5
id="然后去searchserviceimpl中构建kafka相关的代码逻辑">然后去searchServiceImpl中构建kafka相关的代码逻辑：</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义kafka的topic</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INDEX_TOPIC</span> <span class="operator">=</span> <span class="string">&quot;house_ build&quot;</span>;</span><br></pre></td></tr></table></figure>
<h5
id="另外呢还需要去定义一个kafka的template">另外呢，还需要去定义一个kafka的template:</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br></pre></td></tr></table></figure>
<p>编辑一个index_topic的方法类，传入的是一个消息结构体（content）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener(topics = INDEX_TOPIC)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(String content)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>另外呢，因为我们传入的是一个content，也就是请求消息结构体，index和remove的操作都包含在其中，所以我们新建一个HouseIndexMessage类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.service.search;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseIndexMessage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REMOVE</span> <span class="operator">=</span> <span class="string">&quot;remove&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INDEX</span> <span class="operator">=</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_RETRY</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认构造器，防止jackson序列化失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HouseIndexMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long houseId;</span><br><span class="line">    <span class="keyword">private</span> String operation;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">retry</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HouseIndexMessage</span><span class="params">(Long houseId, String operation, <span class="type">int</span> retry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.houseId = houseId;</span><br><span class="line">        <span class="built_in">this</span>.operation = operation;</span><br><span class="line">        <span class="built_in">this</span>.retry = retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getHouseId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> houseId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHouseId</span><span class="params">(Long houseId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.houseId = houseId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOperation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> operation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOperation</span><span class="params">(String operation)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.operation = operation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRetry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRetry</span><span class="params">(<span class="type">int</span> retry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.retry = retry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面主要的字段是设置了houseId、operation、retry，</p>
<p>虽然我们传了houseId，但是实质上我们其实是对message进行的操作。</p>
<p>然后我们去定义了handleMessage方法，使用objectMapper来读取content消息结构体，转换成HouseIndexMessage类，</p>
<p>然后对其operation进行不同的操作：（index或者remove）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener(topics = INDEX_TOPIC)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(String content)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">HouseIndexMessage</span> <span class="variable">message</span> <span class="operator">=</span> objectMapper.readValue(content, HouseIndexMessage.class);</span><br><span class="line">        <span class="keyword">switch</span>(message.getOperation())&#123;</span><br><span class="line">            <span class="keyword">case</span> HouseIndexMessage.INDEX:</span><br><span class="line">                <span class="built_in">this</span>.createOrUpdateIndex(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> HouseIndexMessage.REMOVE:</span><br><span class="line">                <span class="built_in">this</span>.removeIndex(message);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                logger.warn(<span class="string">&quot;Not support message content&quot;</span>+ content);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        logger.error(<span class="string">&quot;Cannot parse json for &quot;</span>+content , e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样呢，我们新建了createOrUpdateIndex和removeIndex方法。</p>
<p>需要把之前的index方法直接嵌套在里面：</p>
<p>然后在这里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createOrUpdateIndex</span><span class="params">(HouseIndexMessage message)</span>&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">houseId</span> <span class="operator">=</span> message.getHouseId();</span><br><span class="line">    <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(houseId);</span><br><span class="line">    <span class="keyword">if</span>(house == <span class="literal">null</span>)&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;index house &#123;&#125; does not exist&quot;</span>,houseId);</span><br><span class="line">        <span class="comment">//这样的话，如果出现失败，那么就需要重新入队列。</span></span><br><span class="line">      	<span class="built_in">this</span>.index(houseId, message.getRetry() + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后在this.index中重新进行消息入列。所以这里的逻辑是我们增加了一个retry的次数，不然的话就是一个死循环了。</p>
<p>我们定义了这样的两个index函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void index(Long houseId) &#123;</span><br><span class="line">    this.index(houseId,0);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">private void index(Long houseId, int retry)&#123;</span><br><span class="line">    if(retry &gt; HouseIndexMessage.MAX_RETRY)&#123;</span><br><span class="line">        logger.error(&quot;Retry index times over 3 for house: &quot; + houseId + &quot;Please check it!&quot;   );</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    HouseIndexMessage message = new HouseIndexMessage(houseId, HouseIndexMessage.INDEX, retry);</span><br><span class="line">    try &#123;</span><br><span class="line">        //kafka重新对topic发送消息体</span><br><span class="line">        kafkaTemplate.send(INDEX_TOPIC, objectMapper.writeValueAsString(message));</span><br><span class="line">    &#125; catch (JsonProcessingException e) &#123;</span><br><span class="line">        logger.error(&quot;Json encode error for &quot; + message);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即，在ISearchService定义的接口index中，我们去访问自己新定义的index（带了retry次数）然后去判断retry次数有没有超过设置的最大次数，如果没有超过那么就去执行kafkaTemplate.send(INDEX_TOPIC,
objectMapper.writeValueAsString(message));</p>
<p>然后执行kafkaTemplate.send后，又发送给了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafkaTemplate.send(INDEX_TOPIC, objectMapper.writeValueAsString(message));</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener(topics = INDEX_TOPIC)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(String content)</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为send的时候是发送了一个参数，发送给了Index_topic，所以在handleMessage函数中我们又设置了@KafkaListener监听。</p>
<p>这样的话我们的createOrUpdate就实现了，接下来去实现remove的逻辑。</p>
<p>remove同样是一样的逻辑：</p>
<p>我们定义了removeIndex：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">removeIndex</span><span class="params">(HouseIndexMessage message)</span>&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">houseId</span> <span class="operator">=</span> message.getHouseId();</span><br><span class="line">    <span class="type">DeleteByQueryRequestBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> DeleteByQueryAction.INSTANCE</span><br><span class="line">            .newRequestBuilder(esclient)</span><br><span class="line">            .filter(QueryBuilders.termQuery(HouseIndexKey.HOUSE_ID, houseId))    <span class="comment">//query出来的东西都会被删除掉</span></span><br><span class="line">            .source(INDEX_NAME);<span class="comment">//设置source，也就是索引名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">&quot;Delete by query for house: &quot;</span> + builder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">BulkByScrollResponse</span> <span class="variable">response</span> <span class="operator">=</span> builder.get();</span><br><span class="line">    <span class="type">long</span> <span class="variable">deleted</span> <span class="operator">=</span> response.getDeleted();</span><br><span class="line">    logger.debug(<span class="string">&quot;Delete total: &quot;</span> + deleted);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( deleted &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">this</span>.remove(houseId, message.getRetry() +<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后去获得了responese.getDeleted，得到了删除的数量，如果删除失败的话，其返回值是负值的，所以进行了this.remove重试的操作。</p>
<p>测试通过，另外需要注意的一点是，在switch的时候，要注意加上break；另外对于kafka的index_topic不能中间有空格，不然会导致错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error while fetching metadata with correlation id 0  INVALID_TOPIC_EXCEPTION</span><br></pre></td></tr></table></figure>
<h2 id="三十七搜索引擎实现">三十七、搜索引擎实现</h2>
<h3 id="搜索功能">搜索功能</h3>
<ul>
<li>​ 搜索业务简单集成ES</li>
<li>​ ES与MySQL结合</li>
</ul>
<p>正常情况下是通过mysql去查出相关信息的，但是在关键词搜索框中，需要通过es去查询出相关的信息，再通过mysql查询出更多详细的信息进行展示。</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6f3kg3ijqj218s090t98.jpg" alt="image-20220918123354761" style="zoom:50%;" /></p>
<p>首先去定义一下我们的接口ISearchService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询房源接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rentSearch</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">ServiceMultiResult&lt;Long&gt; <span class="title function_">query</span><span class="params">(RentSearch rentSearch)</span>;</span><br></pre></td></tr></table></figure>
<p>然后，就定义实现类：</p>
<p>首先构建QueryBuilders.boolQuery，（QueryBuilder
是es中提供的一个查询接口, 可以对其进行参数设置来进行数据查询）</p>
<p>然后对构建好的boolQuery进行filter</p>
<p>对city_en_name和Region_en_name</p>
<p>面积和价格范围区间进行筛选等等</p>
<p>然后使用esclient进行查询，然后返回结果等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;Long&gt; <span class="title function_">query</span><span class="params">(RentSearch rentSearch)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line"></span><br><span class="line">    boolQuery.filter(</span><br><span class="line">            QueryBuilders.termQuery(HouseIndexKey.CITY_EN_NAME,rentSearch.getCityEnName())</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(rentSearch.getRegionEnName() !=<span class="literal">null</span> &amp;&amp; !<span class="string">&quot;*&quot;</span>.equals(rentSearch.getRegionEnName()))&#123;</span><br><span class="line">        boolQuery.filter(</span><br><span class="line">                QueryBuilders.termQuery(HouseIndexKey.REGION_EN_NAME,rentSearch.getRegionEnName())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//面积</span></span><br><span class="line">    <span class="type">RentValueBLock</span> <span class="variable">area</span> <span class="operator">=</span> RentValueBLock.matchArea(rentSearch.getAreaBlock());</span><br><span class="line">    <span class="keyword">if</span>(!RentValueBLock.ALL.equals(area))&#123;</span><br><span class="line">        <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQueryBuilder</span> <span class="operator">=</span> QueryBuilders.rangeQuery(HouseIndexKey.AREA);</span><br><span class="line">        <span class="keyword">if</span>(area.getMax() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            rangeQueryBuilder.lte(area.getMax());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(area.getMin() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            rangeQueryBuilder.gte(area.getMin());</span><br><span class="line">        &#125;</span><br><span class="line">        boolQuery.filter(rangeQueryBuilder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//价格</span></span><br><span class="line">    <span class="type">RentValueBLock</span> <span class="variable">price</span> <span class="operator">=</span> RentValueBLock.matchArea(rentSearch.getPriceBlock());</span><br><span class="line">    <span class="keyword">if</span>(!RentValueBLock.ALL.equals(price))&#123;</span><br><span class="line">        <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQueryBuilder</span> <span class="operator">=</span> QueryBuilders.rangeQuery(HouseIndexKey.PRICE);</span><br><span class="line">        <span class="keyword">if</span>(price.getMax() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            rangeQueryBuilder.lte(price.getMax());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(price.getMin() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            rangeQueryBuilder.gte(price.getMin());</span><br><span class="line">        &#125;</span><br><span class="line">        boolQuery.filter(rangeQueryBuilder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//朝向</span></span><br><span class="line">    <span class="keyword">if</span>(rentSearch.getDirection() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        boolQuery.filter(</span><br><span class="line">                QueryBuilders.termQuery(HouseIndexKey.DIRECTION, rentSearch.getDirection())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*   boolQuery.must(</span></span><br><span class="line"><span class="comment">            QueryBuilders.multiMatchQuery(</span></span><br><span class="line"><span class="comment">                    rentSearch.getKeywords(),</span></span><br><span class="line"><span class="comment">                    HouseIndexKey.TITLE,</span></span><br><span class="line"><span class="comment">                    HouseIndexKey.TRAFFIC,</span></span><br><span class="line"><span class="comment">                    HouseIndexKey.DISTRICT,</span></span><br><span class="line"><span class="comment">                    HouseIndexKey.ROUND_SERVICE,</span></span><br><span class="line"><span class="comment">                    HouseIndexKey.SUBWAY_LINE_NAME,</span></span><br><span class="line"><span class="comment">                    HouseIndexKey.SUBWAY_STATION_NAME</span></span><br><span class="line"><span class="comment">                    )</span></span><br><span class="line"><span class="comment">    );*/</span></span><br><span class="line"></span><br><span class="line">    <span class="type">SearchRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.esclient.prepareSearch(INDEX_NAME)</span><br><span class="line">            .setTypes(INDEX_TYPE)</span><br><span class="line">            .setQuery(boolQuery)</span><br><span class="line">            .addSort(</span><br><span class="line">                    HouseSort.getSortKey(rentSearch.getOrderBy()),</span><br><span class="line">                    SortOrder.fromString(rentSearch.getOrderDirection())</span><br><span class="line">            )</span><br><span class="line">            .setFrom(rentSearch.getStart())</span><br><span class="line">            .setSize(rentSearch.getSize());</span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">&quot;es请求：\n&quot;</span>+ requestBuilder.toString());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    List&lt;Long&gt; houseIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> requestBuilder.get();</span><br><span class="line">    <span class="keyword">if</span>(response.status() != RestStatus.OK)&#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Search status is no ok for&quot;</span> + requestBuilder);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(<span class="number">0</span>,houseIds);</span><br><span class="line">    &#125;</span><br><span class="line">    response.getHits().forEach(hit -&gt;&#123;</span><br><span class="line">        System.out.println(hit.getSource());</span><br><span class="line">        houseIds.add(Longs.tryParse(String.valueOf(hit.getSource().get(HouseIndexKey.HOUSE_ID))));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(response.getHits().totalHits,houseIds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外在我们的controller中rent/house接口下，我们调用的是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServiceMultiResult&lt;HouseDTO&gt; serviceMultiResult = houseService.query(rentSearch);		</span><br></pre></td></tr></table></figure>
<p>这里是查询的mysql数据库，刚才我们定义的并不是houseService的query，而是searchService的query。</p>
<p>所以我们要想办法让其结合起来。</p>
<p>我们在HouseServiceImpl中的query进行添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">query</span><span class="params">(RentSearch rentSearch)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(rentSearch.getKeywords() !=<span class="literal">null</span> &amp;&amp; !rentSearch.getKeywords().isEmpty())&#123;</span><br><span class="line">        ServiceMultiResult&lt;Long&gt; serviceResult =  searchService.query(rentSearch);</span><br><span class="line">        <span class="keyword">if</span>(serviceResult.getTotal() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(serviceResult.getTotal(),</span><br><span class="line">                wrapperHouseResult(serviceResult.getResult()));</span><br><span class="line">        <span class="comment">//如果获得的总数不为零，也就是结果不为空</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后去实现wrapperHouseResult。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;HouseDTO&gt; <span class="title function_">wrapperHouseResult</span><span class="params">(List&lt;Long&gt; houseIds)</span>&#123;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;HouseDTO&gt; houseDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    houseIds.forEach(houseId-&gt;&#123;</span><br><span class="line">        <span class="type">House</span> <span class="variable">house</span> <span class="operator">=</span> houseRepository.findOne(houseId);</span><br><span class="line">        <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> modelMapper.map(house,HouseDTO.class);</span><br><span class="line">        houseDTOS.add(houseDTO);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>起初我是这么去编辑的这里面的逻辑，但是用ArraryList不太合适，使用HashMap更加合适一些。</p>
<p>因为可以做一个id To House的映射，给后面渲染house更多详情做准备。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;HouseDTO&gt; <span class="title function_">wrapperHouseResult</span><span class="params">(List&lt;Long&gt; houseIds)</span>&#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;Long, HouseDTO&gt; idToHouseMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    Iterable&lt;House&gt; houses = houseRepository.findAll(houseIds);</span><br><span class="line">    houses.forEach(house-&gt;&#123;</span><br><span class="line">        <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> modelMapper.map(house,HouseDTO.class);</span><br><span class="line">        houseDTO.setCover(<span class="built_in">this</span>.cdnPrefix+house.getCover());</span><br><span class="line">        idToHouseMap.put(house.getId(),houseDTO);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的话就建立了一个idToHouseMap做了一个id到houseDTO的映射</p>
<p>然后需要把houseDetails加进来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrapperHouseList(houseIds,idToHouseMap);</span><br></pre></td></tr></table></figure>
<p>因为在之前已经写好了这个方法，所以现在也明白了为什么需要建一个id 2
house的变量了，</p>
<p>另外需要矫正顺序，因为es查出来的houseid和mysql查出来的id顺序并不完全一致，所以这里需要进行一个矫正顺序。</p>
<p>所以最后HouseServiceImpl中的query方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceMultiResult&lt;HouseDTO&gt; <span class="title function_">query</span><span class="params">(RentSearch rentSearch)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(rentSearch.getKeywords() !=<span class="literal">null</span> &amp;&amp; !rentSearch.getKeywords().isEmpty())&#123;</span><br><span class="line">            ServiceMultiResult&lt;Long&gt; serviceResult =  searchService.query(rentSearch);</span><br><span class="line">            <span class="keyword">if</span>(serviceResult.getTotal() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(serviceResult.getTotal(),</span><br><span class="line">                    wrapperHouseResult(serviceResult.getResult()));</span><br><span class="line">            <span class="comment">//如果获得的总数不为零，也就是结果不为空</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//定义排序字段类</span></span><br><span class="line"><span class="comment">//        Sort sort = new Sort(Sort.Direction.DESC, &quot;lastUpdateTime&quot;);</span></span><br><span class="line">        <span class="comment">//自定义的排序方法-修改后</span></span><br><span class="line">        <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> HouseSort.generateSort(rentSearch.getOrderBy(), rentSearch.getOrderDirection());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义页面</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> rentSearch.getStart() / rentSearch.getSize();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//* @param page 页面开始的序号</span></span><br><span class="line">        <span class="comment">//  * @param size 页面需要返回的数量</span></span><br><span class="line">        <span class="comment">//  * @param sort sort类</span></span><br><span class="line">        <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageRequest</span>(page, rentSearch.getSize(), sort);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//然后还需要定义特殊条件，比如逻辑删除的数据不被查询出来，根据状态、城市名称等</span></span><br><span class="line">        Specification&lt;House&gt; specification = (root, criteriaQuery, criteriaBuilder) -&gt;&#123;</span><br><span class="line">            <span class="type">Predicate</span> <span class="variable">predicate</span> <span class="operator">=</span> criteriaBuilder.equal(root.get(<span class="string">&quot;status&quot;</span>), HouseStatus.PASSES.getValue());</span><br><span class="line">            criteriaBuilder.and(predicate,criteriaBuilder.equal(root.get(<span class="string">&quot;cityEnName&quot;</span>),rentSearch.getCityEnName()));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> predicate;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; houseIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Long, HouseDTO&gt; idToHouseMap = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里我们使用的JPA的findAll，传递的参数第一个是特殊查询变量，第二个是分页</span></span><br><span class="line">        Page&lt;House&gt; houses = houseRepository.findAll(specification, pageable);</span><br><span class="line">        <span class="comment">//因为返回的是一个list列表的形式，所以我们这里要定义一个HouseDTO类型的列表</span></span><br><span class="line">        ArrayList&lt;HouseDTO&gt; houseDTOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        houses.forEach(house -&gt; &#123;</span><br><span class="line">            <span class="type">HouseDTO</span> <span class="variable">houseDTO</span> <span class="operator">=</span> modelMapper.map(house, HouseDTO.class);</span><br><span class="line">            <span class="comment">//奇怪的是这里为什么要重复的去设置下cover呢。初步猜测原因是cover有时候会更新不出来，所以做一个异步的延时加载</span></span><br><span class="line">            houseDTO.setCover(<span class="built_in">this</span>.cdnPrefix + house.getCover());</span><br><span class="line">            houseDTOS.add(houseDTO);</span><br><span class="line">            houseIds.add(house.getId());</span><br><span class="line">            idToHouseMap.put(house.getId(),houseDTO);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        wrapperHouseList(houseIds,idToHouseMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//最后返回ServiceMultiResult</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span>  <span class="title class_">ServiceMultiResult</span>&lt;&gt;(houses.getTotalElements(), houseDTOS);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>但是上面显得比较复杂，es查询和mysql查询的应该区分开，所以我们把mysql的查询给封装起来。</p>
<blockquote>
<p>另外呢，我们对单独的类打了debug级别的日志，用于输出。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.level.com.zryy.soufangtest.service.search=debug</span><br></pre></td></tr></table></figure>
<p>另外呢，这里我们对于es查询的设置了multiMatchQuery查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">boolQuery.must(</span><br><span class="line">        QueryBuilders.multiMatchQuery(</span><br><span class="line">                rentSearch.getKeywords(),</span><br><span class="line">                HouseIndexKey.TITLE,</span><br><span class="line">                HouseIndexKey.TRAFFIC,</span><br><span class="line">                HouseIndexKey.DISTRICT,</span><br><span class="line">                HouseIndexKey.ROUND_SERVICE,</span><br><span class="line">                HouseIndexKey.SUBWAY_LINE_NAME,</span><br><span class="line">                HouseIndexKey.SUBWAY_STATION_NAME</span><br><span class="line">                )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>rentSearch.getKeywords()是关键词，</p>
<p>HouseIndexKey.TITLE  TRAFFIC  DISTRICT 等等都是需要查询的字段。</p>
<p>另外呢，当我们搜索富力城的时候，像华侨城这样的也会被搜索出来，因为这是中文分词的问题，所以下一节我们需要处理中文分词的问题。</p>
<h2 id="三十八中文分词-问题描述">三十八、中文分词-问题描述</h2>
<p>我们先测一下分词的效果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:9200/_analyze?analyzer=standard&amp;pretty=true&amp;text=Well,zhiqiang is a handsome teacher</span><br><span class="line">Accept: application/json</span><br><span class="line"></span><br><span class="line">&lt;&gt; 2022-09-20T110032.200.json</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Warning<span class="punctuation">:</span> <span class="number">299</span> Elasticsearch<span class="number">-5.6</span><span class="number">.1</span><span class="number">-667</span>b497 <span class="string">&quot;text request parameter is deprecated and will be removed in the next major release. Please use the JSON in the request body instead request param&quot;</span> <span class="string">&quot;Tue, 20 Sep 2022 03:00:31 GMT&quot;</span></span><br><span class="line">Warning<span class="punctuation">:</span> <span class="number">299</span> Elasticsearch<span class="number">-5.6</span><span class="number">.1</span><span class="number">-667</span>b497 <span class="string">&quot;analyzer request parameter is deprecated and will be removed in the next major release. Please use the JSON in the request body instead request param&quot;</span> <span class="string">&quot;Tue, 20 Sep 2022 03:00:31 GMT&quot;</span></span><br><span class="line">content-type<span class="punctuation">:</span> application/json; charset=UTF<span class="number">-8</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;well&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhiqiang&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;is&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;handsome&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">27</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;teacher&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">35</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>当然呢这里是英文，分词效果好很多。我们这里测试一下中文的情况：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;志&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;强&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;是&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;青&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;岛&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;国&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;际&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;创&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;新&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;园&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;最&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;帅&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">11</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;的&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">12</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;男&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">13</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">14</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>所以，我们新建了一个测试的索引用来测试：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT http<span class="punctuation">:</span><span class="comment">//localhost:9200/test</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;house&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>然后增加一些内容进去：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//localhost:9200/test/house</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你从中学到了什么&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>等等</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6d5fc9nqsj20oq05a74w.jpg" alt="image-20220920162642558" style="zoom:67%;" /></p>
<h2 id="三十九中文分词-ik配置">三十九、中文分词-IK配置</h2>
<p>下载elasticSearch-IK放置在es文件夹的plugins目录下：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6f3k6dey0j21f20niabz.jpg" alt="image-20220920163116793" style="zoom: 50%;" /></p>
<p>或者当版本大于5.5.1的时候，可以直接执行命令进行安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analusis-ik/releases/download/v5.6.1/elasticsearch-analysisi-ik-5.6.1.zip</span><br></pre></td></tr></table></figure>
<p>注意，一定要选择对应的版本。</p>
<p>然后需要重新启动es。</p>
<p>这个时候虽然ik分词器被加载进来了，但是还需要我们去重新定义索引，之前我们定义的索引是标准分词器。</p>
<p>这时候我们就需要把之前创建的索引删除掉了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE http://localhost:9200/test</span><br><span class="line">Accept: application/json</span><br></pre></td></tr></table></figure>
<p>然后重新创建索引:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT http:<span class="comment">//localhost:9200/test</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;house&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;dynamic&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">          <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再发送get请求进行测试：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line">GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_analyze?analyzer=ik_max_word&amp;pretty=true&amp;text=志强是青岛国际创新园最帅的男人</span></span><br><span class="line">Accept<span class="punctuation">:</span> application/json</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;志&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;强&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;是&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;青岛&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;岛国&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;国际&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;创新&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;园&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;最&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;帅&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;的&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;男人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">11</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>另外呢，可以在/Users/zhiqiang/Downloads/elasticsearch-5.6.1/config/analysis-ik目录下，找到IKAnalyzer.cfg.xml文件，扩展自己的分词词典。</p>
</blockquote>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6d6eg0bd5j20jd0c1wf9.jpg"
alt="image-20220920170025078" />
<figcaption aria-hidden="true">image-20220920170025078</figcaption>
</figure>
<p>所以我们重新创建了一份建立索引的mapping.json文件：</p>
<p>在需要分词的字段中都加入（<strong>我们的建立索引和搜索索引都要使用分词器</strong>）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br></pre></td></tr></table></figure>
<p>还有就是新建的索引，需要把之前建立的索引删除掉.</p>
<p>我们在test索引中进行了测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST http:<span class="comment">//localhost:9200/test/house/_search</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;中国人&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">159</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6548752</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;house&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AYNaU2YlB6J9J6YWOWJ0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6548752</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;我是中国人&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们在重新删除之前没有分词设置的mapping—index后，重新创建带有分词设置的mapping-index，然后启动程序重新下架上架，重新倒入到es中，经过测试：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//localhost:9200/house/house2/_search</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;精装修&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>结果成功：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">http<span class="punctuation">:</span><span class="comment">//localhost:9200/house/house2/_search</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">content-type<span class="punctuation">:</span> application/json; charset=UTF<span class="number">-8</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">0.68640786</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;house&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;house2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AYNad2YTN7uKa3tweIKJ&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.68640786</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;houseId&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;新康园 正规三居室 精装修 家电家具齐全1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1900</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;area&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span> <span class="number">1504716767000</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastUpdateTime&quot;</span><span class="punctuation">:</span> <span class="number">1663670117000</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;cityEnName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bj&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;regionEnName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdq&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;distanceToSubway&quot;</span><span class="punctuation">:</span> <span class="number">1302</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;subwayLineName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13号线&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;subwayStationName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;霍营&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;龙域西二路&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;district&quot;</span><span class="punctuation">:</span> <span class="string">&quot;融泽嘉园&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房子是正规三室一厅一厨一卫，装修保持的不错，家电家具都齐全。\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;layoutDesc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房子客厅朝北面积比较大，主卧西南朝向，次卧朝北，另一个次卧朝西，两个次卧面积差不多大。&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;traffic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小区出南门到8号线育新地铁站614米，交通便利，小区500米范围内有物美，三旗百汇，龙旗广场等几个比较大的商场，生活购物便利，出小区北门朝东952米是地铁霍营站，是8号线和 13号线的换乘站，同时还有个S2线，通往怀来。（数据来源百度地图）&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;roundService&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小区西边300米就是物美超市和三旗百汇市场（日常百货、粮油米面、瓜果蔬菜、生鲜海货等等，日常生活很便利，消费成本低），北边200米是龙旗购物广场和永辉超市（保利影院，KFC，麦当劳等，轻松满足娱乐消费）。小区里还有商店，饭店，家政等。&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;rentWay&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;独立阳台&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我在搜索的时候，输入“吃饭”也能检索出来，在roundService中”吃“这个字没有，但是”饭“这个字有。所以被检索出来了。</p>
<p>另外呢，在查看kakfa的时候，如果出现了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception thrown when sending a message with key=&#x27;null&#x27; and 		</span><br></pre></td></tr></table></figure>
<p>这样就是kafka挂掉了，然后在检查的时候收获了：</p>
<p>输入了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic house_build --from-beginning	</span><br></pre></td></tr></table></figure>
<p>来监控“house_build" 这个topic内容，发现：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6d97rysorj20g90ab0uj.jpg"
alt="image-20220920183750153" />
<figcaption aria-hidden="true">image-20220920183750153</figcaption>
</figure>
<p>kafka — house_build里面存放的是这样的数值。 也就是传递的message。</p>
<p>不过不理解的是为什么这样的内容传递到了kafka中，虽然在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener(topics = INDEX_TOPIC)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(String content)</span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HouseIndexMessage</span> <span class="variable">message</span> <span class="operator">=</span> objectMapper.readValue(content, HouseIndexMessage.class);</span><br><span class="line">            <span class="keyword">switch</span>(message.getOperation())&#123;</span><br><span class="line">                <span class="keyword">case</span> HouseIndexMessage.INDEX:</span><br><span class="line">                    <span class="built_in">this</span>.createOrUpdateIndex(message);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HouseIndexMessage.REMOVE:</span><br><span class="line">                    <span class="built_in">this</span>.removeIndex(message);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    logger.warn(<span class="string">&quot;Not support message content&quot;</span>+ content);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            logger.error(<span class="string">&quot;Cannot parse json for &quot;</span>+content , e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>中进行了es的处理，但是kafka这里面的值什么时候删除掉呢？</p>
</blockquote>
<h2 id="四十search-as-you-type">四十、Search-as-you-type</h2>
<blockquote>
<p>主要是基于es的suggest来实现的</p>
</blockquote>
<p>我们简单定义了一个controller的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自动补全接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;rent/house/autocomplete&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ApiResponse <span class="title function_">autocomplete</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prefix&quot;)</span> String prefix)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(prefix.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    result.add(<span class="string">&quot;超棒&quot;</span>);</span><br><span class="line">    result.add(<span class="string">&quot;志强&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ApiResponse.ofSuccess(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显示的效果如下：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6f3ju1q8cj21uw0mojsa.jpg" alt="image-20220921091903028" style="zoom: 33%;" /></p>
<p>在ISearchService中新建suggest，然后在impl中去新建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult&lt;List&lt;String&gt;&gt; <span class="title function_">suggest</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然在执行任何操作之前，我们需要对suggest新建一个专门的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zryy.soufangtest.service.search;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseSuggest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String input;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">weight</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">//默认权重</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInput</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInput</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.input = input;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getWeight</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> weight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWeight</span><span class="params">(<span class="type">int</span> weight)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.weight = weight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后也要在HouseIndexTemplate模版中添加这个字段，并且设置set
get方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> HouseSuggest houseSuggest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> HouseSuggest <span class="title function_">getHouseSuggest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> houseSuggest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHouseSuggest</span><span class="params">(HouseSuggest houseSuggest)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.houseSuggest = houseSuggest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，既然我们在houseIndexTempalte中增加了一个新的字段，所以在索引的时候我们的es中也需要去增加一个新的字段，所以我们需要在创建的index索引mapping中重新创建一个新的。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;suggest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;completion&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>也就是在最后增加了这个字段。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;house&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;houseId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analyzed&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;area&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastUpdateTime&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cityEnName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regionEnName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;distanceToSubway&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;subwayLineName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;subwayStationName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;district&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;layoutDesc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;traffic&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;roundService&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;rentWay&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;suggest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;completion&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在获取到关键词之前呢，还需要对suggest进行一些填充操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要在对index进行操作的时候处理，比如create，update的时候</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">updateSuggest</span><span class="params">(HouseIndexTemplate indexTemplate)</span>&#123;</span><br><span class="line">    <span class="type">AnalyzeRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnalyzeRequestBuilder</span>(<span class="built_in">this</span>.esclient,</span><br><span class="line">            AnalyzeAction.INSTANCE,</span><br><span class="line">            indexTemplate.getTitle(),</span><br><span class="line">            indexTemplate.getLayoutDesc(),</span><br><span class="line">            indexTemplate.getRoundService(),</span><br><span class="line">            indexTemplate.getDescription(),</span><br><span class="line">            indexTemplate.getSubwayLineName(),</span><br><span class="line">            indexTemplate.getSubwayStationName());</span><br><span class="line"></span><br><span class="line">    requestBuilder.setAnalyzer(<span class="string">&quot;ik_smart&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">AnalyzeResponse</span> <span class="variable">analyzeResponse</span> <span class="operator">=</span> requestBuilder.get();</span><br><span class="line">    <span class="comment">//结果中是分词后的</span></span><br><span class="line">    List&lt;AnalyzeResponse.AnalyzeToken&gt; tokens = analyzeResponse.getTokens();</span><br><span class="line">    <span class="keyword">if</span>(tokens == <span class="literal">null</span>)&#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Can not analyze token for house: &quot;</span> + indexTemplate.getHouseId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;HouseSuggest&gt; suggests = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(AnalyzeResponse.AnalyzeToken token: tokens)&#123;</span><br><span class="line">        <span class="comment">//排序数字类型 &amp; 小于2个字符的分词结果</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="string">&quot;&lt;NUM&gt;&quot;</span>.equals(token.getType()) || token.getTerm().length() &lt; <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">HouseSuggest</span> <span class="variable">suggest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HouseSuggest</span>();</span><br><span class="line">        <span class="comment">//如果对其权重有一些更新的话，在这里修改一下权重就可以了</span></span><br><span class="line">        suggest.setInput(token.getTerm());</span><br><span class="line">        suggests.add(suggest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里只是对一些需要分词的字段进行，但是对一些不需要分词的比如keyword的字段该怎么做呢？</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定制化小区自动补全</span></span><br><span class="line">    <span class="type">HouseSuggest</span> <span class="variable">suggest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HouseSuggest</span>();</span><br><span class="line">    suggest.setInput(indexTemplate.getDistrict());</span><br><span class="line">    suggests.add(suggest);</span><br><span class="line">    indexTemplate.setSuggests(suggests);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在定义的suggest方法中，首先构建一个suggestBuilders.completionSuggestion</p>
<p>第一个参数传递的是在es索引中我们创建的字段，这里我们定义了“suggest”</p>
<p>所以第一个参数传递的是fieldname类型，然后.prefix .size(5)
设置补全的数量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult&lt;List&lt;String&gt;&gt; <span class="title function_">suggest</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">    <span class="type">CompletionSuggestionBuilder</span> <span class="variable">suggestion</span> <span class="operator">=</span> SuggestBuilders.completionSuggestion(<span class="string">&quot;suggest&quot;</span>)</span><br><span class="line">            .prefix(prefix)</span><br><span class="line">            .size(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>出现了错误，最终在排查问题的时候，找到了这里：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要在对index进行操作的时候处理，比如create，update的时候</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">updateSuggest</span><span class="params">(HouseIndexTemplate indexTemplate)</span>&#123;</span><br><span class="line">    <span class="type">AnalyzeRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnalyzeRequestBuilder</span>(<span class="built_in">this</span>.esclient,</span><br><span class="line">            AnalyzeAction.INSTANCE,</span><br><span class="line">            indexTemplate.getTitle(),</span><br><span class="line">            indexTemplate.getLayoutDesc(),</span><br><span class="line">            indexTemplate.getRoundService(),</span><br><span class="line">            indexTemplate.getDescription(),</span><br><span class="line">            indexTemplate.getSubwayLineName(),</span><br><span class="line">            indexTemplate.getSubwayStationName());</span><br></pre></td></tr></table></figure>
<p>第一个参数是client，第二个参数是AnalyzeAction.INSTANCE，<strong>第三个参数是INDEX_NAME（索引的名称）</strong>
当我没有写INDEX_NAME的时候，会默认的把延后的参数即：indexTemplate.getTitle()当作了index_name</p>
<p>于是出现的结果是虽然在kafka中加入了message，但是es中没有添加任何数据，错误如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rg.springframework.kafka.listener.ListenerExecutionFailedException: Listener method &#x27;private void com.zryy.soufangtest.service.search.SearchServiceImpl.handleMessage(java.lang.String)&#x27; threw exception; nested exception is [大标题-编辑] IndexNotFoundException[no such index]</span><br><span class="line">	at org.springframework.kafka.listener.adapter.MessagingMessageListenerAdapter.invokeHandler(MessagingMessageListenerAdapter.java:188) ~[spring-kafka-1.1.6.RELEASE.jar:na]</span><br><span class="line">	at org.springframework.kafka.listener.adapter.RecordMessagingMessageListenerAdapter.onMessage(RecordMessagingMessageListenerAdapter.java:72) ~[spring-kafka-1.1.6.RELEASE.jar:na]</span><br><span class="line">	at org.springframework.kafka.listener.adapter.RecordMessagingMessageListenerAdapter.onMessage(RecordMessagingMessageListenerAdapter.java:47) ~[spring-kafka-1.1.6.RELEASE.jar:na]</span><br><span class="line">	at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeRecordListener(KafkaMessageListenerContainer.java:794) [spring-kafka-1.1.6.RELEASE.jar:na]</span><br><span class="line">	at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeListener(KafkaMessageListenerContainer.java:738) [spring-kafka-1.1.6.RELEASE.jar:na]</span><br><span class="line">	at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.run(KafkaMessageListenerContainer.java:570) [spring-kafka-1.1.6.RELEASE.jar:na]</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_321]</span><br><span class="line">	at java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:266) [na:1.8.0_321]</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java) [na:1.8.0_321]</span><br><span class="line">	at java.lang.Thread.run(Thread.java:750) [na:1.8.0_321]</span><br><span class="line">Caused by: org.elasticsearch.index.IndexNotFoundException: no such index</span><br></pre></td></tr></table></figure>
<p>当时没有找到问题的原因，可以看到第二行中描述了：handleMessage中抛出的异常。nested
exception is [大标题-编辑] IndexNotFoundException[no such
index]，[大标题-编辑]这个index没有找到，</p>
<p>然后在最下面，es也报出了这样的错误：</p>
<p>Caused by: org.elasticsearch.index.IndexNotFoundException: no such
index</p>
<p>没有这个index</p>
<p>所以修改之后的为下：(添加了index—name)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要在对index进行操作的时候处理，比如create，update的时候</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">updateSuggest</span><span class="params">(HouseIndexTemplate indexTemplate)</span>&#123;</span><br><span class="line">    <span class="type">AnalyzeRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnalyzeRequestBuilder</span>(<span class="built_in">this</span>.esclient,</span><br><span class="line">            AnalyzeAction.INSTANCE,</span><br><span class="line">            INDEX_NAME,</span><br><span class="line">            indexTemplate.getTitle(),</span><br><span class="line">            indexTemplate.getLayoutDesc(),</span><br><span class="line">            indexTemplate.getRoundService(),</span><br><span class="line">            indexTemplate.getDescription(),</span><br><span class="line">            indexTemplate.getSubwayLineName(),</span><br><span class="line">            indexTemplate.getSubwayStationName());</span><br></pre></td></tr></table></figure>
<p>这样的话，结果就正确了，在控制台中显示的如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2022-09-22 14:57:29.500 DEBUG 80951 --- [ntainer#0-0-C-1] c.z.s.service.search.ISearchService      : &#123;</span><br><span class="line">  &quot;query&quot; : &#123;</span><br><span class="line">    &quot;term&quot; : &#123;</span><br><span class="line">      &quot;houseId&quot; : &#123;</span><br><span class="line">        &quot;value&quot; : 29,</span><br><span class="line">        &quot;boost&quot; : 1.0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">2022-09-22 14:57:30.175 DEBUG 80951 --- [ntainer#0-0-C-1] c.z.s.service.search.ISearchService      : Create index with house: 29</span><br><span class="line">2022-09-22 14:57:30.175 DEBUG 80951 --- [ntainer#0-0-C-1] c.z.s.service.search.ISearchService      : Index success with house 29</span><br></pre></td></tr></table></figure>
<p>然后在输入提示中，设置的suggest，默认是simple这个analyzer的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;max_input_length&quot;</span>: <span class="number">50</span>,</span><br><span class="line"><span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;simple&quot;</span>,</span><br><span class="line"><span class="string">&quot;preserve_position_increments&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;type&quot;</span>: <span class="string">&quot;completion&quot;</span>,</span><br><span class="line"><span class="string">&quot;preserve_separators&quot;</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>然后在代码中设置的分析器是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">updateSuggest</span><span class="params">(HouseIndexTemplate indexTemplate)</span> &#123;</span><br><span class="line">    <span class="type">AnalyzeRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnalyzeRequestBuilder</span>(</span><br><span class="line">            <span class="built_in">this</span>.esClient, AnalyzeAction.INSTANCE, INDEX_NAME, indexTemplate.getTitle(),</span><br><span class="line">            indexTemplate.getLayoutDesc(), indexTemplate.getRoundService(),</span><br><span class="line">            indexTemplate.getDescription(), indexTemplate.getSubwayLineName(),</span><br><span class="line">            indexTemplate.getSubwayStationName());</span><br><span class="line"></span><br><span class="line">    requestBuilder.setAnalyzer(<span class="string">&quot;ik_smart&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>所以就导致了报错：找不到这个index</p>
<blockquote>
<p>考虑如何在mapping中设置suggest这个字段的analyzer_type?</p>
</blockquote>
<p>大体的逻辑就是在handleMessage的时候判断是否是create还是update操作，然后在create和update的一开始更新suggest（updateSuggest(houseIndexTemplate)）。也就是给传递的参数indexTemplate更新suggest字段操作</p>
<p>在updateSuggest函数中：</p>
<p>首先定义一个AnalyzeRequestBuilder，实质上就是分词分析器，结果是分好词的。传递的参数是indexTemplate.getTitle、LayoutDesc等等。</p>
<p>requestBuilder.get().getTokens()获取的是List
&lt;AnalyzeResponse.AnalyzeToken&gt;</p>
<p>然后循环遍历把suggests加入到indexTemplate中，然后返回出来，</p>
<p>返回出来后，其实就是在create和updateindex方法中了，然后就是把indexTemplate转成json格式，然后创建或者更新索引。</p>
<p>然后这是创建索引中的suggest字段。</p>
<p>接下来就是suggest接口，请求的suggest返回的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult&lt;List&lt;String&gt;&gt; <span class="title function_">suggest</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">    <span class="type">CompletionSuggestionBuilder</span> <span class="variable">suggestion</span> <span class="operator">=</span> SuggestBuilders.completionSuggestion(<span class="string">&quot;suggest&quot;</span>)</span><br><span class="line">            .prefix(prefix)</span><br><span class="line">            .size(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">SuggestBuilder</span> <span class="variable">suggestBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SuggestBuilder</span>();</span><br><span class="line">    suggestBuilder.addSuggestion(<span class="string">&quot;autocomplete&quot;</span>, suggestion);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.esclient.prepareSearch(INDEX_NAME)</span><br><span class="line">            .setTypes(INDEX_TYPE)</span><br><span class="line">            .suggest(suggestBuilder);</span><br><span class="line"></span><br><span class="line">    logger.debug(requestBuilder.toString());</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> requestBuilder.get();</span><br><span class="line">    <span class="type">Suggest</span> <span class="variable">suggest</span> <span class="operator">=</span> response.getSuggest();</span><br><span class="line">    Suggest.<span class="type">Suggestion</span> <span class="variable">result</span>  <span class="operator">=</span> suggest.getSuggestion(<span class="string">&quot;autocomplete&quot;</span>);</span><br><span class="line">    <span class="comment">//获取的结果可能有重复 需要进行过滤</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">maxSuggest</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    Set&lt;String&gt; suggestSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(Object term : result.getEntries())&#123;</span><br><span class="line">        <span class="keyword">if</span>(term <span class="keyword">instanceof</span> CompletionSuggestion.Entry)&#123;</span><br><span class="line">            CompletionSuggestion.<span class="type">Entry</span> <span class="variable">item</span> <span class="operator">=</span> (CompletionSuggestion.Entry) term;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(item.getOptions().isEmpty())&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (CompletionSuggestion.Entry.Option option : item.getOptions())&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">tip</span> <span class="operator">=</span> option.getText().string();</span><br><span class="line">                <span class="keyword">if</span>(suggestSet.contains(tip))&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                suggestSet.add(tip);</span><br><span class="line">                maxSuggest++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(maxSuggest &gt; <span class="number">5</span> )&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; suggests = Lists.newArrayList(suggestSet.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;));</span><br><span class="line">    <span class="keyword">return</span> ServiceResult.of(suggests);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先新建一个SuggestBuilders，然后实现completionSuggestion()，并且把suggest这个index字段当作参数扔进去。</p>
<p>然后设置prefix 和设置size参数</p>
<p>然后执行esclient去prepareSearch对suggestBuilder进行请求，返回的是SearchRequestBuilder的变量，</p>
<p>然后通过get方法获得SearchResponse，然后</p>
<p>对SearchResponse执行getSuggest（）方法，得到基于prefix的suggest字段，然后suggest.getSuggestion("autocomplete");就得到补全的单词结果了。</p>
<p>然后呢可能获取到的结果有重复，所以我们做一个过滤操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">maxSuggest</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">Set&lt;String&gt; suggestSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(Object term : result.getEntries())&#123;</span><br><span class="line">    <span class="keyword">if</span>(term <span class="keyword">instanceof</span> CompletionSuggestion.Entry)&#123;</span><br><span class="line">        CompletionSuggestion.<span class="type">Entry</span> <span class="variable">item</span> <span class="operator">=</span> (CompletionSuggestion.Entry) term;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(item.getOptions().isEmpty())&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (CompletionSuggestion.Entry.Option option : item.getOptions())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tip</span> <span class="operator">=</span> option.getText().string();</span><br><span class="line">            <span class="keyword">if</span>(suggestSet.contains(tip))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            suggestSet.add(tip);</span><br><span class="line">            maxSuggest++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(maxSuggest &gt; <span class="number">5</span> )&#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; suggests = Lists.newArrayList(suggestSet.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;));</span><br><span class="line"><span class="keyword">return</span> ServiceResult.of(suggests);</span><br></pre></td></tr></table></figure>
<p>然后转换格式，把这个返回出去。</p>
<p>最终的效果图如下：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6gd5hrdwnj21ma0e0q4b.jpg"
alt="image-20220923111040881" />
<figcaption aria-hidden="true">image-20220923111040881</figcaption>
</figure>
<blockquote>
<p>另外呢，我们会把用户常输入的一些关键词、热词等等，最常出现的词单独去<strong>新建一个索引</strong>放进去，这样做的话效果会更好一些。</p>
</blockquote>
<p>他妈的搞了半天，在houseIndexTemplate中把suggest定义成了suggests了，所以导致在补全接口的时候一直找不到相关内容。</p>
<h2 id="四十一小区房源统计功能">四十一、小区房源统计功能</h2>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6gdqduo9ej21jy0pcwgq.jpg"
alt="image-20220923113046846" />
<figcaption aria-hidden="true">image-20220923113046846</figcaption>
</figure>
<p>我们之前在HouseController中的show方法中把houseCountInDistrict固定成了0了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.addAttribute(<span class="string">&quot;houseCountInDistrict&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>需要增加这样一个静态变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AGG_DISTRICT</span> <span class="operator">=</span> <span class="string">&quot;agg_district&quot;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceResult&lt;Long&gt; <span class="title function_">aggregateDistrictHouse</span><span class="params">(String cityEnName, String regionEnName, String district)</span> &#123;</span><br><span class="line">    <span class="comment">//新建boolQueryBuilder</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery()</span><br><span class="line">            .filter(QueryBuilders.termQuery(HouseIndexKey.CITY_EN_NAME,cityEnName))</span><br><span class="line">            .filter(QueryBuilders.termQuery(HouseIndexKey.REGION_EN_NAME,regionEnName))</span><br><span class="line">            .filter(QueryBuilders.termQuery(HouseIndexKey.DISTRICT,district));</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.esclient.prepareSearch(INDEX_NAME)</span><br><span class="line">            .setTypes(INDEX_TYPE)</span><br><span class="line">            .setQuery(boolQueryBuilder)</span><br><span class="line">            .addAggregation(</span><br><span class="line">                    AggregationBuilders.terms(HouseIndexKey.AGG_DISTRICT)</span><br><span class="line">                            .field(HouseIndexKey.DISTRICT)</span><br><span class="line">            ).setSize(<span class="number">0</span>);  <span class="comment">//我们不需要原始的数据，只需要聚合的数据</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    logger.debug(requestBuilder.toString());</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> requestBuilder.get();</span><br><span class="line">    <span class="keyword">if</span>(response.status() == RestStatus.OK)&#123;</span><br><span class="line">        <span class="type">Terms</span> <span class="variable">terms</span> <span class="operator">=</span> response.getAggregations().get(HouseIndexKey.AGG_DISTRICT);</span><br><span class="line">        <span class="keyword">if</span>(terms.getBuckets() !=<span class="literal">null</span> &amp;&amp; !terms.getBuckets().isEmpty())&#123;</span><br><span class="line">            <span class="keyword">return</span> ServiceResult.of(terms.getBucketByKey(district).getDocCount());</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Failed to Aggregate for &quot;</span>+ HouseIndexKey.AGG_DISTRICT);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ServiceResult.of(<span class="number">0L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其结果的json形式是这样的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  <span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;agg_district&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;district&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shard_min_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show_term_doc_count_error&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;_count&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;_term&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>思路就是先进行filter的筛选过滤，然后在进行聚合，然后把response中的
结果拿出来，就是我们定义了agg_district这样一个聚合字段，然后get(HouseIndexKey.AGG_DISTRICT)
拿出来，然后terms.getBucketByKey(district).getDocCount()把这个数量取出来。</p>
<p>最终效果如下：</p>
<p><img src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6gl0i1gqtj21iu0u0778.jpg" alt="image-20220923154242836" style="zoom:80%;" /></p>
<h2 id="四十二搜索引擎优化">四十二、搜索引擎优化</h2>
<p>当我们搜索的时候</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;multi_match&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;融泽嘉园&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;district^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;roundService^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;subwayLineName^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;subwayStationName^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;title^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;traffic^1.0&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;best_fields&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;operator&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;OR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;slop&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;prefix_length&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_expansions&quot;</span> <span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lenient&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;zero_terms_query&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;NONE&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;boost&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;cityEnName&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bj&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;boost&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;disable_coord&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;adjust_pure_negative&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;boost&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;lastUpdateTime&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在query方法中我们使用了boolQuery.must
方法，对Title、traffic、district等字段进行了查询，但是这几个字段的权重都是相同的也就是默认1.0的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改Title查询字段的权重</span></span><br><span class="line">boolQuery.must(</span><br><span class="line">        QueryBuilders.matchQuery(HouseIndexKey.TITLE,rentSearch.getKeywords())</span><br><span class="line">                .boost(<span class="number">2.0f</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>然后把QueryBuilder.multimatchQuery中的title字段删除掉：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">boolQuery.must(</span><br><span class="line">        QueryBuilders.multiMatchQuery(</span><br><span class="line">                rentSearch.getKeywords(),</span><br><span class="line">                HouseIndexKey.TRAFFIC,</span><br><span class="line">                HouseIndexKey.DISTRICT,</span><br><span class="line">                HouseIndexKey.ROUND_SERVICE,</span><br><span class="line">                HouseIndexKey.SUBWAY_LINE_NAME,</span><br><span class="line">                HouseIndexKey.SUBWAY_STATION_NAME</span><br><span class="line">                )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>这样的搜索json就变成了title权重为2.0了：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;融泽嘉园&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;operator&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;OR&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;prefix_length&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;max_expansions&quot;</span> <span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;fuzzy_transpositions&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;lenient&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;zero_terms_query&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;NONE&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;boost&quot;</span> <span class="punctuation">:</span> <span class="number">2.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;multi_match&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;融泽嘉园&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;district^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;roundService^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;subwayLineName^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;subwayStationName^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;title^1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;traffic^1.0&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;best_fields&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;operator&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;OR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;slop&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;prefix_length&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_expansions&quot;</span> <span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lenient&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;zero_terms_query&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;NONE&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;boost&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;cityEnName&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bj&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;boost&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;disable_coord&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;adjust_pure_negative&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;boost&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;lastUpdateTime&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<p>另外呢，很多我们筛选的条件没必要都是must，可以修改成should。只要满足一些搜索的条件就可以：</p>
<p>所以我们把两个matchQuery修改成should的形式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改Title查询字段的权重</span></span><br><span class="line">boolQuery.should(</span><br><span class="line">        QueryBuilders.matchQuery(HouseIndexKey.TITLE,rentSearch.getKeywords())</span><br><span class="line">                .boost(<span class="number">2.0f</span>)</span><br><span class="line">);</span><br><span class="line">boolQuery.should(</span><br><span class="line">        QueryBuilders.multiMatchQuery(</span><br><span class="line">                rentSearch.getKeywords(),</span><br><span class="line">                HouseIndexKey.TRAFFIC,</span><br><span class="line">                HouseIndexKey.DISTRICT,</span><br><span class="line">                HouseIndexKey.ROUND_SERVICE,</span><br><span class="line">                HouseIndexKey.SUBWAY_LINE_NAME,</span><br><span class="line">                HouseIndexKey.SUBWAY_STATION_NAME</span><br><span class="line">                )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>都修改为should后反而什么乱七八糟的都查出来了。建议修改为must</p>
<p>另外一个优化的点是：</p>
<p>我们的es是需要检索出重要的数据字段即可，然后再去mysql中查询，而现在是在es中把所有的数据都查询出来了，如果有海量的大数据，我们该怎么处理？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.esclient.prepareSearch(INDEX_NAME)</span><br><span class="line">        .setTypes(INDEX_TYPE)</span><br><span class="line">        .setQuery(boolQuery)</span><br><span class="line">        .addSort(</span><br><span class="line">                HouseSort.getSortKey(rentSearch.getOrderBy()),</span><br><span class="line">                SortOrder.fromString(rentSearch.getOrderDirection())</span><br><span class="line">        )</span><br><span class="line">        .setFrom(rentSearch.getStart())</span><br><span class="line">        .setSize(rentSearch.getSize())</span><br><span class="line">        .setFetchSource(HouseIndexKey.HOUSE_ID, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
<p>我们在prepareSearch这里设置FetchSource，把House_ID扔进去，只返回house_Id的字段：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>houseId=<span class="number">21</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span>houseId=<span class="number">29</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span>houseId=<span class="number">19</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span>houseId=<span class="number">24</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样的话查询的量级也比较小一些。</p>
<p><strong>setFetchSource</strong></p>
<h2
id="四十三基于百度地图的找房功能">四十三、基于百度地图的找房功能</h2>
<h3 id="业务与需求分析">业务与需求分析：</h3>
<blockquote>
<p>在网站拥有了搜索引擎后，用户就可以非常方便的搜到自己想要的房源信息了，但是有很多时候，用户并不能想清楚自己想要什么，那么这就就迫切的需要一个具体<strong>提示性质</strong>的功能，来方便用户查询信息，所以我们的地图找房功能就很有必要了。我们的目标就是能够在指定区域显示用户想要的房源，方便用户根据地理位置寻找房源信息，提升网站的竞争力。</p>
</blockquote>
<h3 id="实现目标-2">实现目标：</h3>
<ul>
<li>​ 构建房源地理坐标</li>
<li>​ 聚合地图范围内房源</li>
<li>​ 根据地图视野查询房源</li>
<li>​ 地图事件绑定数据源</li>
<li>​ 地图展示房源数据麻点图</li>
</ul>
<h3 id="基于es的功能开发">基于ES的功能开发：</h3>
<ul>
<li>地图房源信息聚合功能</li>
<li>根据视野变化动态更新数据源功能</li>
<li>地图事件更新数据源功能</li>
</ul>
<h3 id="基于地址获取经纬度的开发">基于地址获取经纬度的开发：</h3>
<ul>
<li>获取百度地图经纬度</li>
<li>使用ES存储地理数据信息</li>
</ul>
<p>百度地图浏览器端：NwrFdXX7d9ulyeUvuvrRL1pRwHEHl7qU</p>
<p>百度地图服务端：vVo0GpUwrXGIyq7Xpv6U7Bui5dNGDjaL</p>
<p>对AK值做一个替换：</p>
<figure>
<img
src="https://image.baidu.com/search/down?url=https://tva1.sinaimg.cn/large/e6c9d24ely1h6io025ecpj20wm0qqn0k.jpg"
alt="image-20220925105711798" />
<figcaption aria-hidden="true">image-20220925105711798</figcaption>
</figure>
<p>然后在HouseController中去定义一个map的新接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;rent/house/map&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">rentMapPage</span><span class="params">(<span class="meta">@RequestParam(value = &quot;cityEnName&quot;)</span> String cityEnName,</span></span><br><span class="line"><span class="params">                          Model model,</span></span><br><span class="line"><span class="params">                          HttpSession httpSession,</span></span><br><span class="line"><span class="params">                          RedirectAttributes redirectAttributes)</span>&#123;</span><br><span class="line">    ServiceResult&lt;SupportAddressDTO&gt; city = addressService.queryCity(cityEnName);</span><br><span class="line">    <span class="keyword">if</span>(!city.isSuccess())&#123;</span><br><span class="line">        redirectAttributes.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;must_chose_city&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        httpSession.setAttribute(<span class="string">&quot;cityName&quot;</span>, cityEnName);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;city&quot;</span>,city.getResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ServiceMultiResult&lt;SupportAddressDTO&gt; regions = addressService.findAllRegionsByCityName(cityEnName);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;total&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;regions&quot;</span>, regions.getResult());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;rent-map&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外有时候springmvc的动态cache不跟着配置走，怎么办呢？</p>
<p>在WebMvcConfig中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.thymeleaf.cache&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">thymeleafCacheEnable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>然后在springResourceTemplateResolver中设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模板资源解析器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.thymeleaf&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SpringResourceTemplateResolver <span class="title function_">templateResolver</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SpringResourceTemplateResolver</span> <span class="variable">templateResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringResourceTemplateResolver</span>();</span><br><span class="line">    templateResolver.setApplicationContext(<span class="built_in">this</span>.applicationContext);</span><br><span class="line">    <span class="comment">/*解析的页面乱码 这里调整*/</span></span><br><span class="line">    templateResolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    templateResolver.setCacheable(thymeleafCacheEnable);</span><br><span class="line">    <span class="keyword">return</span> templateResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在前端开发的时候，就不需要重启，也不需要重新加载了。</p>
<p>保持cache是true。</p>
<p>然后再去实现城市的聚合操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聚合城市的出租数量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">ServiceMultiResult&lt;HouseBucketDTO&gt; <span class="title function_">mapAggregate</span><span class="params">(String cityEnName)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceMultiResult&lt;HouseBucketDTO&gt; <span class="title function_">mapAggregate</span><span class="params">(String cityEnName)</span> &#123;</span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    boolQuery.filter(QueryBuilders.termQuery(HouseIndexKey.CITY_EN_NAME,cityEnName));</span><br><span class="line"></span><br><span class="line">    <span class="type">AggregationBuilder</span> <span class="variable">aggBuilder</span> <span class="operator">=</span> AggregationBuilders.terms(HouseIndexKey.AGG_REGION)</span><br><span class="line">            .field(HouseIndexKey.REGION_EN_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchRequestBuilder</span> <span class="variable">requestBuilder</span>  <span class="operator">=</span> <span class="built_in">this</span>.esclient.prepareSearch(INDEX_NAME)</span><br><span class="line">            .setTypes(INDEX_TYPE)</span><br><span class="line">            .setQuery(boolQuery)</span><br><span class="line">            .addAggregation(aggBuilder);</span><br><span class="line"></span><br><span class="line">    logger.debug(requestBuilder.toString());</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span>  <span class="operator">=</span> requestBuilder.get();</span><br><span class="line">    List&lt;HouseBucketDTO&gt; buckets  = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(searchResponse.status() != RestStatus.OK)&#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Aggregate status is not ok for &quot;</span>+ requestBuilder);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(<span class="number">0</span>,buckets);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Terms</span> <span class="variable">terms</span> <span class="operator">=</span> searchResponse.getAggregations().get(HouseIndexKey.AGG_REGION);</span><br><span class="line">    <span class="keyword">for</span>(Terms.Bucket bucket :  terms.getBuckets())&#123;</span><br><span class="line">        buckets.add(<span class="keyword">new</span> <span class="title class_">HouseBucketDTO</span>(bucket.getKeyAsString(),bucket.getDocCount()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMultiResult</span>&lt;&gt;(searchResponse.getHits().getTotalHits(),buckets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样呢service就完善了，然后再去controller中去配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;rent/house/map&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">rentMapPage</span><span class="params">(<span class="meta">@RequestParam(value = &quot;cityEnName&quot;)</span> String cityEnName,</span></span><br><span class="line"><span class="params">                          Model model,</span></span><br><span class="line"><span class="params">                          HttpSession httpSession,</span></span><br><span class="line"><span class="params">                          RedirectAttributes redirectAttributes)</span>&#123;</span><br><span class="line">    ServiceResult&lt;SupportAddressDTO&gt; city = addressService.queryCity(cityEnName);</span><br><span class="line">    <span class="keyword">if</span>(!city.isSuccess())&#123;</span><br><span class="line">        redirectAttributes.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;must_chose_city&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        httpSession.setAttribute(<span class="string">&quot;cityName&quot;</span>, cityEnName);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;city&quot;</span>,city.getResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ServiceMultiResult&lt;SupportAddressDTO&gt; regions = addressService.findAllRegionsByCityName(cityEnName);</span><br><span class="line">    ServiceMultiResult&lt;HouseBucketDTO&gt; mapAggResult = searchService.mapAggregate(cityEnName);</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">&quot;aggData&quot;</span>,mapAggResult.getResult());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;total&quot;</span>, mapAggResult.getTotal());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;regions&quot;</span>, regions.getResult());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;rent-map&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="基于es的地图点聚合">基于ES的地图点聚合</h3>
<blockquote>
<p>剩下的基于时间紧张，并没有详细去学习研究，记录在此。</p>
</blockquote>
<h2 id="七搜索引擎实现">七、搜索引擎实现</h2>
<h3 id="业务与功能分析-3">1、业务与功能分析</h3>
<ul>
<li>​
在我们网站实现了基础信息浏览功能以后，用户就可以看到网站上的所有房源，但是在网站房源信息量爆炸的时候，用户是很难找到自己想要的信息的，这时候，网站就必须要有<strong>站内搜索引擎</strong>功能，帮助用户根据用户自身的需求快速的找到想要的房源信息。</li>
<li>实现目标
<ul>
<li>后台登录</li>
<li>权限控制</li>
<li>注销功能</li>
</ul></li>
</ul>
<h2 id="section"></h2>
<h3 id="实现目标-3">2、实现目标</h3>
<ul>
<li>构建ES房源索引</li>
<li>基于ES构建搜索引擎</li>
<li>解决中文分词问题</li>
<li>search-as-you-type</li>
<li>使搜索引擎结果集最优</li>
</ul>
<h3 id="搜索引擎实现-1">3、搜索引擎实现</h3>
<ul>
<li><p>索引结构设计</p>
<blockquote>
<p>为什么不直接使用es来存数据呢？因为es是弱事务的，并不能使用事务来处理，很容易产生很多脏数据。</p>
</blockquote></li>
</ul>

      </div>
    </div>
    
      <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script>
      <script>
        if (window.mermaid) {
          mermaid.initialize({"startOnload":true});
        }
      </script>
    
  </article>
  <div class="post__foot">
    
      <div class="like-author">
  <input type="checkbox" id="likeCode" />
  <div class="author-face">
    <img height="100px"
         width="100px"
         id="front-face"
         alt="author face"
         src="/images/author-face.jpg" />
    <img height="100px"
         width="100px"
         id="back-face"
         alt="like code"
         src="/images/pay-code.jpg" />
  </div>
  <div class="like-text">“给作者倒杯卡布奇诺”</div>
  <label for="likeCode" class="like-btn">
    <svg viewBox="0 0 1024 1024"
         width="20px"
         style="margin-right: 10px"
         height="20px">
      <path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242" />
    </svg>
    喜欢作者
  </label>
</div>

    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2025/03/09/hello-world/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596" />
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>未命名</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2023/07/23/%E5%87%A0%E7%A7%8D%E5%A4%9A%E6%A8%A1%E6%80%81%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8EFaiss%20%E3%80%81milvus%E3%80%81Proxima%E3%80%81vearch%E3%80%81Jina%E7%AD%89/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596" />
        </svg>
      </div>
      【向量模型】几种多模态向量检索引擎的了解与思考
    </a>
  
</div>

    
    
      <div id="gitalk-container"></div>
    
  </div>

    </div>
    <div class="foot">
  <div class="foot-inner">
    <div class="foot__head">
      
        <div class="foot-line">
          <div class="matts">今</div><div class="matts">夜</div><div class="matts">无</div><div class="matts">眠</div>
        </div>
      
        <div class="foot-line">
          <div class="matts">睡</div><div class="matts">意</div><div class="matts">全</div><div class="matts">无</div>
        </div>
      
    </div>
    <div class="foot__body">
      
        <div class="foot-item">
          <div class="foot-item__head">朋友</div>
          <div class="foot-item__body">
            
            


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://moyanxinxu.github.io/unlock-hf/">unlock-hf</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link+.svg" />
            <a class="foot-link" href="mailto:873101411@qq.com?subject=申请http://example.com的友链">申请友链</a>
          </div>
        
      
        
        
      
        
        
      
    </div>
  


          </div>
        </div>
      
      
        <div class="foot-item">
          <div class="foot-item__head">账号</div>
          <div class="foot-item__body">
            


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/logo-github.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/viserion-nlper">viserion-nlper</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/logo-wx.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Fq9ZIUwZvMNx2kSahz8zEw">HanLP.com</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/logo-zh.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.zhihu.com/people/shuo-hao-jin-ye-bu-dian-yan">点烟侠</a>
          </div>
        
      
        
        
      
    </div>
  


          </div>
        </div>
      
      <div class="foot-item">
        <div class="foot-item__head">联系</div>
        <div class="foot-item__body">
          


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-email.svg" />
            <a class="foot-link" href="mailto:873101411@qq.com">873101411@qq.com</a>
          </div>
        
      
        
        
      
        
        
      
        
        
      
    </div>
  


        </div>
      </div>
    </div>
    <div class="copyright">
      <a href="http://example.com">思想放牧之地</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
      <svg width="20" height="20" viewBox="0 0 725 725">
        <path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
        <path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
        <path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
      </svg>
      <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
    </div>
  </div>
</div>

    
    
      <script src="/js/search.js"></script>
      <script>searchInitialize("/search.json")</script>
    
    <script src="/js/copy-code.js"></script>
    
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
  const param = JSON.parse('{"enable":true,"owner":"Viserion-nlper","admin":null,"repo":"https://github.com/Viserion-nlper/Viserion-nlper.github.io","clientID":"383d8abfdbdb7adac4cc","clientSecret":"753a2f01ea61c8eadec056ab8a209cacb6a0a4e9","distractionFreeMode":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN"}')
  let title = location.pathname.substr(0, 50); 
  param.id = title
  const gitalk = new Gitalk(param)
  gitalk.render('gitalk-container')
</script>

  

  </body>
</html>
